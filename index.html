<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Dashboard v18 (Comb Data)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #121212; color: #e5e5e5; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #121212; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        .bg-card { background-color: #1e1e1e; border: 1px solid #333; border-radius: 12px; display: flex; flex-direction: column; }
        .nav-item { transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: linear-gradient(90deg, rgba(59,130,246,0.1) 0%, transparent 100%); border-left-color: #3b82f6; color: #3b82f6; font-weight: 700; }
        details > summary { list-style: none; outline: none; cursor: pointer; transition: 0.2s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary .arrow { transform: rotate(180deg); }
        .arrow { transition: transform 0.2s; }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm">

    <aside class="w-64 bg-[#181818] flex-shrink-0 flex flex-col border-r border-[#2a2a2a] z-20">
        <div class="h-16 flex items-center px-6 border-b border-[#2a2a2a]">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-900/50">
                <i class="ph-bold ph-chart-polar"></i>
            </div>
            <div class="ml-3">
                <div class="text-base font-bold text-white leading-none">Financial DB</div>
                <div class="text-[10px] text-gray-500 font-mono mt-1">v18 Comb View</div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-2">
            <div class="px-3 mb-1 text-[10px] font-bold text-gray-500 uppercase tracking-wider">Dashboards</div>
            
            <div onclick="switchContext('ALL', 'Overview', 'Overview')" id="nav-all" class="nav-item active flex items-center gap-3 px-3 py-2 rounded text-gray-400">
                <i class="ph-bold ph-squares-four text-lg"></i><span>Overview (All)</span>
            </div>

            <div onclick="switchContext('TRIPLOG', 'TripLog', 'TripLog')" id="nav-triplog" class="nav-item flex items-center gap-3 px-3 py-2 rounded text-gray-400">
                <i class="ph-bold ph-road-horizon text-lg"></i><span>TripLog (Comb)</span>
            </div>

            <div class="px-3 mt-4 mb-1 text-[10px] font-bold text-gray-500 uppercase tracking-wider">Financial Areas</div>
            <div id="accordion-container" class="space-y-1 mt-1">
                <div class="text-xs text-gray-600 italic px-3 pt-2 text-center">Import Excel files...</div>
            </div>
        </div>

        <div class="p-4 border-t border-[#2a2a2a] bg-[#151515] text-[10px] text-gray-600">
            <div class="flex justify-between"><span>Status:</span><span id="status-indicator" class="text-red-500 font-bold">No Data</span></div>
            <div class="flex justify-between mt-1"><span>Areas:</span><span id="sheet-count" class="text-gray-300">0</span></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative h-full overflow-hidden bg-[#121212]">
        
        <header class="h-16 px-6 flex items-center justify-between border-b border-[#2a2a2a] bg-[#181818]/95 backdrop-blur z-10">
            <div>
                <div class="flex items-center gap-2 text-gray-500 text-xs mb-0.5">
                    <span id="bc-company" class="uppercase tracking-wider font-bold text-gray-400">DASHBOARD</span>
                    <i class="ph-bold ph-caret-right"></i>
                    <span id="bc-location" class="text-blue-400 font-mono">Overview</span>
                </div>
                <h1 class="text-xl font-bold text-white tracking-tight" id="page-title">All Areas</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="relative group">
                    <i class="ph-bold ph-calendar-blank absolute left-3 top-2.5 text-gray-400"></i>
                    <input type="text" id="dateRange" placeholder="Select Date Range" class="bg-[#252525] hover:bg-[#333] border border-[#333] text-white text-xs rounded-lg pl-9 pr-3 py-2 w-56 focus:outline-none focus:border-blue-600 transition-colors cursor-pointer font-mono">
                    <button onclick="clearDate()" id="clear-date-btn" class="hidden absolute right-2 top-2 text-gray-500 hover:text-white"><i class="ph-bold ph-x"></i></button>
                </div>
                <div class="h-6 w-[1px] bg-[#333]"></div>
                
                <label class="cursor-pointer bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-xs font-bold transition-all flex items-center gap-2">
                    <i class="ph-bold ph-folder-open text-lg"></i>
                    <span>Import File</span>
                    <input type="file" id="fileInput" hidden accept=".xlsx, .xls, .csv" multiple>
                </label>

                <button onclick="initDropbox()" id="sync-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-bold transition-all shadow-lg shadow-blue-900/20 flex items-center gap-2">
                    <i class="ph-bold ph-arrows-clockwise text-lg"></i>
                    <span>Sync Dropbox</span>
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-6 custom-scroll" id="main-scroll">
            
            <div id="ui-empty" class="flex flex-col items-center justify-center h-[60vh] text-center fade-in">
                <div class="w-24 h-24 bg-[#1e1e1e] rounded-full flex items-center justify-center border border-[#333] mb-6 shadow-2xl">
                    <i class="ph-duotone ph-microsoft-excel-logo text-4xl text-green-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">Import Data</h2>
                <p class="text-gray-500 max-w-md text-sm mb-8">
                    Upload your <strong>Financial</strong> and <strong>Comb/TripLog</strong> Excel files.<br>
                    Or click "Sync Dropbox" to pull from the cloud.
                </p>
                <div class="flex gap-4">
                    <button onclick="document.getElementById('fileInput').click()" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg text-sm font-bold">Browse Files</button>
                    <button onclick="initDropbox()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg">Sync Dropbox</button>
                </div>
            </div>

            <div id="ui-dashboard" class="hidden space-y-6 fade-in">
                <div class="bg-card p-6 h-[400px] w-full">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-white font-bold text-lg">Weekly Performance</h3>
                            <p class="text-xs text-blue-400 font-mono mt-1" id="chart-subtitle">All Time</p>
                        </div>
                        <div class="flex gap-4 text-xs font-bold text-gray-500 bg-[#151515] p-2 rounded-lg border border-[#2a2a2a]">
                            <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-blue-500 mr-2"></span>Rev</span>
                            <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-red-500 mr-2"></span>Exp</span>
                            <span class="flex items-center"><span class="w-2 h-2 rounded-full bg-green-500 mr-2"></span>Margin</span>
                        </div>
                    </div>
                    <div class="flex-grow w-full relative"><canvas id="chartTrend"></canvas></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-card p-6 h-[320px]">
                        <h3 class="text-white font-bold mb-4 text-sm uppercase tracking-wider">Cost Breakdown</h3>
                        <div class="flex-grow relative flex justify-center h-2/3"><canvas id="chartCostRadial"></canvas></div>
                    </div>
                    <div class="bg-card p-6 h-[320px]">
                        <h3 class="text-white font-bold mb-4 text-sm uppercase tracking-wider">Cost Trend</h3>
                        <div class="flex-grow relative"><canvas id="chartCostStack"></canvas></div>
                    </div>
                    <div class="bg-card p-6 h-[320px]">
                        <h3 class="text-white font-bold mb-4 text-sm uppercase tracking-wider">Top Driver Margin</h3>
                        <div class="flex-grow relative"><canvas id="chartDriverMargin"></canvas></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[500px]">
                    <div class="bg-card flex flex-col overflow-hidden h-full">
                        <div class="p-4 border-b border-[#2e2e2e] bg-[#1a1a1a] flex justify-between items-center">
                            <h3 class="text-xs font-bold text-gray-300 uppercase tracking-wider">Driver Leaderboard</h3>
                        </div>
                        <div class="overflow-x-auto custom-scroll flex-1">
                            <table class="w-full text-left text-gray-400 whitespace-nowrap"><thead class="text-[10px] font-bold uppercase bg-[#151515] text-gray-500 sticky top-0"><tr><th class="p-3">Name</th><th class="p-3 text-right">Payroll</th><th class="p-3 text-right">Rev</th><th class="p-3 text-right">Margin</th><th class="p-3 text-right">%</th></tr></thead><tbody id="driver-table-body" class="text-xs divide-y divide-[#2a2a2a] font-mono"></tbody></table>
                        </div>
                    </div>
                    <div class="bg-card flex flex-col overflow-hidden h-full">
                        <div class="p-4 border-b border-[#2e2e2e] bg-[#1a1a1a] flex justify-between items-center">
                            <h3 class="text-xs font-bold text-gray-300 uppercase tracking-wider">Weekly Financials</h3>
                            <span id="record-count" class="text-xs text-gray-500 font-mono bg-[#252525] px-2 py-1 rounded">0</span>
                        </div>
                        <div class="overflow-x-auto custom-scroll flex-1">
                            <table class="w-full text-left text-gray-400 whitespace-nowrap"><thead class="text-[10px] font-bold uppercase bg-[#151515] text-gray-500 sticky top-0 z-10 shadow-sm"><tr><th class="p-3 border-b border-[#333]">Date</th><th class="p-3 border-b border-[#333] text-right text-red-400">Total Exp</th><th class="p-3 border-b border-[#333] text-right text-blue-400">Revenue</th><th class="p-3 border-b border-[#333] text-right text-green-400">Margin</th><th class="p-3 border-b border-[#333] text-right">%</th></tr></thead><tbody id="table-body" class="text-xs divide-y divide-[#2a2a2a] font-mono"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ui-triplog" class="hidden space-y-6 fade-in">
                <div class="bg-card flex flex-col overflow-hidden shadow-xl min-h-[600px]">
                    <div class="p-4 border-b border-[#2e2e2e] bg-[#1a1a1a] flex flex-wrap gap-4 justify-between items-center">
                        <div class="flex items-center gap-3">
                            <h3 class="text-white font-bold text-lg">Trip Log</h3>
                            <span id="triplog-count" class="text-xs text-gray-500 font-mono bg-[#252525] px-2 py-1 rounded">0 Entries</span>
                        </div>
                        
                        <div class="flex items-center gap-3">
                            <div class="relative">
                                <i class="ph-bold ph-magnifying-glass absolute left-3 top-2.5 text-gray-500"></i>
                                <input type="text" id="triplog-search" onkeyup="updateTripLogTable()" placeholder="Filter Account / Name..." 
                                       class="bg-[#252525] border border-[#333] text-white text-xs rounded-lg pl-9 pr-3 py-2 w-64 focus:border-blue-600 focus:outline-none">
                            </div>
                            
                            <div class="flex bg-[#252525] rounded-lg p-1 border border-[#333]">
                                <button onclick="sortTripLog('date')" class="px-3 py-1 text-xs text-gray-400 hover:text-white font-bold border-r border-[#333]">Date</button>
                                <button onclick="sortTripLog('name')" class="px-3 py-1 text-xs text-gray-400 hover:text-white font-bold border-r border-[#333]">Name</button>
                                <button onclick="sortTripLog('acct')" class="px-3 py-1 text-xs text-gray-400 hover:text-white font-bold">Acct</button>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto custom-scroll flex-1">
                        <table class="w-full text-left text-gray-400 whitespace-nowrap">
                            <thead class="text-[10px] font-bold uppercase bg-[#151515] text-gray-500 sticky top-0 z-10 shadow-sm">
                                <tr>
                                    <th class="p-3 border-b border-[#333]">Driver Name</th>
                                    <th class="p-3 border-b border-[#333]">Date</th>
                                    <th class="p-3 border-b border-[#333]">Account #</th>
                                    <th class="p-3 border-b border-[#333]">Booking ID</th>
                                    <th class="p-3 border-b border-[#333]">Passenger</th>
                                    <th class="p-3 border-b border-[#333]">Pick Up</th>
                                    <th class="p-3 border-b border-[#333]">Drop Off</th>
                                    <th class="p-3 border-b border-[#333]">Miles</th>
                                    <th class="p-3 border-b border-[#333]">Fare</th>
                                    <th class="p-3 border-b border-[#333] w-full">Notes</th>
                                </tr>
                            </thead>
                            <tbody id="triplog-body" class="text-xs divide-y divide-[#2a2a2a] font-mono">
                                <tr><td colspan="10" class="p-8 text-center text-gray-600">No TripLog data loaded. Import the Comb Excel file.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- 1. CONFIGURATION ---
        const DBX_TOKEN = 'sl.u.AGLgqME4NIddINhpqBZt41IaKvCqd-HLF6DEhrg_YLJOONUU6ebKeMSPLjphBej9EoeZJxOn3YZwD9tJSZagUuSsHgQveBsNLAN6cyhDhkv6vq3-ilLE5hxl3JsJuzbpdn6OVxJmpakc2JEEhVMZelzAKxSQMg-L1vHc4CYlGRBskMTIk03PsuiqW3Em-Cs-42fQJE25nNkYok8cMTRTASjOOvPeBwDvsZwuyn55VNoPmD863vfh8OZgsHwdY1EeQwJ_fn3aos5rLUaw_YLtGevc4jMU9CaxpRRDEIQ447ALwUKbwFVw1v9xff3b1IPvDye0SvZALE-PuDCV3d5BPQGl5n2PcRbh2I4Mwj_exTxgEnVPEdAL6PyfGlRXoF6BaYxEeCNOuCp4qQNYmt5CloEhRtzQ3D8c63gUW16C5nWgjBfnJv0RWkNaQKH-Usc0bULHrwT4uu55IgeY8AI66JURkT1whPc43j8zCHOiLAWquTHj954CizWAsATFtf7AgMUFhcg59J-pBkODM4xfZU90PGULs4JOFSC9PGLmU6C9y8W-hgjGeqsqFRZPXI4J8ss1JVMzR_AOjmY0TO3bQn0-Cr5G_DWYKeN2ZpKvne0pGaqMbArMTvNqvE8f0DnjpDcTjJbpNhSIXj4oRQQZ0QAb6t4736PNvz5aiEXizaiDuJfFaESXwNPFUpeTqfqghLYwRHduuGcg4uwumh2NYIWjkXyZfzgd5Pg3ZddkCUPRqSK46Mo2nDuAaj2HxHwHWGZxLgLwlyAMUsrU7SymUuHe9YgavSVZOoGUlqTxxs425-YUE-aCdbHdOi6QdRBH53lqkBrsEa1Lkbft4l0FpNsQzc_qtrQsY-G0P2L2cqYwRDZGSzMdJCjJZnJinwJASFeFXCr9W6ZCIJYrBKy7MhcN6UzH3G7LN63LZLrFghEVIX3pkDW0kYpWqoYCw9ucS_qWuknLEmrNUepC7b4VOPq0ravSy5jqbeD7a7cPmgBv5otxV5jM7q6blcbJaoXNUPD8g_kIrG87RyvxN7uHsa0t7lqYEd-hJ_KA_lXaRZccUbUTLt6B24rNHh4lvyxM189oNAMV6_acE0NzfPxEx-kik4-D3FFJ1WxdJ8HppSIcSEYA-c99_PUo-YoBdTjZWvUkfeae4AmgxFALFtGAk7WzCid_BOIe1_cp1HEFBrnkUpIWWFz3qbmQYTmpaaz-SfpxKDhKLgTIJ3qXDdyZrCon9w2XAGU_LwQRt_7ZrjRwfPMiHSvdQ2smNu9NUVZym_A2lcc3cVQ-3US2AWs9xSTALaS0HNTS6h4XFUrfGMFvc2vqlghH1zBeWmt-qg70UiZH14ytyOE3P-aaekV2MAhp1zhMfKfs0168KaBkZ1qQ5KIi9eS4nBHWv4plHSqmLoqhnwPPcklaie0pQrCUmkEB0JT9u1ZCIsbdma2UYXcbUxpGSk2VWLWbA2cRZMCNsf8'; 
        
        const DROPBOX_CONFIG = [
            { company: 'Deluxe', link: 'https://www.dropbox.com/scl/fi/estjsmhffbxy0y4b3n2se/DLX-Margin.Labor-Spreadsheet-2.27.25.xlsx?rlkey=ecggt0myxuyqylnmtajx3j8id&st=fz7a6y7c&dl=0', type: 'finance' },
            { company: 'DMT',    link: 'https://www.dropbox.com/scl/fi/4ua44lgj7vqm0nrb15qfz/DMT-Test-File.xlsx?rlkey=ccnfs1etglvkesn16gjhlh60v&st=hgtjmhiv&dl=0', type: 'finance' },
            { company: 'TripLog', link: 'https://www.dropbox.com/scl/fi/3x76us3schnyezkcfrefs/Margin-Reports-11.1.25-11.30.25-Repaired-Comb.csv?rlkey=0cp03zv5ib5nhb6ku7rzz5zf6&st=7psysp6j&dl=0', type: 'triplog' } // NEW
        ];

        // --- DASHBOARD SETTINGS ---
        const FMT = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
        Chart.defaults.font.family = "'Nunito', sans-serif"; Chart.defaults.color = '#888'; Chart.defaults.borderColor = '#2a2a2a'; Chart.register(ChartDataLabels);

        // Friendly Names Map
        const SHEET_MAP = {
            'ABNY.WKLY': 'Albany', 'CST.WKLY': 'Coast', 'CONSOLIDATEDWKLY': 'Company Overview', 'CONSOLIDATED.WKLY': 'Company Overview',
            'DMTWKLY': 'DMT', 'EUGWKLY': 'DLX-EUG', 'EUG.WKLY': 'Eugene Weekly', 'MDVCR.WKLY': 'Modivcare',
            'OKRDG.WKLY': 'Oakridge', 'OT': 'Oregon Taxi', 'RBG.WKLY': 'Roseburg', 'ALBANY.SALEM': 'Albany/Salem',
            'E.OREGON': 'Eastern Oregon', 'NEVADA': 'Nevada'
        };

        let STATE = { 
            data: {}, tripLog: [], 
            ctxType: 'ALL', ctxComp: 'Overview', ctxLoc: 'Overview', 
            dateRange: null, tripSort: 'date' 
        };

        // --- INIT ---
        const fp = flatpickr("#dateRange", { 
            mode: "range", dateFormat: "Y-m-d", theme: "dark", maxDate: "today", 
            onChange: (d) => { STATE.dateRange = d.length === 2 ? d : null; document.getElementById('clear-date-btn').classList.toggle('hidden', !STATE.dateRange); updateDashboard(); } 
        });
        function clearDate() { fp.clear(); STATE.dateRange = null; document.getElementById('clear-date-btn').classList.add('hidden'); updateDashboard(); }

        // --- DROPBOX LOADER ---
        async function initDropbox() {
            const statusDiv = document.getElementById('status-indicator');
            const syncBtn = document.getElementById('sync-btn');
            statusDiv.innerText = "Syncing..."; statusDiv.className = "text-yellow-500 font-bold";
            if(syncBtn) { syncBtn.disabled = true; syncBtn.classList.add('opacity-50'); }

            let mappedCount = 0;

            try {
                for (const config of DROPBOX_CONFIG) {
                    console.log(`Fetching ${config.company}...`);
                    const response = await fetch('https://content.dropboxapi.com/2/sharing/get_shared_link_file', {
                        method: 'POST', headers: { 'Authorization': `Bearer ${DBX_TOKEN}`, 'Dropbox-API-Arg': JSON.stringify({ url: config.link }) }
                    });
                    if (!response.ok) { console.error(`Error loading ${config.company}`); continue; }

                    const blob = await response.blob();
                    const data = await blob.arrayBuffer();
                    
                    if (config.type === 'triplog') {
                        // TripLog (Comb) File
                        const workbook = XLSX.read(data, { type: 'array' });
                        // Scan for "Comb" sheet or just use first sheet
                        let sheet = workbook.Sheets['Comb'] || workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                        processTripLog(rows);
                    } else {
                        // Finance Excel
                        const workbook = XLSX.read(data, { type: 'array' });
                        workbook.SheetNames.forEach(sheetName => {
                            const targetName = SHEET_MAP[sheetName.trim().toUpperCase()];
                            if (targetName) {
                                const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                                if (rows.length > 5) { processSheetData(rows, config.company, targetName); mappedCount++; }
                            }
                        });
                    }
                }
                finishLoad(mappedCount);
            } catch (err) { console.error(err); alert("Sync Failed."); }
            finally { if(syncBtn) { syncBtn.disabled = false; syncBtn.classList.remove('opacity-50'); } }
        }

        // --- MANUAL UPLOAD ---
        document.getElementById('fileInput').addEventListener('change', async (e) => {
            const files = e.target.files; if (!files.length) return;
            let mappedCount = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Detection: TripLog vs Finance
                // TripLog "Comb" files usually have "booking_site_reference" or "driver_name" in header
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const firstRows = XLSX.utils.sheet_to_json(firstSheet, { header: 1, range: 0 });
                const headerStr = JSON.stringify(firstRows[0] || []).toLowerCase();
                
                if (headerStr.includes("driver_name") || headerStr.includes("arrival time") || file.name.includes("Comb")) {
                    // TripLog
                    const rows = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    processTripLog(rows);
                } else {
                    // Finance
                    let company = "Unknown";
                    const fn = file.name.toUpperCase();
                    if (fn.includes("DLX") || fn.includes("DELUXE")) company = "Deluxe";
                    else if (fn.includes("DMT")) company = "DMT";
                    else if (fn.includes("OT")) company = "Oregon Taxi";

                    workbook.SheetNames.forEach(sheetName => {
                        const targetName = SHEET_MAP[sheetName.trim().toUpperCase()];
                        if (targetName) {
                            const rows = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], { header: 1 });
                            if (rows.length > 5) { processSheetData(rows, company, targetName); mappedCount++; }
                        }
                    });
                }
            }
            finishLoad(mappedCount);
            e.target.value = '';
        });

        function finishLoad(count) {
            buildNavigation();
            document.getElementById('status-indicator').innerText = "Ready";
            document.getElementById('status-indicator').className = "text-green-500 font-bold";
            document.getElementById('sheet-count').innerText = count;
            document.getElementById('ui-empty').classList.add('hidden');
            if(STATE.ctxType !== 'TRIPLOG') switchContext('ALL', 'Overview', 'Overview');
            else updateTripLogView();
        }

        // --- DATA PROCESSING ---
        function cleanMoney(val) {
            if (!val) return 0;
            let s = val.toString(); let isNeg = s.includes('(') || s.includes('-');
            let n = parseFloat(s.replace(/[^0-9.]/g, '')); return isNaN(n) ? 0 : (isNeg ? -n : n);
        }

        function processSheetData(rows, company, location) {
            const key = `${company}_${location}`;
            const weeks = [], drivers = [];
            const isSummary = location === "Company Overview";
            const today = moment();

            let colMap = { name:0, drPay:5, drRev:11, drMar:12, drPct:13, date:15, pay:19, fuel:20, ins:21, maint:22, exp:24, rev:25, mar:26, pct:27 };
            
            for(let r=0; r<Math.min(rows.length, 10); r++) {
                const row = rows[r] || [];
                for(let c=10; c<30; c++) {
                    if (row[c] && String(row[c]).toLowerCase().includes('start date')) {
                        const base = c; 
                        colMap = { ...colMap, date:base, pay:base+4, fuel:base+5, ins:base+6, maint:base+7, exp:base+9, rev:base+10, mar:base+11, pct:base+12 };
                        break;
                    }
                }
            }

            for(let i=2; i<rows.length; i++) {
                const r = rows[i]; if (!r) continue;
                if(r[colMap.name] && String(r[colMap.name]).length > 2 && r[colMap.drPct]) {
                    drivers.push({ name: r[colMap.name], payroll: cleanMoney(r[colMap.drPay]), rev: cleanMoney(r[colMap.drRev]), margin: cleanMoney(r[colMap.drMar]), pct: r[colMap.drPct] });
                }
                const dVal = r[colMap.date];
                if (dVal) {
                    let mDate = (typeof dVal === 'number') ? moment(new Date(Math.round((dVal - 25569)*86400*1000))) : moment(dVal, ['M/D/YYYY', 'YYYY-MM-DD']);
                    if (mDate.isValid() && mDate.year() > 2000 && mDate.isBefore(today)) {
                        weeks.push({
                            date: mDate.format('YYYY-MM-DD'), displayDate: mDate.format('MMM D, YYYY'), 
                            company, location, isSummary,
                            payroll: cleanMoney(r[colMap.pay]), fuel: cleanMoney(r[colMap.fuel]), totalExp: cleanMoney(r[colMap.exp]), revenue: cleanMoney(r[colMap.rev]), margin: cleanMoney(r[colMap.mar]), marginPct: r[colMap.pct]
                        });
                    }
                }
            }
            if (weeks.length > 0) STATE.data[key] = { weeks, drivers };
        }

        function processTripLog(rows) {
            STATE.tripLog = [];
            // Columns in Comb CSV:
            // 0: booking_site..
            // 5: driver_name
            // 6: CustID
            // 7: booking_id
            // 8: passenger_name
            // 10: Arrival Time
            // 12: pickup_address
            // 17: destination_address
            // 22: instructions (Notes)
            // 23: Miles
            // 28: meter (Fare) or 34: Rev.
            
            // Header is row 0. Data starts row 1.
            for(let i=1; i<rows.length; i++) {
                const r = rows[i];
                if(!r || !r[5]) continue; // Need driver name

                let dateStr = r[10];
                let mDate;
                if(dateStr) {
                     if (typeof dateStr === 'number') mDate = moment(new Date(Math.round((dateStr - 25569)*86400*1000)));
                     else mDate = moment(dateStr); // Auto parse ISO or other
                }

                STATE.tripLog.push({
                    name: r[5],
                    acct: r[6] || '-',
                    bookId: r[7] || '-',
                    pax: r[8] || '-',
                    date: mDate && mDate.isValid() ? mDate.format('YYYY-MM-DD') : '',
                    displayDate: mDate && mDate.isValid() ? mDate.format('MMM D, YYYY HH:mm') : dateStr,
                    pickup: r[12] || '',
                    dropoff: r[17] || '',
                    notes: r[22] || '',
                    miles: r[23] || 0,
                    fare: r[28] || r[34] || 0
                });
            }
            updateTripLogView();
        }

        // --- NAVIGATION ---
        function buildNavigation() {
            const container = document.getElementById('accordion-container'); container.innerHTML = '';
            const hierarchy = {};
            Object.keys(STATE.data).forEach(key => {
                const [comp, loc] = key.split('_');
                if (!hierarchy[comp]) hierarchy[comp] = [];
                if (!hierarchy[comp].includes(loc)) hierarchy[comp].push(loc);
            });

            Object.keys(hierarchy).forEach(comp => {
                const locs = hierarchy[comp].sort();
                const details = document.createElement('details'); details.open = true;
                details.className = 'group rounded-lg bg-[#252525] overflow-hidden border border-[#333] mb-2';
                details.innerHTML = `
                    <summary onclick="switchContext('COMPANY', '${comp}', 'Overview')" class="nav-item flex items-center justify-between px-3 py-2 bg-[#222] text-xs text-gray-400 select-none border-b border-[#333]">
                        <div class="flex items-center gap-2"><i class="ph-bold ph-buildings"></i><span class="font-bold">${comp}</span></div><i class="ph-bold ph-caret-down arrow"></i>
                    </summary>
                    <div class="p-1 space-y-0.5 bg-[#1e1e1e]">
                        ${locs.map(loc => `<div id="nav-${comp.replace(/\s/g,'')}-${loc.replace(/\s/g,'')}" onclick="switchContext('LOCATION', '${comp}', '${loc}')" class="nav-item flex items-center gap-2 px-3 py-1.5 rounded text-xs text-gray-500 hover:text-white pl-8"><i class="ph-fill ph-map-pin"></i><span>${loc}</span></div>`).join('')}
                    </div>`;
                container.appendChild(details);
            });
        }

        function switchContext(type, comp, loc) {
            STATE.ctxType = type; STATE.ctxComp = comp; STATE.ctxLoc = loc;
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            if(type === 'TRIPLOG') {
                document.getElementById('nav-triplog').classList.add('active');
                document.getElementById('ui-dashboard').classList.add('hidden');
                document.getElementById('ui-triplog').classList.remove('hidden');
                document.getElementById('page-title').innerText = "Trip Logs";
                updateTripLogView();
                return;
            }

            document.getElementById('ui-triplog').classList.add('hidden');
            document.getElementById('ui-dashboard').classList.remove('hidden');
            
            if(type === 'ALL') document.getElementById('nav-all').classList.add('active');
            else if (type === 'LOCATION') {
                const el = document.getElementById(`nav-${comp.replace(/\s/g,'')}-${loc.replace(/\s/g,'')}`);
                if(el) el.classList.add('active');
            }
            
            document.getElementById('bc-company').innerText = comp;
            document.getElementById('bc-location').innerText = loc;
            document.getElementById('page-title').innerText = loc === 'Overview' ? comp : loc;
            updateDashboard();
        }

        // --- TRIPLOG VIEW ---
        function sortTripLog(field) { STATE.tripSort = field; updateTripLogView(); }
        function updateTripLogTable() { updateTripLogView(); }

        function updateTripLogView() {
            const tbody = document.getElementById('triplog-body');
            const search = document.getElementById('triplog-search').value.toLowerCase();
            
            let filtered = STATE.tripLog.filter(d => (d.name+d.acct+d.bookId).toLowerCase().includes(search));

            filtered.sort((a,b) => {
                if(STATE.tripSort === 'date') return new Date(b.date) - new Date(a.date);
                if(STATE.tripSort === 'name') return a.name.localeCompare(b.name);
                if(STATE.tripSort === 'acct') return String(a.acct).localeCompare(String(b.acct));
                return 0;
            });

            document.getElementById('triplog-count').innerText = `${filtered.length} Entries`;
            if(filtered.length === 0) { tbody.innerHTML = `<tr><td colspan="10" class="p-8 text-center text-gray-600">No records found.</td></tr>`; return; }

            tbody.innerHTML = filtered.slice(0, 200).map(d => `
                <tr class="hover:bg-[#222] transition-colors border-b border-[#2a2a2a]">
                    <td class="p-4 font-bold text-white">${d.name}</td>
                    <td class="p-4 font-mono text-gray-400">${d.displayDate}</td>
                    <td class="p-4 text-blue-400 font-mono font-bold">${d.acct}</td>
                    <td class="p-4 text-gray-500 font-mono">${d.bookId}</td>
                    <td class="p-4 text-gray-300 text-xs">${d.pax}</td>
                    <td class="p-4 text-gray-400 text-xs truncate max-w-[150px]" title="${d.pickup}">${d.pickup}</td>
                    <td class="p-4 text-gray-400 text-xs truncate max-w-[150px]" title="${d.dropoff}">${d.dropoff}</td>
                    <td class="p-4 text-right text-gray-300 font-mono">${d.miles}</td>
                    <td class="p-4 text-right text-green-400 font-mono font-bold">${FMT.format(d.fare)}</td>
                    <td class="p-4 text-gray-500 text-[10px] truncate max-w-xs" title="${d.notes}">${d.notes}</td>
                </tr>
            `).join('');
        }

        // --- DASHBOARD (Finance) ---
        function updateDashboard() {
            let allWeeks = [], allDrivers = [];
            Object.keys(STATE.data).forEach(key => {
                const [dComp, dLoc] = key.split('_');
                const block = STATE.data[key];
                let match = false;
                if (STATE.ctxType === 'ALL') match = !block.weeks[0]?.isSummary;
                else if (STATE.ctxType === 'COMPANY') match = (dComp === STATE.ctxComp) && !block.weeks[0]?.isSummary;
                else if (STATE.ctxType === 'LOCATION') match = (dComp === STATE.ctxComp && dLoc === STATE.ctxLoc);
                if (match) { allWeeks = [...allWeeks, ...block.weeks]; allDrivers = [...allDrivers, ...block.drivers]; }
            });

            if (STATE.dateRange) {
                const s = moment(STATE.dateRange[0]).startOf('day'), e = moment(STATE.dateRange[1]).endOf('day');
                document.getElementById('chart-subtitle').innerText = `${s.format('MMM D')} - ${e.format('MMM D')}`;
                allWeeks = allWeeks.filter(d => moment(d.date).isBetween(s, e, undefined, '[]'));
            } else { document.getElementById('chart-subtitle').innerText = "All Time"; }

            updateCharts(allWeeks, allDrivers);
            updateTables(allWeeks, allDrivers);
            document.getElementById('record-count').innerText = `${allWeeks.length}`;
        }

        let charts = {};
        function destroyChart(id) { if(charts[id]) { charts[id].destroy(); delete charts[id]; } }

        function updateCharts(weeks, drivers) {
            destroyChart('trend'); destroyChart('costRadial'); destroyChart('costStack'); destroyChart('driverMargin');
            
            const agg = {}; weeks.forEach(d => { if(!agg[d.date]) agg[d.date]={r:0,e:0,m:0,p:0,f:0}; agg[d.date].r+=d.revenue; agg[d.date].e+=d.totalExp; agg[d.date].m+=d.margin; agg[d.date].p+=d.payroll; agg[d.date].f+=d.fuel; });
            const dates = Object.keys(agg).sort();

            charts.trend = new Chart(document.getElementById('chartTrend'), { type: 'line', data: { labels: dates.map(d=>moment(d).format('MMM D')), datasets: [{ label:'Rev', data:dates.map(d=>agg[d].r), borderColor:'#3b82f6', backgroundColor:'rgba(59,130,246,0.1)', fill:true, tension:0.3 }, { label:'Exp', data:dates.map(d=>agg[d].e), borderColor:'#ef4444', borderDash:[4,4], tension:0.3 }, { label:'Margin', data:dates.map(d=>agg[d].m), type:'bar', backgroundColor:c=>c.raw<0?'#ef4444':'#10b981', barThickness:8 }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}, datalabels:{display:false}}, scales:{x:{grid:{display:false}}, y:{grid:{color:'#333'}}} } });

            let tots = {p:0,f:0}; weeks.forEach(d=>{tots.p+=d.payroll; tots.f+=d.fuel;});
            charts.costRadial = new Chart(document.getElementById('chartCostRadial'), { type: 'doughnut', data: { labels: ['Payroll', 'Fuel'], datasets: [{ data: [tots.p, tots.f], backgroundColor: ['#3b82f6', '#ef4444'], borderWidth: 0 }] }, options: { responsive:true, maintainAspectRatio:false, cutout:'70%', layout:{padding:0}, plugins: { legend: { position:'right', labels:{color:'#999', boxWidth:10, usePointStyle:true} }, datalabels: { color:'#fff', formatter: (v, ctx) => { let sum = ctx.dataset.data.reduce((a,b)=>a+b,0); return sum && (v/sum > 0.05) ? (v*100/sum).toFixed(0)+"%" : ''; }} } } });

            charts.costStack = new Chart(document.getElementById('chartCostStack'), { type: 'bar', data: { labels: dates.map(d=>moment(d).format('MMM D')), datasets: [ { label:'Pay', data:dates.map(d=>agg[d].p), backgroundColor:'#3b82f6' }, { label:'Fuel', data:dates.map(d=>agg[d].f), backgroundColor:'#ef4444' } ] }, options: { responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true, grid:{display:false}}, y:{stacked:true, grid:{color:'#333'}}}, plugins: { legend:{display:false}, datalabels:{display:false} } } });

            const dAgg = {}; drivers.forEach(d => { if(!dAgg[d.name]) dAgg[d.name]={mar:0}; dAgg[d.name].mar+=d.margin; });
            const top = Object.entries(dAgg).map(([k,v])=>({name:k, ...v})).sort((a,b)=>b.mar - a.mar).slice(0, 10);
            charts.driverMargin = new Chart(document.getElementById('chartDriverMargin'), { type: 'bar', data: { labels: top.map(d=>d.name.split(' ')[0]), datasets: [{ label:'Margin', data:top.map(d=>d.mar), backgroundColor: top.map(d=>d.mar<0?'#ef4444':'#10b981'), borderRadius:4 }] }, options: { indexAxis:'y', responsive:true, maintainAspectRatio:false, scales:{x:{grid:{color:'#333'}}, y:{grid:{display:false}}}, plugins:{legend:{display:false}, datalabels:{color:'#fff', formatter:(v)=>'$'+Math.round(v)}} } });
        }

        function updateTables(weeks, drivers) {
            const sorted = [...weeks].sort((a,b)=>new Date(b.date)-new Date(a.date));
            document.getElementById('table-body').innerHTML = sorted.slice(0,100).map(d => `<tr class="hover:bg-[#222] transition-colors border-b border-[#2a2a2a]"><td class="p-3 text-white font-mono">${d.displayDate}</td><td class="p-3 text-right text-red-400 font-bold">${FMT.format(d.totalExp)}</td><td class="p-3 text-right text-blue-400 font-bold">${FMT.format(d.revenue)}</td><td class="p-3 text-right font-bold ${d.margin<0?'text-red-500':'text-green-500'}">${FMT.format(d.margin)}</td><td class="p-3 text-right text-xs text-gray-400">${d.marginPct||'-'}</td></tr>`).join('');
            
            const dAgg = {}; drivers.forEach(d => { if(!dAgg[d.name]) dAgg[d.name]={rev:0, pay:0, mar:0}; dAgg[d.name].rev+=d.rev; dAgg[d.name].pay+=d.payroll; dAgg[d.name].mar+=d.margin; });
            const drvSorted = Object.entries(dAgg).map(([k,v])=>({name:k, ...v})).sort((a,b)=>b.mar - a.mar);
            document.getElementById('driver-table-body').innerHTML = drvSorted.slice(0,100).map(d => `<tr class="hover:bg-[#222] transition-colors border-b border-[#2a2a2a]"><td class="p-3 text-white font-bold text-xs">${d.name}</td><td class="p-3 text-right text-gray-500 text-xs">${FMT.format(d.pay)}</td><td class="p-3 text-right text-blue-400 text-xs">${FMT.format(d.rev)}</td><td class="p-3 text-right font-bold text-xs ${d.mar<0?'text-red-500':'text-green-500'}">${FMT.format(d.mar)}</td><td class="p-3 text-right text-xs text-gray-400">${d.rev?((d.mar/d.rev)*100).toFixed(0)+'%':'-'}</td></tr>`).join('');
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NEMT Dashboard ‚Äî Overview + Drivers</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    html, body { height:100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#070707; color:#fff; }
    .panel { background:#0b0b0b; border:1px solid rgba(255,255,255,0.10); }
    .card  { background:#0f0f0f; border:1px solid rgba(255,255,255,0.10); }
    .chip  { background:#111; border:1px solid rgba(255,255,255,0.12); }
    .thin-scroll::-webkit-scrollbar{ width:10px; height:10px; }
    .thin-scroll::-webkit-scrollbar-track{ background: rgba(255,255,255,0.04); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.14); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,0.20); }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; opacity: 0.6; }
    input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 1; }

    .navbtn { width:100%; text-align:left; padding:10px 12px; border-radius:12px; border:1px solid transparent; }
    .navbtn:hover { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.10); }
    .navbtn.active { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.12); font-weight: 700; }

    .hiddenView { display:none; }
  </style>
</head>

<body>
  <div class="mx-auto max-w-[1500px] px-4 py-6">
    <div class="panel rounded-3xl overflow-hidden">
      <div class="grid grid-cols-1 lg:grid-cols-12 min-h-[86vh]">

        <!-- SIDEBAR -->
        <aside class="lg:col-span-3 border-b lg:border-b-0 lg:border-r border-white/10 bg-black">
          <div class="p-5">
            <div class="flex items-center gap-3">
              <div class="h-11 w-11 rounded-2xl bg-white/5 border border-white/10 grid place-items-center">
                <span class="font-extrabold tracking-wide">DLX</span>
              </div>
              <div>
                <div class="text-base font-semibold tracking-tight">Dashboard</div>
                <div class="text-xs text-white/60">Weekly + Driver performance</div>
              </div>
            </div>

            <!-- NAV -->
            <div class="mt-5 space-y-2 text-sm">
              <button class="navbtn active" data-view="overview">Overview</button>
              <button class="navbtn" data-view="loss">Loss Areas</button>
              <button class="navbtn" data-view="drivers">Drivers</button>
            </div>

            <!-- REGION FILTER -->
            <div class="mt-6">
              <div class="text-xs text-white/60 mb-2">Regions</div>
              <div class="card rounded-2xl p-2">
                <input id="regionFilter" class="w-full bg-transparent outline-none px-2 py-2 text-sm placeholder:text-white/35"
                       placeholder="Filter regions‚Ä¶" />
              </div>
              <div id="regionList" class="mt-3 grid grid-cols-1 gap-2"></div>
            </div>

            <!-- DRIVER FILTER -->
            <div class="mt-6">
              <div class="text-xs text-white/60 mb-2">Driver filter</div>
              <div class="card rounded-2xl p-2">
                <select id="driverSelect" class="w-full bg-transparent outline-none px-2 py-2 text-sm">
                  <option value="">All Drivers</option>
                </select>
              </div>
              <div class="text-[11px] text-white/50 mt-2">
                Driver stats come from ‚ÄúRunning Sheet‚Äù.
              </div>
            </div>

            <!-- STATUS -->
            <div class="mt-6 card rounded-2xl p-4">
              <div class="text-xs text-white/60">Status</div>
              <div id="statusLabel" class="text-xs text-white/80 mt-2">Status: ‚Äî</div>
              <div id="lastSyncLabel" class="text-xs text-white/55 mt-1">Last sync: ‚Äî</div>
              <div id="weekLabel" class="text-xs text-white/55 mt-1">Week: ‚Äî</div>

              <div class="mt-3 flex gap-2">
                <button id="refreshBtn" class="flex-1 rounded-xl px-3 py-2 text-sm bg-white/5 border border-white/10 hover:bg-white/10 transition">
                  Refresh
                </button>
                <button id="exportBtn" class="flex-1 rounded-xl px-3 py-2 text-sm bg-white/5 border border-white/10 hover:bg-white/10 transition">
                  Export
                </button>
              </div>
            </div>
          </div>
        </aside>

        <!-- MAIN -->
        <section class="lg:col-span-9">
          <div class="p-5 border-b border-white/10">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
              <div>
                <div id="dashTitle" class="text-xl font-semibold tracking-tight">DLX/DMT Weekly Dashboard</div>
                <div id="dashSubtitle" class="text-sm text-white/55 mt-1">Regional weekly performance + driver stats</div>
              </div>

              <div class="flex items-center gap-2">
                <div class="card rounded-2xl px-3 py-2 flex items-center gap-2 w-[320px] max-w-full">
                  <span class="text-white/50 text-sm">üìÖ</span>
                  <input type="date" id="searchInput"
                         class="bg-transparent outline-none w-full text-sm placeholder:text-white/35 text-white/90 [color-scheme:dark]" />
                </div>
                <div class="flex gap-2">
                  <div id="activeRegionPill" class="chip rounded-2xl px-3 py-2 text-sm font-semibold">ALL</div>
                  <div id="activeDriverPill" class="chip rounded-2xl px-3 py-2 text-sm font-semibold">ALL</div>
                </div>
              </div>
            </div>
          </div>

          <!-- OVERVIEW VIEW -->
          <div id="view-overview" class="p-5 space-y-4">

            <!-- KPIS -->
            <div class="grid grid-cols-2 xl:grid-cols-2 gap-4">
              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-white/60">Revenue</div>
                  <div class="chip rounded-xl px-2 py-1 text-[11px]">Week</div>
                </div>
                <div id="kpiRevenue" class="mt-2 text-3xl font-extrabold tracking-tight">‚Äî</div>
                <div class="mt-1 text-xs text-white/55">Gross</div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-white/60">Total Expense</div>
                  <div class="chip rounded-xl px-2 py-1 text-[11px]">TL Exp</div>
                </div>
                <div id="kpiExpense" class="mt-2 text-3xl font-extrabold tracking-tight">‚Äî</div>
                <div id="kpiExpenseSub" class="mt-1 text-xs text-white/55">‚Äî</div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-white/60">Margin</div>
                  <div class="chip rounded-xl px-2 py-1 text-[11px]">Net</div>
                </div>
                <div id="kpiMargin" class="mt-2 text-3xl font-extrabold tracking-tight">‚Äî</div>
                <div id="kpiMarginSub" class="mt-1 text-xs text-white/55">‚Äî</div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-white/60">Drivers</div>
                  <div class="chip rounded-xl px-2 py-1 text-[11px]">Count</div>
                </div>
                <div id="kpiDrivers" class="mt-2 text-3xl font-extrabold tracking-tight">‚Äî</div>
                <div id="kpiDriversSub" class="mt-1 text-xs text-white/55">‚Äî</div>
              </div>
            </div>

            <!-- CHARTS -->
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-sm font-semibold">Margin Trend</div>
                    <div class="text-xs text-white/55 mt-1">Oldest ‚Üí newest (last 16 weeks)</div>
                  </div>
                  <button id="toggleBaseline" class="chip rounded-2xl px-3 py-2 text-sm hover:bg-white/10 transition">
                    Toggle baseline
                  </button>
                </div>
                <div class="mt-3 bg-black/40 border border-white/10 rounded-2xl p-3">
                  <canvas id="trendChart" height="120"></canvas>
                </div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="text-sm font-semibold">Expense Mix</div>
                <div class="text-xs text-white/55 mt-1">Latest week categories</div>
                <div class="mt-3 bg-black/40 border border-white/10 rounded-2xl p-3 flex justify-center">
                  <canvas id="mixChart" height="140"></canvas>
                </div>
                <div id="mixLegend" class="mt-3 grid grid-cols-3 gap-2 text-xs text-white/70"></div>
              </div>
            </div>

            <!-- WEEKLY TABLE -->
            <div class="card rounded-3xl p-4">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm font-semibold">Weekly History</div>
                  <div class="text-xs text-white/55 mt-1">Recent weeks first (region view)</div>
                </div>
                <button id="resetBtn" class="chip rounded-2xl px-3 py-2 text-sm hover:bg-white/10 transition">
                  Reset
                </button>
              </div>

              <div class="mt-3 thin-scroll max-h-[520px] overflow-y-auto">
                <table class="min-w-full text-sm">
                  <thead class="text-white/60">
                    <tr class="border-b border-white/10">
                      <th class="py-2 text-left font-medium">Week</th>
                      <th class="py-2 text-left font-medium">% Margin</th>
                      <th class="py-2 text-left font-medium">Revenue</th>
                      <th class="py-2 text-left font-medium">TL Exp</th>
                      <th class="py-2 text-left font-medium">Margin</th>
                      <th class="py-2 text-left font-medium">Signal</th>
                    </tr>
                  </thead>
                  <tbody id="lossTableBody" class="divide-y divide-white/10"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- LOSS VIEW -->
          <div id="view-loss" class="p-5 space-y-4 hiddenView">
            <div class="card rounded-3xl p-4">
              <div class="text-sm font-semibold">Loss Areas</div>
              <div class="text-xs text-white/55 mt-1">
                Worst weeks first for current selection.
                (Region = main weekly sheets, Driver = Running Sheet rollup.)
              </div>

              <div class="mt-3 thin-scroll max-h-[720px] overflow-y-auto">
                <table class="min-w-full text-sm">
                  <thead class="text-white/60">
                    <tr class="border-b border-white/10">
                      <th class="py-2 text-left font-medium">Week</th>
                      <th class="py-2 text-left font-medium">% Margin</th>
                      <th class="py-2 text-left font-medium">Revenue</th>
                      <th class="py-2 text-left font-medium">TL Exp</th>
                      <th class="py-2 text-left font-medium">Margin</th>
                      <th class="py-2 text-left font-medium">Signal</th>
                    </tr>
                  </thead>
                  <tbody id="lossAreasBody" class="divide-y divide-white/10"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- DRIVERS VIEW -->
          <div id="view-drivers" class="p-5 space-y-4 hiddenView">
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">
              <div class="card rounded-3xl p-4">
                <div class="text-sm font-semibold">Driver Weekly History</div>
                <div class="text-xs text-white/55 mt-1">Select a driver to populate.</div>

                <div class="mt-3 thin-scroll max-h-[680px] overflow-y-auto">
                  <table class="min-w-full text-sm">
                    <thead class="text-white/60">
                      <tr class="border-b border-white/10">
                        <th class="py-2 text-left font-medium">Week</th>
                        <th class="py-2 text-left font-medium">% Margin</th>
                        <th class="py-2 text-left font-medium">Revenue</th>
                        <th class="py-2 text-left font-medium">TL Exp</th>
                        <th class="py-2 text-left font-medium">Margin</th>
                        <th class="py-2 text-left font-medium">Hours</th>
                      </tr>
                    </thead>
                    <tbody id="driverWeeklyBody" class="divide-y divide-white/10"></tbody>
                  </table>
                </div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="text-sm font-semibold">Latest Week Region Breakdown</div>
                <div class="text-xs text-white/55 mt-1">For selected driver only.</div>

                <div class="mt-3 thin-scroll max-h-[680px] overflow-y-auto">
                  <table class="min-w-full text-sm">
                    <thead class="text-white/60">
                      <tr class="border-b border-white/10">
                        <th class="py-2 text-left font-medium">Region</th>
                        <th class="py-2 text-left font-medium">Revenue</th>
                        <th class="py-2 text-left font-medium">TL Exp</th>
                        <th class="py-2 text-left font-medium">Margin</th>
                        <th class="py-2 text-left font-medium">Hours</th>
                      </tr>
                    </thead>
                    <tbody id="driverRegionBody" class="divide-y divide-white/10"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

        </section>
      </div>
    </div>
  </div>

<script>
  // ============================
  // CONFIG
  // ============================
  const WORKER_URL = "https://withered-king-c48e.haildir12121.workers.dev/";
  const POLL_MS = 120000;

  const REGION_SHEETS = [
    { id: "ALL", name: "All Areas (Sum)", sheet: null }, // computed
    { id: "CST", name: "Coast", sheet: "CST.Wkly" },
    { id: "EUG", name: "Eugene", sheet: "EUG.Wkly" },
    { id: "RBG", name: "Roseburg", sheet: "RBG.Wkly" },
    { id: "OKRDG", name: "Oakridge", sheet: "OKRDG.Wkly" },
    { id: "MDVCR", name: "Mid-Valley/Corvallis", sheet: "MDVCR.Wkly" },
    { id: "ALBNY", name: "Albany", sheet: "ALBNY.Wkly" },
    { id: "DMT", name: "DMT", sheet: "DMT.Wkly" }
  ];

  const COLMAP = {
    weekStart: "P",
    weekEnd: "Q",
    driverCount: "R",
    hoursWorked: "S",
    payroll: "T",
    fuel: "U",
    insurance: "V",
    maintenance: "W",
    billbacks: "X",
    totalExp: "Y",
    revenue: "Z",
    margin: "AA",
    pctMargin: "AB",
  };

  const CONSOLIDATED_SHEET = "ConsolidatedWkly";
  const TITLE_CELL = "P1";
  const SUBTITLE_CELL = "P2";

  const RUNNING_SHEET_NAME = "Running Sheet";

  const RUNNING_SCHEMA = {
    dataHeaderRowIndex0: 2,  // Matches Row 3 in the sheet
    dateCol: "D",            // Matches the "Date" column
    areas: [
      { id:"CST", name:"Coast", start:"E", end:"N" },        // Corrected from EE
      { id:"RBG", name:"Roseburg", start:"P", end:"Y" },     // Corrected from PP
      { id:"EUG", name:"Eugene", start:"AA", end:"AJ" },
      { id:"OKRDG", name:"Oakridge", start:"AL", end:"AU" },
      { id:"ALBNY", name:"Albany", start:"AW", end:"BF" },
      { id:"MDVCR", name:"ModivCare", start:"BG", end:"BP" },
      { id:"DMT", name:"DMT", start:"BR", end:"CA" }         // Added missing DMT section
    ],
    offsets: {
      driver: 0,
      hours: 1,
      payroll: 2,
      fuel: 3,
      insurance: 4,
      maintenance: 5,
      totalExp: 7,
      revenue: 8,
      margin: 9
    }
  };

  // ============================
  // STATE
  // ============================
  let regionSeries = {};
  let activeRegionId = "ALL";
  let weekly = [];
  let latestWeek = null;

  let trendChart = null;
  let mixChart = null;
  let showBaseline = true;
  let _timer = null;

  let activeView = "overview";

  // Driver state
  let driverIndex = {};      // driverName -> { rows: [...] }
  let activeDriver = "";
  let driverWeekly = [];     // aggregated weeks for that driver

  // ============================
  // HELPERS
  // ============================
  function setStatus(text){
    const el = document.getElementById("statusLabel");
    if (el) el.textContent = `Status: ${text}`;
  }

  function fmtUSD(n){
    return Number(n||0).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});
  }

  function safeNum(v){
    if (typeof v === "number") return isFinite(v) ? v : 0;
    if (v == null) return 0;
    const s = String(v).replace(/[^0-9.\-]/g,"");
    const n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }

  function asDate(v){
    if (v instanceof Date && !isNaN(v)) return v;
    if (typeof v === "number" && isFinite(v)) {
      const utcDays = Math.floor(v - 25569);
      return new Date(utcDays * 86400 * 1000);
    }
    const d = new Date(v);
    return isNaN(d) ? null : d;
  }

  function niceDate(v){
    const d = asDate(v);
    if (!d) return String(v||"");
    return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
  }

  function colToIndex(col){
    let n = 0;
    const s = String(col).toUpperCase().trim();
    for (let i=0;i<s.length;i++) n = n * 26 + (s.charCodeAt(i) - 64);
    return n - 1;
  }

  function weekTimestamp(w){
    const d = asDate(w.weekEnd) || asDate(w.weekStart);
    return d ? d.getTime() : -Infinity;
  }

  function sortWeeksDesc(arr){
    return (arr || []).slice().sort((a,b)=> weekTimestamp(b) - weekTimestamp(a));
  }

  function weekKey(weekStart, weekEnd){
    return `${niceDate(weekStart)}|${niceDate(weekEnd)}`;
  }

  function readCell(ws, addr){
    return ws?.[addr]?.v ?? "";
  }

  function pmBadge(pm){
    if (!isFinite(pm)) return { label:"‚Äî", cls:"text-white/70" };
    if (pm < 0) return { label:"LOSS", cls:"text-rose-300" };
    if (pm < 5) return { label:"RISK", cls:"text-amber-200" };
    return { label:"OK", cls:"text-emerald-200" };
  }

  function buildSignal(w){
    const pm = w.pctMargin || 0;
    if (pm < 0) return "Loss week. Check payroll, maintenance, and fuel burdens.";
    if (pm < 5) return "Low margin. Investigate expense spikes and underpriced weeks.";
    return "Healthy week.";
  }

  function getWeekRangeForDate(d){
    const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 12, 0, 0);
    const day = dt.getDay();
    const SAT = 6;
    const diffToSat = (day - SAT + 7) % 7;
    const start = new Date(dt); start.setDate(dt.getDate() - diffToSat);
    const end = new Date(start); end.setDate(start.getDate() + 6);
    return { start, end, key: weekKey(start, end) };
  }

  // ============================
  // FETCH + XLSX
  // ============================
  async function fetchWorkbook(){
    const res = await fetch(WORKER_URL, { cache: "no-store" });
    if (!res.ok) throw new Error(`Fetch failed (${res.status})`);

    const fileName = res.headers.get("X-File-Name") || "shared-file.xlsx";
    const fetchedAt = res.headers.get("X-Fetched-At") || new Date().toISOString();

    const bytes = await res.arrayBuffer();
    const wb = XLSX.read(bytes, { type: "array" });

    return { wb, meta: { fileName, fetchedAt } };
  }

  // ============================
  // PARSE REGION WEEKLY TABLE (P..AB)
  // ============================
  function parseRegionSheet(ws){
    const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

    const idx = {};
    for (const [k, col] of Object.entries(COLMAP)) idx[k] = colToIndex(col);

    const P = idx.weekStart;
    const Q = idx.weekEnd;

    const hasWord = (v, word) => String(v||"").toLowerCase().includes(word);

    let headerRow = -1;
    for (let r=0; r<Math.min(140, aoa.length); r++){
      const row = aoa[r] || [];
      const z = row[idx.revenue];
      const aa = row[idx.margin];
      const ab = row[idx.pctMargin];
      const p = row[P];
      const q = row[Q];

      const looksLikeHeader =
        (hasWord(p,"week") && hasWord(q,"week")) ||
        (hasWord(z,"revenue") && hasWord(aa,"margin")) ||
        (hasWord(ab,"margin") && (String(ab).includes("%") || hasWord(ab,"%")));

      if (looksLikeHeader) { headerRow = r; break; }
    }
    if (headerRow === -1) headerRow = 2;

    const dataStart = headerRow + 1;

    const out = [];
    for (let r = dataStart; r < aoa.length; r++){
      const row = aoa[r] || [];
      const wsVal = row[P];
      const weVal = row[Q];

      if (String(wsVal).trim()==="" && String(weVal).trim()==="") break;

      const revenue = safeNum(row[idx.revenue]);
      const totalExp = safeNum(row[idx.totalExp]);
      const margin = safeNum(row[idx.margin]);

      const hasMoney = Math.abs(revenue) > 0.0001 || Math.abs(totalExp) > 0.0001 || Math.abs(margin) > 0.0001;
      if (!hasMoney) continue;

      let pmRaw = row[idx.pctMargin];
      let pm = 0;
      if (typeof pmRaw === "number") pm = pmRaw <= 1.5 ? pmRaw * 100 : pmRaw;
      else {
        const n = safeNum(pmRaw);
        pm = n <= 1.5 ? n * 100 : n;
      }
      if (!isFinite(pm)) pm = 0;

      out.push({
        weekStart: wsVal,
        weekEnd: weVal,
        revenue,
        totalExp,
        margin,
        pctMargin: pm,
        driverCount: Math.round(safeNum(row[idx.driverCount])),
        hoursWorked: safeNum(row[idx.hoursWorked]),
        payroll: safeNum(row[idx.payroll]),
        fuel: safeNum(row[idx.fuel]),
        insurance: safeNum(row[idx.insurance]),
        maintenance: safeNum(row[idx.maintenance]),
        billbacks: safeNum(row[idx.billbacks]),
      });
    }
    return sortWeeksDesc(out);
  }

  function sumRegionsByWeek(seriesById){
    const map = new Map();
    for (const [id, series] of Object.entries(seriesById || {})){
      if (id === "ALL") continue;
      for (const w of (series || [])){
        const key = weekKey(w.weekStart, w.weekEnd);
        const cur = map.get(key) || {
          weekStart: w.weekStart,
          weekEnd: w.weekEnd,
          revenue: 0, totalExp: 0, margin: 0, pctMargin: 0,
          payroll:0, fuel:0, insurance:0, maintenance:0, billbacks:0,
          driverCount:0, hoursWorked:0
        };
        cur.revenue += w.revenue || 0;
        cur.totalExp += w.totalExp || 0;
        cur.margin += w.margin || 0;

        cur.payroll += w.payroll || 0;
        cur.fuel += w.fuel || 0;
        cur.insurance += w.insurance || 0;
        cur.maintenance += w.maintenance || 0;
        cur.billbacks += w.billbacks || 0;

        cur.driverCount += w.driverCount || 0;
        cur.hoursWorked += w.hoursWorked || 0;

        map.set(key, cur);
      }
    }
    const all = Array.from(map.values());
    for (const w of all){
      w.pctMargin = ((w.revenue - w.totalExp) / Math.max(1, w.revenue)) * 100;
      if (!isFinite(w.pctMargin)) w.pctMargin = 0;
    }
    return sortWeeksDesc(all);
  }

  // ============================
  // RUNNING SHEET PARSER (DRIVERS)
  // ============================
  function parseRunningSheetFixed(ws){
    const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });
    const headerRow = RUNNING_SCHEMA.dataHeaderRowIndex0;
    const dateColIdx = colToIndex(RUNNING_SCHEMA.dateCol);

    const norm = (v) => String(v || "").trim().toLowerCase();

    const areas = RUNNING_SCHEMA.areas.map(a => ({
      ...a,
      startIdx: colToIndex(a.start),
      endIdx: colToIndex(a.end),
      driverColIdx: -1
    }));

    for (const a of areas) {
      for (let c = a.startIdx; c <= a.endIdx; c++) {
        if (norm(aoa[headerRow]?.[c]) === "driver") {
          a.driverColIdx = c;
          break;
        }
      }
      if (a.driverColIdx < 0) a.driverColIdx = a.startIdx;
    }

    const out = {};
    for (let r = headerRow + 1; r < aoa.length; r++){
      const row = aoa[r] || [];
      const d = asDate(row[dateColIdx]);
      if (!d) continue;

      for (const a of areas){
        const base = a.driverColIdx;
        const name = String(row[base + RUNNING_SCHEMA.offsets.driver] || "").trim();
        if (!name) continue;

        const revenue = safeNum(row[base + RUNNING_SCHEMA.offsets.revenue]);
        const totalExp = safeNum(row[base + RUNNING_SCHEMA.offsets.totalExp]);
        const margin = safeNum(row[base + RUNNING_SCHEMA.offsets.margin]);
        const hours = safeNum(row[base + RUNNING_SCHEMA.offsets.hours]);

        const hasMoney = Math.abs(revenue) > 0.0001 || Math.abs(totalExp) > 0.0001 || Math.abs(margin) > 0.0001 || Math.abs(hours) > 0.0001;
        if (!hasMoney) continue;

        const entry = {
          date: d,
          region: a.name,
          regionId: a.id,
          hours,
          payroll: safeNum(row[base + RUNNING_SCHEMA.offsets.payroll]),
          fuel: safeNum(row[base + RUNNING_SCHEMA.offsets.fuel]),
          insurance: safeNum(row[base + RUNNING_SCHEMA.offsets.insurance]),
          maintenance: safeNum(row[base + RUNNING_SCHEMA.offsets.maintenance]),
          revenue, totalExp, margin
        };

        if (!out[name]) out[name] = { rows: [] };
        out[name].rows.push(entry);
      }
    }

    for (const k of Object.keys(out)){
      out[k].rows.sort((a,b)=> b.date.getTime() - a.date.getTime());
    }

    return out;
  }

  function populateDriverSelect(){
    const sel = document.getElementById("driverSelect");
    if (!sel) return;

    const keep = sel.value || "";
    sel.innerHTML = `<option value="">All Drivers</option>`;

    Object.keys(driverIndex || {})
      .sort((a,b)=>a.localeCompare(b))
      .forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      });

    sel.value = keep;
  }

  function getDriverWeekly(driverName){
    const rows = driverIndex?.[driverName]?.rows || [];
    const map = new Map();

    for (const r of rows){
      const wk = getWeekRangeForDate(r.date);
      const key = wk.key;

      const cur = map.get(key) || {
        weekStart: wk.start,
        weekEnd: wk.end,
        revenue: 0,
        totalExp: 0,
        margin: 0,
        pctMargin: 0,
        hoursWorked: 0,
        driverCount: 1
      };

      cur.revenue += r.revenue || 0;
      cur.totalExp += r.totalExp || 0;
      cur.margin += r.margin || 0;
      cur.hoursWorked += r.hours || 0;

      map.set(key, cur);
    }

    const out = sortWeeksDesc([...map.values()]);
    for (const w of out){
      w.pctMargin = ((w.revenue - w.totalExp) / Math.max(1, w.revenue)) * 100;
      if (!isFinite(w.pctMargin)) w.pctMargin = 0;
    }
    return out;
  }

  function getDriverLatestWeekRegionBreakdown(driverName){
    const rows = driverIndex?.[driverName]?.rows || [];
    if (!rows.length) return { regions: [], weekStart:null, weekEnd:null };

    const latest = getWeekRangeForDate(rows[0].date);
    const key = latest.key;

    const map = new Map();
    for (const r of rows){
      const wk = getWeekRangeForDate(r.date);
      if (wk.key !== key) continue;

      const cur = map.get(r.region) || { region: r.region, revenue: 0, totalExp: 0, margin: 0, hours: 0 };
      cur.revenue += r.revenue || 0;
      cur.totalExp += r.totalExp || 0;
      cur.margin += r.margin || 0;
      cur.hours += r.hours || 0;
      map.set(r.region, cur);
    }

    const regions = [...map.values()].sort((a,b)=> b.revenue - a.revenue);
    return { regions, weekStart: latest.start, weekEnd: latest.end };
  }

  // ============================
  // UI: REGION LIST
  // ============================
  function renderRegionSidebar(){
    const list = document.getElementById("regionList");
    if (!list) return;

    const filter = String(document.getElementById("regionFilter")?.value || "").trim().toLowerCase();
    list.innerHTML = "";

    REGION_SHEETS
      .filter(r => !filter || r.name.toLowerCase().includes(filter) || r.id.toLowerCase().includes(filter))
      .forEach(r=>{
        const series = regionSeries[r.id] || [];
        const w = series[0];
        const pm = w ? w.pctMargin : NaN;
        const b = pmBadge(pm);

        const btn = document.createElement("button");
        btn.className =
          "card rounded-2xl px-3 py-3 text-left hover:bg-white/5 transition " +
          (r.id === activeRegionId ? "ring-1 ring-white/20" : "");

        btn.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="text-sm font-semibold truncate">${r.name}</div>
              <div class="text-xs text-white/55 truncate">${r.sheet ? r.sheet : "computed sum"}</div>
            </div>
            <div class="text-right shrink-0">
              <div class="text-sm font-bold">${w ? w.pctMargin.toFixed(2)+"%" : "‚Äî"}</div>
              <div class="text-[11px] ${b.cls}">${b.label}</div>
            </div>
          </div>
        `;

        btn.addEventListener("click", ()=>{
          activeRegionId = r.id;
          document.getElementById("activeRegionPill").textContent = r.id;

          weekly = sortWeeksDesc(regionSeries[activeRegionId] || []);
          latestWeek = weekly[0] || null;

          renderRegionSidebar();
          renderOverview();
          if (activeView === "loss") renderLossView();
        });

        list.appendChild(btn);
      });
  }

  // ============================
  // UI: OVERVIEW
  // ============================
  function renderKpis(){
    const w = latestWeek;
    if (!w) return;

    const rev = w.revenue || 0;
    const exp = w.totalExp || 0;
    const pm = isFinite(w.pctMargin) ? w.pctMargin : ((rev-exp)/Math.max(1,rev))*100;

    document.getElementById("kpiRevenue").textContent = fmtUSD(rev);
    document.getElementById("kpiExpense").textContent = fmtUSD(exp);
    document.getElementById("kpiExpenseSub").textContent = `TL Exp ‚Ä¢ ${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}`;
    document.getElementById("kpiMargin").textContent = `${pm.toFixed(2)}%`;
    document.getElementById("kpiMarginSub").textContent = `${fmtUSD(w.margin || 0)} margin`;

    document.getElementById("kpiDrivers").textContent = `${w.driverCount || 0}`;
    document.getElementById("kpiDriversSub").textContent = `Hours: ${Math.round(w.hoursWorked || 0)} ‚Ä¢ Cost/Driver: ${fmtUSD((exp/Math.max(1,w.driverCount||0))||0)}`;

    document.getElementById("weekLabel").textContent = `Week: ${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}`;
  }

  function renderTrendChart(){
    const seriesDesc = (weekly || []).filter(w => isFinite(w.pctMargin) && Math.abs(w.revenue) > 0.0001);
    const take = seriesDesc.slice(0, 16).reverse();
    const labels = take.map(w => niceDate(w.weekEnd));
    const data = take.map(w => w.pctMargin);
    const baseline = data.length ? data.reduce((a,b)=>a+b,0)/data.length : 0;

    const canvas = document.getElementById("trendChart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    if (trendChart) trendChart.destroy();

    const datasets = [{
      label: "% Margin",
      data,
      borderColor: "rgba(255,255,255,0.85)",
      borderWidth: 2,
      pointRadius: 0,
      tension: 0.35,
      fill: true,
      backgroundColor: "rgba(255,255,255,0.06)"
    }];

    if (showBaseline){
      datasets.push({
        label: "Baseline",
        data: Array(data.length).fill(baseline),
        borderColor: "rgba(255,255,255,0.25)",
        borderWidth: 1,
        pointRadius: 0,
        tension: 0.2
      });
    }

    trendChart = new Chart(ctx, {
      type: "line",
      data: { labels, datasets },
      options: {
        plugins: { legend: { display:false } },
        scales: {
          x: { grid:{ display:false }, ticks:{ color:"rgba(255,255,255,0.55)" } },
          y: { grid:{ color:"rgba(255,255,255,0.08)" }, ticks:{ color:"rgba(255,255,255,0.55)", callback:(v)=>`${v}%` } }
        }
      }
    });
  }

  function renderMixChart(){
    const w = latestWeek;
    if (!w) return;

    const labels = ["Payroll","Fuel","Insurance","Maintenance","Billbacks","Other"];
    const vals = [
      w.payroll||0,
      w.fuel||0,
      w.insurance||0,
      w.maintenance||0,
      w.billbacks||0
    ];
    const known = vals.reduce((a,b)=>a+b,0);
    const other = Math.max(0, (w.totalExp||0) - known);
    vals.push(other);

    const canvas = document.getElementById("mixChart");
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    if (mixChart) mixChart.destroy();

    mixChart = new Chart(ctx, {
      type: "doughnut",
      data: { labels, datasets: [{ data: vals }] },
      options: { plugins: { legend: { display:false } }, cutout: "62%" }
    });

    const legend = document.getElementById("mixLegend");
    if (!legend) return;
    legend.innerHTML = "";
    const total = Math.max(1, (w.totalExp||0));

    labels.forEach((lab, i)=>{
      const pct = (vals[i]/total)*100;
      const div = document.createElement("div");
      div.className = "chip rounded-xl px-2 py-2";
      div.innerHTML = `
        <div class="text-[11px] text-white/60">${lab}</div>
        <div class="text-sm font-semibold">${pct.toFixed(1)}%</div>
      `;
      legend.appendChild(div);
    });
  }

  function renderWeeklyTable(customData = null){
    const tbody = document.getElementById("lossTableBody");
    if (!tbody) return;
    tbody.innerHTML = "";

    let series = customData || weekly;
    series = (series || []).filter(w => isFinite(w.pctMargin) && Math.abs(w.revenue) > 0.0001);
    series = sortWeeksDesc(series);

    const rows = series.slice(0, 80);
    if (!rows.length){
      tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-white/50">No data.</td></tr>`;
      return;
    }

    rows.forEach(w=>{
      const b = pmBadge(w.pctMargin);
      const tr = document.createElement("tr");
      tr.className = "hover:bg-white/5 transition";
      tr.innerHTML = `
        <td class="py-3 pr-3">
          <div class="font-semibold">${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}</div>
          <div class="text-xs text-white/55">Drivers: ${w.driverCount || 0}</div>
        </td>
        <td class="py-3 pr-3 font-semibold ${b.cls}">${(w.pctMargin||0).toFixed(2)}%</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.revenue)}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.totalExp)}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.margin)}</td>
        <td class="py-3 pr-3 text-white/70"><div class="max-w-[520px] truncate">${buildSignal(w)}</div></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderOverview(){
    if (!latestWeek){
      setStatus("No data");
      return;
    }
    renderKpis();
    renderTrendChart();
    renderMixChart();
    renderWeeklyTable();
    setStatus(`OK (${activeRegionId})`);
  }

  // ============================
  // UI: LOSS VIEW
  // ============================
  function renderLossView(){
    const tbody = document.getElementById("lossAreasBody");
    if (!tbody) return;
    tbody.innerHTML = "";

    // If a driver is selected, show driver worst weeks
    if (activeDriver){
      let series = (driverWeekly || []).slice().sort((a,b)=> (a.pctMargin - b.pctMargin));
      const rows = series.slice(0, 80);
      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-white/50">No driver weeks.</td></tr>`;
        return;
      }

      rows.forEach(w=>{
        const b = pmBadge(w.pctMargin);
        const tr = document.createElement("tr");
        tr.className = "hover:bg-white/5 transition";
        tr.innerHTML = `
          <td class="py-3 pr-3">
            <div class="font-semibold">${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}</div>
            <div class="text-xs text-white/55">Driver: ${activeDriver}</div>
          </td>
          <td class="py-3 pr-3 font-semibold ${b.cls}">${(w.pctMargin||0).toFixed(2)}%</td>
          <td class="py-3 pr-3 text-white/85">${fmtUSD(w.revenue)}</td>
          <td class="py-3 pr-3 text-white/85">${fmtUSD(w.totalExp)}</td>
          <td class="py-3 pr-3 text-white/85">${fmtUSD(w.margin)}</td>
          <td class="py-3 pr-3 text-white/70"><div class="truncate">${buildSignal(w)}</div></td>
        `;
        tbody.appendChild(tr);
      });
      return;
    }

    // Otherwise: worst weeks for current region
    let series = (weekly || []).filter(w=>isFinite(w.pctMargin)).slice().sort((a,b)=> (a.pctMargin - b.pctMargin));
    const rows = series.slice(0, 80);
    if (!rows.length){
      tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-white/50">No weeks.</td></tr>`;
      return;
    }

    rows.forEach(w=>{
      const b = pmBadge(w.pctMargin);
      const tr = document.createElement("tr");
      tr.className = "hover:bg-white/5 transition";
      tr.innerHTML = `
        <td class="py-3 pr-3">
          <div class="font-semibold">${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}</div>
          <div class="text-xs text-white/55">Region: ${activeRegionId}</div>
        </td>
        <td class="py-3 pr-3 font-semibold ${b.cls}">${(w.pctMargin||0).toFixed(2)}%</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.revenue)}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.totalExp)}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.margin)}</td>
        <td class="py-3 pr-3 text-white/70"><div class="truncate">${buildSignal(w)}</div></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ============================
  // UI: DRIVER VIEW
  // ============================
  function renderDriverWeeklyTable(){
    const tbody = document.getElementById("driverWeeklyBody");
    if (!tbody) return;
    tbody.innerHTML = "";

    if (!activeDriver){
      tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-white/50">Select a driver.</td></tr>`;
      return;
    }

    const rows = (driverWeekly || []).slice(0, 120);
    if (!rows.length){
      tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-white/50">No driver rows.</td></tr>`;
      return;
    }

    rows.forEach(w=>{
      const b = pmBadge(w.pctMargin);
      const tr = document.createElement("tr");
      tr.className = "hover:bg-white/5 transition";
      tr.innerHTML = `
        <td class="py-3 pr-3"><div class="font-semibold">${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}</div></td>
        <td class="py-3 pr-3 font-semibold ${b.cls}">${(w.pctMargin||0).toFixed(2)}%</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.revenue)}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.totalExp)}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.margin)}</td>
        <td class="py-3 pr-3 text-white/85">${Math.round(w.hoursWorked||0)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderDriverRegionBreakdown(){
    const tbody = document.getElementById("driverRegionBody");
    if (!tbody) return;
    tbody.innerHTML = "";

    if (!activeDriver){
      tbody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-white/50">Select a driver.</td></tr>`;
      return;
    }

    const br = getDriverLatestWeekRegionBreakdown(activeDriver);
    if (!br.regions.length){
      tbody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-white/50">No region breakdown.</td></tr>`;
      return;
    }

    br.regions.forEach(x=>{
      const tr = document.createElement("tr");
      tr.className = "hover:bg-white/5 transition";
      tr.innerHTML = `
        <td class="py-3 pr-3 font-semibold">${x.region}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(x.revenue)}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(x.totalExp)}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(x.margin)}</td>
        <td class="py-3 pr-3 text-white/85">${Math.round(x.hours||0)}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderDriversView(){
    renderDriverWeeklyTable();
    renderDriverRegionBreakdown();
    setStatus(activeDriver ? `OK (Driver: ${activeDriver})` : "OK (No driver selected)");
  }

  // ============================
  // VIEWS
  // ============================
  function setView(view){
    activeView = view;
    document.querySelectorAll(".navbtn").forEach(btn=>{
      btn.classList.toggle("active", btn.getAttribute("data-view") === view);
    });
    ["overview","loss","drivers"].forEach(v=>{
      const el = document.getElementById(`view-${v}`);
      if (!el) return;
      el.classList.toggle("hiddenView", v !== view);
    });

    if (view === "overview") renderOverview();
    if (view === "loss") renderLossView();
    if (view === "drivers") renderDriversView();
  }

  // ============================
  // EVENTS
  // ============================
  document.getElementById("toggleBaseline")?.addEventListener("click", ()=>{
    showBaseline = !showBaseline;
    renderTrendChart();
  });

  document.getElementById("exportBtn")?.addEventListener("click", ()=>{
    const payload = {
      generatedAt: new Date().toISOString(),
      activeRegionId,
      activeDriver,
      latestWeek,
      weekly,
      driverWeekly
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `dashboard_snapshot_${activeRegionId}_${activeDriver||"ALL"}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("resetBtn")?.addEventListener("click", ()=>{
    const si = document.getElementById("searchInput");
    if (si) si.value = "";
    renderWeeklyTable();
  });

  document.getElementById("regionFilter")?.addEventListener("input", ()=> renderRegionSidebar());

  document.getElementById("refreshBtn")?.addEventListener("click", ()=> refresh());

  document.querySelectorAll(".navbtn").forEach(btn=>{
    btn.addEventListener("click", ()=> setView(btn.getAttribute("data-view")));
  });

  document.getElementById("driverSelect")?.addEventListener("change", (e)=>{
    activeDriver = e.target.value || "";
    document.getElementById("activeDriverPill").textContent = activeDriver || "ALL";

    driverWeekly = activeDriver ? getDriverWeekly(activeDriver) : [];
    if (activeView === "drivers") renderDriversView();
    if (activeView === "loss") renderLossView();
  });

  document.getElementById("searchInput")?.addEventListener("change", (e)=>{
    const val = e.target.value;
    if (!val) return renderWeeklyTable();

    const inputDate = new Date(val + "T12:00:00");
    const t = inputDate.getTime();

    const filtered = (weekly || []).filter(w=>{
      const s = asDate(w.weekStart);
      const ed = asDate(w.weekEnd);
      if (!s || !ed) return false;
      return t >= s.getTime() && t <= ed.getTime();
    });

    renderWeeklyTable(filtered);
  });

  // ============================
  // LIVE LOOP
  // ============================
  async function refresh(){
    try{
      setStatus("Syncing‚Ä¶");
      const { wb, meta } = await fetchWorkbook();

      // optional title/subtitle
      const cws = wb.Sheets[CONSOLIDATED_SHEET];
      if (cws){
        const title = readCell(cws, TITLE_CELL);
        const subtitle = readCell(cws, SUBTITLE_CELL);
        if (title) document.getElementById("dashTitle").textContent = String(title);
        if (subtitle) document.getElementById("dashSubtitle").textContent = String(subtitle);
      }

      // parse region sheets
      regionSeries = {};
      for (const r of REGION_SHEETS){
        if (r.id === "ALL") continue;
        const ws = wb.Sheets[r.sheet];
        regionSeries[r.id] = ws ? parseRegionSheet(ws) : [];
      }
      regionSeries["ALL"] = sumRegionsByWeek(regionSeries);

      // keep region selection
      weekly = sortWeeksDesc(regionSeries[activeRegionId] || regionSeries["ALL"] || []);
      latestWeek = weekly[0] || null;

      // parse drivers from running sheet
      const rws = wb.Sheets[RUNNING_SHEET_NAME];
      if (rws){
        driverIndex = parseRunningSheetFixed(rws);
        populateDriverSelect();
      } else {
        driverIndex = {};
        populateDriverSelect();
      }

      // rebuild driverWeekly if driver still selected
      driverWeekly = activeDriver ? getDriverWeekly(activeDriver) : [];

      const fetchedAt = meta?.fetchedAt ? new Date(meta.fetchedAt) : new Date();
      const lastSync = document.getElementById("lastSyncLabel");
      if (lastSync) lastSync.textContent = `Last sync: ${fetchedAt.toLocaleString()} ‚Ä¢ ${meta.fileName || ""}`;

      document.getElementById("activeRegionPill").textContent = activeRegionId;
      document.getElementById("activeDriverPill").textContent = activeDriver || "ALL";

      renderRegionSidebar();

      // render active view
      setView(activeView);

    } catch (err){
      console.error(err);
      setStatus(`Sync failed: ${String(err?.message || err)}`);
    }
  }

  function start(){
    setView("overview");
    refresh();
    if (_timer) clearInterval(_timer);
    _timer = setInterval(refresh, POLL_MS);
  }

  start();
</script>

</body>
</html>

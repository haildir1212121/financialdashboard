<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NEMT Dashboard — DLX</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* GLOBAL */
    html, body { height:100%; }
    body { 
      font-family: 'Inter', system-ui, sans-serif; 
      background: #050505; 
      background-image: radial-gradient(circle at 50% 0%, #16161a 0%, #050505 70%);
      color: #e2e8f0; 
      overflow: hidden; 
    }

    /* CARDS */
    .panel { 
      background: rgba(10, 10, 10, 0.75); 
      backdrop-filter: blur(16px); 
      border: 1px solid rgba(255,255,255,0.08); 
    }
    .card  { 
      background: rgba(255, 255, 255, 0.03); 
      border: 1px solid rgba(255,255,255,0.05); 
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
    }
    .card:hover { border-color: rgba(255,255,255,0.12); background: rgba(255,255,255,0.05); }
    
    /* SCROLLBARS */
    .thin-scroll::-webkit-scrollbar{ width:5px; height:5px; }
    .thin-scroll::-webkit-scrollbar-track{ background: transparent; }
    .thin-scroll::-webkit-scrollbar-thumb{ background: #333; border-radius: 99px; }
    .thin-scroll::-webkit-scrollbar-thumb:hover{ background: #555; }

    .navbtn { width:100%; text-align:left; padding:8px 10px; border-radius:8px; border:1px solid transparent; transition: all 0.2s; color: #94a3b8; font-size: 0.8rem; }
    .navbtn:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .navbtn.active { 
      background: rgba(99, 102, 241, 0.15); 
      border-color: rgba(99, 102, 241, 0.3); 
      color: #818cf8; 
      font-weight: 600; 
    }
    
    /* REGION BUTTONS */
    .region-btn {
        width: 100%; display: flex; align-items: center; justify-content: space-between;
        padding: 10px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 500;
        transition: all 0.2s; border: 1px solid transparent;
        color: rgba(255,255,255,0.6);
    }
    .region-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .region-btn.active { 
        background: rgba(255,255,255,0.08); 
        border-color: rgba(255,255,255,0.1); 
        color: #fff; 
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .view-hidden { opacity: 0; pointer-events: none; position: absolute; width: 100%; }
    .hiddenView { display:none !important; }
    .hidden { display: none !important; }
    
    /* CHART TOGGLES */
    .chart-toggle { 
      padding: 4px 8px; font-size: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; 
      color: rgba(255,255,255,0.5); background: transparent; text-transform: uppercase; font-weight: 700; 
      transition: all 0.2s; cursor: pointer;
    }
    .chart-toggle:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .chart-toggle.active { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; border-color: rgba(99, 102, 241, 0.4); }
    
    /* CYCLE BUTTON */
    .cycle-btn {
      display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 8px;
      font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
      color: #a5b4fc; background: rgba(99, 102, 241, 0.15); border: 1px solid rgba(99, 102, 241, 0.3);
      transition: all 0.2s; cursor: pointer; select-none: none; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }
    .cycle-btn:hover { background: rgba(99, 102, 241, 0.25); border-color: rgba(99, 102, 241, 0.5); color: #fff; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
    .cycle-btn:active { transform: translateY(1px); }

    .tab-btn {
        padding-bottom: 4px; border-bottom: 2px solid transparent; color: rgba(255,255,255,0.4); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s;
    }
    .tab-btn.active { border-color: #818cf8; color: #fff; }
    .tab-btn:hover:not(.active) { color: rgba(255,255,255,0.8); }
  </style>
</head>

<body>
  <div class="mx-auto max-w-[1800px] h-full p-2 lg:p-4">
    <div class="panel rounded-2xl overflow-hidden h-full flex flex-col lg:flex-row shadow-2xl">

      <aside class="w-full lg:w-[260px] flex-shrink-0 border-b lg:border-b-0 lg:border-r border-white/10 bg-[#080808] flex flex-col h-full">
        <div class="p-4 border-b border-white/5">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-lg bg-gradient-to-br from-indigo-600/30 to-purple-600/30 border border-white/10 grid place-items-center shadow-lg shadow-indigo-900/20">
              <span id="brandBadge" class="font-extrabold tracking-wide text-indigo-400 text-xs">DLX</span>
            </div>
            <div>
              <div class="text-sm font-bold tracking-tight text-white">Dashboard</div>
              <div class="text-[10px] text-white/40 font-medium">Management Console</div>
            </div>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto thin-scroll p-3 space-y-6">
          
          <div>
            <div class="text-[9px] uppercase tracking-widest text-white/30 font-bold mb-2 pl-1">Display Mode</div>
            <div class="space-y-1">
              <button class="navbtn active group flex items-center gap-2" data-view="overview" onclick="setView('overview')">
                <svg class="w-3.5 h-3.5 opacity-60 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                Overview
              </button>
              <button class="navbtn group flex items-center gap-2" data-view="drivers" onclick="setView('drivers')">
                 <svg class="w-3.5 h-3.5 opacity-60 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                 Drivers
              </button>
            </div>
          </div>

          <div>
            <div class="flex items-center justify-between mb-2 pl-1">
              <div class="text-[9px] uppercase tracking-widest text-white/30 font-bold">Filter Scope</div>
              <div class="text-[9px] text-white/20" id="regionCountLabel">...</div>
            </div>
            
            <div id="regionListContainer" class="space-y-1">
                </div>
          </div>

        </div>

        <div class="p-3 border-t border-white/5 bg-black/30">
          <div class="text-[9px] text-white/30 mb-2 truncate" id="lastSyncLabel">Waiting for sync...</div>
          <div class="flex gap-2">
            <button id="refreshBtn" onclick="forceSync()" class="flex-1 rounded bg-white/5 border border-white/10 py-1.5 text-[10px] font-semibold text-white/70 hover:bg-white/10 hover:text-white transition">SYNC ALL</button>
            <button id="exportBtn" onclick="exportData()" class="flex-1 rounded bg-white/5 border border-white/10 py-1.5 text-[10px] font-semibold text-white/70 hover:bg-white/10 hover:text-white transition">EXPORT</button>
          </div>
        </div>
      </aside>

      <section class="flex-1 flex flex-col h-full relative overflow-hidden bg-black/20">
        <div class="p-4 border-b border-white/10 flex-shrink-0 z-10 bg-[#0a0a0a]/80 backdrop-blur-md">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <div id="dashTitle" class="text-lg font-bold tracking-tight text-white">Performance</div>
              <div id="activeContextLabel" class="text-xs font-medium text-indigo-400 mt-0.5 flex items-center gap-2">Global • Overview</div>
            </div>
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2">
                <div class="text-[10px] uppercase tracking-widest text-white/30 font-bold">Data</div>
                <button id="dataToggleBtn" onclick="toggleDataSource()"
                  class="bg-white/5 border border-white/10 text-white/80 text-[11px] font-semibold rounded-lg px-3 py-1 hover:bg-white/10 transition focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
                  <span id="dataToggleLabel">DLX</span>
                </button>
              </div>

              <button id="kpiCycleBtn" onclick="cycleKpiMode()" class="cycle-btn shadow-lg shadow-indigo-500/10">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                <span id="kpiCycleLabel">Weekly View</span>
              </button>
            </div>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto thin-scroll p-4 scroll-smooth">

          <div id="view-overview" class="view-container pb-10 space-y-3">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
              <div class="card rounded-2xl p-4 relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/10 rounded-full blur-2xl group-hover:bg-blue-500/20 transition"></div>
                <div class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1">Total Revenue</div>
                <div id="kpiRevenue" class="text-2xl font-bold text-white tracking-tight">—</div>
                <div id="kpiRevenueLabel" class="text-[10px] text-white/30 mt-0.5">Current Week</div>
              </div>
              <div class="card rounded-2xl p-4 relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/10 rounded-full blur-2xl group-hover:bg-emerald-500/20 transition"></div>
                <div class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1">Net Margin ($)</div>
                <div id="kpiMargin" class="text-2xl font-bold tracking-tight text-white">—</div>
                <div id="kpiMarginLabel" class="text-[10px] text-white/30 mt-0.5 truncate">Profit</div>
              </div>
              <div class="card rounded-2xl p-4 relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-indigo-500/10 rounded-full blur-2xl group-hover:bg-indigo-500/20 transition"></div>
                <div class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1">Margin (%)</div>
                <div id="kpiPctMargin" class="text-2xl font-bold text-white tracking-tight">—</div>
                <div id="kpiPctMarginLabel" class="text-[10px] text-white/30 mt-0.5 truncate">Efficiency</div>
              </div>
              <div class="card rounded-2xl p-4 relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-purple-500/10 rounded-full blur-2xl group-hover:bg-purple-500/20 transition"></div>
                <div class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1">Projected Annual</div>
                <div class="mt-1">
                   <div id="kpiProjected" class="text-2xl font-bold text-indigo-300 tracking-tight bg-indigo-500/15 border border-indigo-500/20 inline-block px-3 py-0.5 rounded-lg shadow-[0_0_15px_rgba(99,102,241,0.2)]">—</div>
                </div>
                <div id="kpiProjectedLabel" class="text-[10px] text-white/30 mt-1 truncate">Run Rate</div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
              <div class="card rounded-2xl p-5 lg:col-span-2 flex flex-col">
                <div class="flex flex-wrap items-end justify-between mb-4">
                   <div class="flex items-end gap-3">
                      <div>
                         <h3 class="text-xs font-bold text-white/50 uppercase tracking-widest mb-1">Trend Analysis</h3>
                         <h4 id="trendBigNumber" class="text-3xl font-bold text-white leading-none">$0</h4>
                      </div>
                      <div id="trendPercent" class="text-sm font-bold mb-0.5 text-white/50">—%</div>
                   </div>
                   <div class="flex gap-1 bg-white/5 p-0.5 rounded-lg">
                      <button class="chart-toggle active" id="btnTrendPct" onclick="setTrendMode('pct')">Margin %</button>
                      <button class="chart-toggle" id="btnTrendNet" onclick="setTrendMode('net')">Net $</button>
                      <button class="chart-toggle" id="btnTrendRev" onclick="setTrendMode('rev')">Rev $</button>
                   </div>
                </div>
                <div class="relative flex-1 min-h-[250px]">
                  <canvas id="trendChart"></canvas>
                </div>
              </div>

              <div class="card rounded-2xl p-0 flex flex-col overflow-hidden h-[380px]">
                <div class="p-3 border-b border-white/5 bg-white/5 flex flex-col gap-2">
                  <div class="flex justify-between items-center">
                    <div class="text-xs font-bold text-white">Breakdown</div>
                    <div id="perfPeriodLabel" class="text-[10px] text-white/40">Viewed Period</div>
                  </div>
                  <div class="flex gap-4 mt-1">
                    <button id="tabDrivers" class="tab-btn active" onclick="switchBreakdownTab('drivers')">Top Drivers</button>
                    <button id="tabAreas" class="tab-btn" onclick="switchBreakdownTab('areas')">By Area</button>
                  </div>
                </div>
                
                <div class="flex-1 relative overflow-hidden">
                    <div id="tabContentDrivers" class="absolute inset-0 overflow-y-auto thin-scroll p-3">
                        <div class="text-[9px] uppercase tracking-widest text-emerald-400 font-bold mb-2">Top 10 Performers</div>
                        <div id="topDriversList" class="space-y-1 mb-4"></div>
                        <div class="text-[9px] uppercase tracking-widest text-rose-400 font-bold mb-2">Bottom 10 Performers</div>
                        <div id="bottomDriversList" class="space-y-1"></div>
                    </div>
                    <div id="tabContentAreas" class="absolute inset-0 p-3 hidden">
                        <canvas id="areaBreakdownChart"></canvas>
                    </div>
                </div>
              </div>
            </div>

            <div class="card rounded-2xl p-0 overflow-hidden flex flex-col max-h-[500px]">
              <div class="p-3 border-b border-white/5 flex justify-between items-center bg-white/5">
                <div class="font-bold text-xs">History</div>
                <div class="text-[10px] text-white/40">Full Record</div>
              </div>
              <div class="thin-scroll overflow-y-auto flex-1">
                <table class="w-full text-left text-xs border-collapse">
                  <thead class="sticky top-0 bg-[#121212] text-white/40 uppercase tracking-wider z-10 shadow-lg font-semibold">
                    <tr><th class="py-3 px-4">Period</th><th class="py-3 px-4">% Margin</th><th class="py-3 px-4">Revenue</th><th class="py-3 px-4">TL Exp</th><th class="py-3 px-4">Margin</th><th class="py-3 px-4">Signal</th></tr>
                  </thead>
                  <tbody id="lossTableBody" class="divide-y divide-white/5 text-white/80 font-mono"></tbody>
                </table>
              </div>
            </div>
          </div> 

          <div id="view-drivers" class="view-hidden hiddenView pb-10">
            <div id="driverTopPerformer" class="mb-3"></div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-3 h-full">
              <div class="card rounded-2xl p-0 overflow-hidden flex flex-col max-h-[75vh]">
                <div class="p-3 border-b border-white/5 bg-white/5">
                  <div class="font-bold text-xs">Driver History</div>
                  <div class="text-[10px] text-white/40">Aggregated Performance</div>
                </div>
                <div class="thin-scroll overflow-y-auto flex-1">
                  <table class="w-full text-left text-xs">
                    <thead class="sticky top-0 bg-[#121212] text-white/40 uppercase tracking-wider z-10">
                      <tr><th class="py-2 px-4">Week</th><th class="py-2 px-4">% Margin</th><th class="py-2 px-4">Revenue</th><th class="py-2 px-4">Margin</th><th class="py-2 px-4">Hours</th></tr>
                    </thead>
                    <tbody id="driverWeeklyBody" class="divide-y divide-white/5 text-white/80 font-mono"></tbody>
                  </table>
                </div>
              </div>
              <div class="card rounded-2xl p-0 overflow-hidden flex flex-col h-auto">
                <div class="p-3 border-b border-white/5 bg-white/5">
                  <div class="font-bold text-xs">Region Breakdown</div>
                  <div class="text-[10px] text-white/40">Latest Active Week</div>
                </div>
                <div class="thin-scroll overflow-y-auto flex-1">
                  <table class="w-full text-left text-xs">
                    <thead class="sticky top-0 bg-[#121212] text-white/40 uppercase tracking-wider z-10">
                      <tr><th class="py-2 px-4">Region</th><th class="py-2 px-4">Revenue</th><th class="py-2 px-4">Margin</th><th class="py-2 px-4">Hours</th></tr>
                    </thead>
                    <tbody id="driverRegionBody" class="divide-y divide-white/5 text-white/80 font-mono"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div> 
      </section>
    </div>
  </div>

<script>
  Chart.register(ChartDataLabels); 

  const WORKER_URL_DLX = "https://withered-king-c48e.haildir12121.workers.dev/";
  const WORKER_URL_DMT = "https://spring-grass-bbc2.haildir12121.workers.dev/";

  const DATA_SOURCES = {
    DLX: { key: "DLX", label: "DLX", workerUrl: WORKER_URL_DLX },
    DMT: { key: "DMT", label: "DMT", workerUrl: WORKER_URL_DMT }
  };

  const SCHEMAS = {
    DLX: {
      dataHeaderRowIndex0: 2, dateCol: "D",
      areas: [
        { id: "CST",   name: "Coast",    start: "E",  end: "O" },
        { id: "RBG",   name: "Roseburg", start: "P",  end: "Z" },
        { id: "EUG",   name: "Eugene",   start: "AA", end: "AK" },
        { id: "OKRDG", name: "Oakridge", start: "AL", end: "AV" },
        { id: "ALBNY", name: "Albany",   start: "AW", end: "BG" },
        { id: "DMT",   name: "DMT",      start: "BR", end: "CB" }
      ],
      offsets: { driver:0, hours:1, payroll:2, fuel:3, insurance:4, maintenance:5, totalExp:7, revenue:8, margin:9 }
    },
    DMT: {
      dataHeaderRowIndex0: 2, dateCol: "D",
      areas: [
        { id: "CST",   name: "Coast-DMT",  start: "E",  end: "N" },
        { id: "RBG",   name: "Roseburg-DMT", start: "P",  end: "Y" },
        { id: "EUG",   name: "Eugene DMT", start: "AA", end: "AJ" },
        { id: "NV",    name: "Nevada",     start: "AL", end: "AU" },
        { id: "ALBNY", name: "Albany/Salem", start: "AW", end: "BF" },
        { id: "PDX",   name: "Portland",   start: "BG", end: "BP" },
        { id: "STR",   name: "Stretcher",  start: "BR", end: "CA" }
      ],
      offsets: { driver:0, hours:1, payroll:2, fuel:3, insurance:4, maintenance:5, totalExp:7, revenue:8, margin:9 }
    }
  };

  const COLMAPS = {
    DLX: { weekStart: "P", weekEnd: "Q", revenue: "Z", totalExp: "Y", margin: "AA", pctMargin: "AB", driverCount: "R", hoursWorked: "S" }
  };

  const REGION_LABELS = { 
    CST: "Coast", RBG: "Roseburg", EUG: "Eugene", OKRDG: "Oakridge", ALBNY: "Albany", DMT: "DMT", 
    NV: "Nevada", PDX: "Portland", STR: "Stretcher" 
  };

  // GLOBAL STATE
  let activeDataSourceKey = localStorage.getItem("dash_data_source") || "DLX";
  let activeRegionId = "ALL"; 
  let activeView = "overview";
  let activeDriver = "";
  
  const dataStore = {
    DLX: { loaded: false, REGION_SHEETS: [], regionSeries: {}, driverIndex: {} },
    DMT: { loaded: false, REGION_SHEETS: [], regionSeries: {}, driverIndex: {} }
  };
  
  let regionSeries = {}; 
  let driverIndex = {}; 
  let weekly = []; 
  let driverWeekly = [];     

  let trendChart = null; 
  let areaBreakdownChart = null;
  let trendMode = "pct"; 
  let kpiMode = "week"; 

  function fmtUSD(n){ return Number(n||0).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}); }
  function safeNum(v){ if(typeof v === 'number') return isFinite(v)?v:0; const s = String(v).replace(/[^0-9.\-]/g,""); const n = parseFloat(s); return isFinite(n)?n:0; }
  function colToIndex(col){ let n=0; const s=String(col).toUpperCase().trim(); for(let i=0;i<s.length;i++) n=n*26+(s.charCodeAt(i)-64); return n-1; }
  
  // FIX: Force UTC parsing for all dates to avoid timezone dropout
  function asDate(v) {
    if (v instanceof Date && !isNaN(v)) return v;
    if (typeof v === "number" && isFinite(v)) {
      // Excel serial date to JS Date (UTC)
      const utcDays = Math.floor(v - 25569);
      return new Date(utcDays * 86400 * 1000);
    }
    if (typeof v === "string") {
        // Attempt to parse string. If it's "MM/DD/YYYY", force it to be UTC 00:00
        const d = new Date(v);
        if (isNaN(d.getTime())) return null;
        // Adjust for timezone offset to effectively "shift" local time to UTC 00:00
        return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    }
    return null;
  }

  function normalizeDate(d) { if(!d) return null; const date = new Date(d); date.setHours(0,0,0,0); const day = date.getDay(); const diff = date.getDate() - day + (day === 0 ? -6 : 1); return new Date(date.setDate(diff)); }
  function niceDate(v){ const d = asDate(v); return d ? `${d.getUTCMonth()+1}/${d.getUTCDate()}/${d.getUTCFullYear()}` : ""; } 
  function sortWeeksDesc(arr){ return (arr||[]).slice().sort((a,b)=> { const da = asDate(a.weekEnd); const db = asDate(b.weekEnd); return (db?db.getTime():0) - (da?da.getTime():0); }); }

  function parseRegionSheet(ws){ 
    const map = COLMAPS.DLX;
    const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" }); 
    const idx = {}; for (const [k, col] of Object.entries(map)) idx[k] = colToIndex(col); 
    let headerRow = 2; 
    for (let r=0; r<Math.min(100, aoa.length); r++){ const row = aoa[r]||[]; if(String(row[idx.pctMargin]||"").includes("%")) { headerRow=r; break; } } 
    const out = []; 
    for (let r = headerRow + 1; r < aoa.length; r++){ 
      const row = aoa[r] || []; 
      const wsVal = row[idx.weekStart]; 
      if (!wsVal) continue; 
      const dObj = normalizeDate(asDate(wsVal));
      const revenue = safeNum(row[idx.revenue]); 
      const totalExp = safeNum(row[idx.totalExp]); 
      if(Math.abs(revenue)<1 && Math.abs(totalExp)<1) continue; 
      let pm = safeNum(row[idx.pctMargin]);
      if(pm <= 1.5 && pm >= -1.5) pm = pm * 100;
      out.push({ weekStart: dObj, weekEnd: asDate(row[idx.weekEnd]), revenue, totalExp, margin: safeNum(row[idx.margin]), pctMargin: pm }); 
    } 
    return sortWeeksDesc(out); 
  }

  function parseRunningSheet(ws, sourceKey){ 
    const schema = SCHEMAS[sourceKey];
    const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" }); 
    const headerRow = schema.dataHeaderRowIndex0; 
    const dateColIdx = colToIndex(schema.dateCol); 
    const areas = schema.areas.map(a => ({...a, startIdx: colToIndex(a.start)})); 
    for (const a of areas) { a.driverColIdx = a.startIdx; for (let c = a.startIdx; c <= colToIndex(a.end); c++) { if (String(aoa[headerRow]?.[c]||"").toLowerCase().trim() === "driver") { a.driverColIdx = c; break; } } } 
    const out = {}; 
    for (let r = headerRow + 1; r < aoa.length; r++){ 
      const row = aoa[r] || []; 
      const d = asDate(row[dateColIdx]); // Now uses force-UTC logic
      if (!d) continue; 
      for (const a of areas){ 
        const base = a.driverColIdx; 
        const name = String(row[base + schema.offsets.driver] || "").trim(); 
        if (!name) continue; 
        const revenue = safeNum(row[base + schema.offsets.revenue]); 
        if (Math.abs(revenue)<0.1) continue; 
        if (!out[name]) out[name] = { rows: [] }; 
        out[name].rows.push({ date: d, region: a.name, regionId: a.id, revenue, margin: safeNum(row[base + schema.offsets.margin]), hours: safeNum(row[base + schema.offsets.hours]) }); 
      } 
    } 
    return out; 
  }

  function sumRegionsByWeek(seriesById){ const map = new Map(); for (const [id, series] of Object.entries(seriesById)){ if (id === "ALL") continue; for (const w of series){ const key = w.weekStart.getTime(); const cur = map.get(key) || { weekStart: w.weekStart, weekEnd: w.weekEnd, revenue:0, totalExp:0, margin:0 }; cur.revenue += w.revenue; cur.totalExp += w.totalExp; cur.margin += w.margin; map.set(key, cur); } } const all = Array.from(map.values()); for(const w of all) w.pctMargin = w.revenue?((w.revenue-w.totalExp)/w.revenue)*100:0; return sortWeeksDesc(all); }
  function getDriverWeekly(driverName){ const rows = driverIndex[driverName]?.rows || []; const map = new Map(); for (const r of rows){ const dt = normalizeDate(r.date); const key = dt.getTime(); const cur = map.get(key) || { weekStart: dt, revenue:0, margin:0, hoursWorked:0 }; cur.revenue += r.revenue; cur.margin += r.margin; cur.hoursWorked += r.hours; map.set(key, cur); } const out = sortWeeksDesc(Array.from(map.values())); for(const w of out) w.pctMargin = w.revenue?(w.margin/w.revenue)*100:0; return out; }

  function aggregateRunningSheetToRegionSeries(dIndex, sourceKey) {
      const rs = {};
      const schema = SCHEMAS[sourceKey];
      schema.areas.forEach(a => rs[a.id] = []);
      const regionMaps = {}; 
      Object.values(dIndex).forEach(driver => {
          driver.rows.forEach(row => {
              if(!regionMaps[row.regionId]) regionMaps[row.regionId] = new Map();
              const ws = normalizeDate(row.date);
              const key = ws.getTime();
              const cur = regionMaps[row.regionId].get(key) || { weekStart: ws, weekEnd: new Date(ws.getTime() + 6*86400000), revenue:0, margin:0, totalExp:0 };
              cur.revenue += row.revenue; cur.margin += row.margin; cur.totalExp += (row.revenue - row.margin); 
              regionMaps[row.regionId].set(key, cur);
          });
      });
      Object.keys(regionMaps).forEach(rid => {
          const arr = Array.from(regionMaps[rid].values());
          arr.forEach(w => w.pctMargin = w.revenue ? (w.margin/w.revenue)*100 : 0);
          rs[rid] = sortWeeksDesc(arr);
      });
      return rs;
  }

  async function forceSync() {
    document.getElementById("lastSyncLabel").textContent = "Syncing all sources...";
    await Promise.all([fetchDataForSource("DLX"), fetchDataForSource("DMT")]);
    document.getElementById("lastSyncLabel").textContent = "Synced: " + new Date().toLocaleTimeString();
    switchDataSourceDisplay(activeDataSourceKey);
  }
  
  async function fetchDataForSource(key) {
    try {
        const res = await fetch(DATA_SOURCES[key].workerUrl, {cache:"no-store"});
        const buf = await res.arrayBuffer();
        const wb = XLSX.read(buf, {type:"array"});
        const runWs = wb.Sheets["Running Sheet"];
        const dIndex = runWs ? parseRunningSheet(runWs, key) : {};

        let rs = {};
        let regionSheets = [];

        if (key === "DLX") {
            regionSheets = buildRegionSheetsFromWorkbook(wb, key);
            for(const r of regionSheets) {
                if(r.id==="ALL") continue;
                const ws = wb.Sheets[r.sheet];
                rs[r.id] = ws ? parseRegionSheet(ws) : [];
            }
            rs["ALL"] = sumRegionsByWeek(rs);
        } else {
            rs = aggregateRunningSheetToRegionSeries(dIndex, key);
            rs["ALL"] = sumRegionsByWeek(rs);
            regionSheets = SCHEMAS.DMT.areas.map(a => ({ id: a.id, name: a.name, sheet: null }));
            regionSheets.unshift({id:"ALL", name:"All Regions", sheet:null});
        }
        
        dataStore[key].REGION_SHEETS = regionSheets;
        dataStore[key].regionSeries = rs;
        dataStore[key].driverIndex = dIndex;
        dataStore[key].loaded = true;
    } catch(e) { console.error(e); dataStore[key].loaded = false; }
  }

  function buildRegionSheetsFromWorkbook(wb, key){
      if(key === "DMT") return [];
      const wklySheets = (wb.SheetNames||[]).filter(n => /\.Wkly$/i.test(n));
      const preferred = ["CST","EUG","RBG","OKRDG","ALBNY","DMT","NV","PDX"];
      const out = [{id:"ALL", name:"All Regions", sheet:null}];
      preferred.forEach(p => { if(wklySheets.find(n=>n.toUpperCase().includes(p))) out.push({id:p, name:REGION_LABELS[p]||p, sheet:wklySheets.find(n=>n.toUpperCase().includes(p))}); });
      return out;
  }

  window.toggleDataSource = function() { switchDataSourceDisplay(activeDataSourceKey === "DLX" ? "DMT" : "DLX"); };
  
  function switchDataSourceDisplay(key) {
      activeDataSourceKey = key; localStorage.setItem("dash_data_source", key);
      document.getElementById("dataToggleLabel").textContent = key; document.getElementById("brandBadge").textContent = key; document.title = `NEMT Dashboard — ${key}`;
      activeRegionId = "ALL"; activeDriver = "";
      if (dataStore[key].loaded) { regionSeries = dataStore[key].regionSeries; driverIndex = dataStore[key].driverIndex; window.REGION_SHEETS = dataStore[key].REGION_SHEETS; applyData(); } 
      else { fetchDataForSource(key).then(() => switchDataSourceDisplay(key)); }
  }

  function applyData() {
      if(activeDriver) driverWeekly = getDriverWeekly(activeDriver);
      else weekly = sortWeeksDesc(regionSeries[activeRegionId] || []);
      renderRegionList();
      if(activeView === "overview") renderOverview();
      updateContextLabel();
  }

  function renderRegionList(){
    const sheets = dataStore[activeDataSourceKey].REGION_SHEETS || [];
    const container = document.getElementById("regionListContainer"); container.innerHTML = ""; 
    document.getElementById("regionCountLabel").textContent = `${Math.max(0, sheets.length - 1)} Regions`;
    const isAll = (activeRegionId === "ALL");
    const allBtn = document.createElement("button"); allBtn.className = `region-btn ${isAll ? 'active' : ''}`; allBtn.onclick = () => selectRegion("ALL"); allBtn.innerHTML = `<span>View All</span><span class="text-[10px] opacity-50">Global</span>`; container.appendChild(allBtn);
    sheets.forEach(r => { if(r.id === "ALL") return; const isActive = (activeRegionId === r.id); const btn = document.createElement("button"); btn.className = `region-btn ${isActive ? 'active' : ''}`; btn.onclick = () => selectRegion(r.id); btn.innerHTML = `<span>${r.name}</span><svg class="w-3 h-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>`; container.appendChild(btn); });
  }

  function renderOverview(){
    if(!weekly.length) return;
    const latestDate = asDate(weekly[0].weekEnd);
    // Use UTC for anchor date calculations to avoid timezone shifts (e.g. Dec 31 vs Jan 1)
    const y = latestDate.getUTCFullYear(); 
    const m = latestDate.getUTCMonth(); 
    const q = Math.floor(m/3);
    
    let startTime, endTime, prevStartTime, prevEndDate, label;
    let isBarChart = false;
    let curr = {}, prev = {};
    let runRate = 0;

    if (kpiMode === 'week') {
        const w0 = weekly[0];
        const w1 = weekly[1] || { revenue:0, margin:0, pctMargin:0 };
        curr = { rev: w0.revenue, marg: w0.margin, pct: w0.pctMargin };
        prev = { rev: w1.revenue, marg: w1.margin, pct: w1.pctMargin };
        startTime = asDate(w0.weekStart).getTime(); endTime = asDate(w0.weekEnd).getTime();
        label = "Current Week";
        runRate = curr.marg * 52;
    } else {
        if (kpiMode.includes('q')) {
            isBarChart = true; 
            const targetQ = kpiMode === 'this_q' ? q : q-1;
            const targetY = kpiMode === 'last_q' && targetQ < 0 ? y-1 : y;
            const finalQ = targetQ < 0 ? 3 : targetQ;
            // Use UTC dates for filtering to match Excel serial dates
            startTime = Date.UTC(targetY, finalQ * 3, 1); 
            endTime = Date.UTC(targetY, (finalQ * 3) + 3, 0, 23, 59, 59);
            
            prevStartTime = Date.UTC(targetY, (finalQ-1)*3, 1); 
            prevEndTime = Date.UTC(targetY, ((finalQ-1)*3)+3, 0, 23, 59, 59);
            if(finalQ-1 < 0) { 
                prevStartTime = Date.UTC(targetY-1, 9, 1); 
                prevEndTime = Date.UTC(targetY-1, 12, 0, 23, 59, 59); 
            }
            label = kpiMode === 'this_q' ? "QTD" : "Last Qtr";
        } else { 
            isBarChart = true;
            const targetY = kpiMode === 'this_y' ? y : y-1;
            startTime = Date.UTC(targetY, 0, 1); 
            endTime = Date.UTC(targetY, 11, 31, 23, 59, 59);
            
            prevStartTime = Date.UTC(targetY-1, 0, 1); 
            prevEndTime = Date.UTC(targetY-1, 11, 31, 23, 59, 59);
            label = kpiMode === 'this_y' ? "YTD" : "Last Year";
        }

        const getStats = (s, e) => {
            let rev=0, marg=0, count=0;
            weekly.forEach(w => {
                const t = asDate(w.weekEnd).getTime();
                // Add buffer for potential ms misalignment
                if (t >= s && t <= e + 1000) { 
                    rev+=w.revenue; marg+=w.margin; count++;
                }
            });
            return { rev, marg, pct: rev? (marg/rev)*100 : 0, count };
        };
        curr = getStats(startTime, endTime);
        prev = getStats(prevStartTime, prevEndTime);

        // Run Rate Logic
        if (kpiMode === 'this_y') {
             runRate = curr.count > 0 ? (curr.marg / curr.count) * 52 : 0;
        } else if (kpiMode === 'this_q') {
             runRate = curr.count > 0 ? (curr.marg / curr.count) * 13 : 0;
        } else {
             runRate = curr.marg;
        }
    }

    document.getElementById("kpiRevenue").textContent = fmtUSD(curr.rev);
    document.getElementById("kpiRevenueLabel").textContent = label + " Revenue";
    document.getElementById("kpiMargin").textContent = fmtUSD(curr.marg);
    const margDiff = curr.marg - prev.marg;
    document.getElementById("kpiMarginLabel").innerHTML = `<span class="${margDiff>=0?'text-emerald-400':'text-rose-400'}">${margDiff>=0?'▲':'▼'} ${fmtUSD(Math.abs(margDiff))}</span> <span class="text-white/30">vs prior</span>`;
    document.getElementById("kpiPctMargin").textContent = curr.pct.toFixed(1) + "%";
    const pctDiff = curr.pct - prev.pct;
    document.getElementById("kpiPctMarginLabel").innerHTML = `<span class="${pctDiff>=0?'text-emerald-400':'text-rose-400'}">${pctDiff>=0?'▲':'▼'} ${Math.abs(pctDiff).toFixed(1)}%</span> <span class="text-white/30">pts vs prior</span>`;
    
    document.getElementById("kpiProjected").textContent = fmtUSD(runRate);
    document.getElementById("kpiProjectedLabel").textContent = (kpiMode.includes('this') || kpiMode === 'week') ? "Est. Annual Run Rate" : "Period Total";

    // Pass timestamps to driver list (add buffer for end time)
    renderTrendChart(isBarChart, startTime, endTime);
    renderAreaBreakdown(startTime, endTime); 
    renderPerformanceList(startTime, endTime + 86400000); // Add buffer for safety
    renderTable();
    updateContextLabel();
  }

  function renderTrendChart(isBar, startDate, endDate){
    const canvas = document.getElementById("trendChart"); 
    if(trendChart) trendChart.destroy();
    let labels=[], data=[];
    
    if(isBar) {
        // Prepare groups
        const groups = {};
        weekly.forEach(w => {
            const d = asDate(w.weekEnd);
            let sortKey = "";
            let displayLabel = "";
            
            // Use UTC methods for chart grouping to align with filters
            if(kpiMode.includes('y')) {
                sortKey = d.getUTCFullYear().toString();
                displayLabel = sortKey;
            } else {
                const q = Math.floor(d.getUTCMonth()/3)+1;
                const yy = d.getUTCFullYear().toString().substr(2);
                sortKey = `${d.getUTCFullYear()}-Q${q}`;
                displayLabel = `Q${q} '${yy}`;
            }
            
            if(!groups[sortKey]) groups[sortKey] = { label: displayLabel, rev:0, marg:0 };
            groups[sortKey].rev += w.revenue; groups[sortKey].marg += w.margin;
        });

        // 1. SORT CHRONOLOGICALLY (ASCENDING) -> Oldest First
        let sortedKeys = Object.keys(groups).sort(); 
        
        // 2. LIMIT TO LAST 8 QUARTERS if in quarterly mode
        if (kpiMode.includes('q') && sortedKeys.length > 8) {
            sortedKeys = sortedKeys.slice(sortedKeys.length - 8);
        }

        labels = sortedKeys.map(k => groups[k].label);
        data = sortedKeys.map(k => trendMode==='pct' ? (groups[k].marg/groups[k].rev)*100 : (trendMode==='rev'?groups[k].rev:groups[k].marg));
    } else {
        const subset = weekly.slice(0, 16).reverse(); 
        labels = subset.map(w => niceDate(w.weekEnd));
        data = subset.map(w => trendMode==='pct' ? w.pctMargin : (trendMode==='rev'?w.revenue:w.margin));
    }

    const ctx = canvas.getContext("2d");
    const color = trendMode==='pct'?'#818cf8':(trendMode==='net'?'#10b981':'#3b82f6');
    trendChart = new Chart(ctx, {
        type: isBar ? 'bar' : 'line',
        data: { labels, datasets: [{ label: trendMode, data, backgroundColor: isBar ? color : 'rgba(129, 140, 248, 0.1)', borderColor: color, borderWidth: 2, tension: 0.3, fill: !isBar }] },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { 
                legend: { display: false }, 
                datalabels: { 
                    color: '#fff', 
                    anchor: isBar ? 'end' : 'top', 
                    align: isBar ? 'top' : 'top', 
                    offset: 8, 
                    font: { size: 10, weight: 'bold' }, 
                    formatter: (v) => trendMode==='pct' ? v.toFixed(1)+'%' : fmtUSD(v) 
                } 
            },
            scales: { x: { grid: { display:false }, ticks: { color:'#64748b', font:{size:10} } }, y: { grid: { color:'rgba(255,255,255,0.05)' }, ticks: { color:'#64748b', font:{size:10} } } },
            layout: { padding: { top: 20 } }
        }
    });
    
    // Big number at top
    const latestVal = data[data.length-1] || 0;
    document.getElementById("trendBigNumber").textContent = trendMode==='pct' ? latestVal.toFixed(1)+'%' : fmtUSD(latestVal);
  }

  function renderAreaBreakdown(startDate, endDate) {
      const canvas = document.getElementById("areaBreakdownChart");
      if(areaBreakdownChart) areaBreakdownChart.destroy();
      const areaMap = {};
      Object.keys(driverIndex).forEach(dName => { driverIndex[dName].rows.forEach(r => { 
          // FIX: Add 6 days to align driver dates (Week Start) to Week End for filtering
          const t = r.date.getTime() + 518400000; 
          if(t >= startDate && t <= endDate) { if(!areaMap[r.region]) areaMap[r.region] = 0; areaMap[r.region] += r.margin; } }); });
      const sorted = Object.entries(areaMap).sort((a,b) => b[1] - a[1]);
      areaBreakdownChart = new Chart(canvas, {
          type: 'bar', indexAxis: 'y',
          data: { labels: sorted.map(x=>x[0]), datasets: [{ data: sorted.map(x=>x[1]), backgroundColor: sorted.map(x=>x[1]>=0?'#10b981':'#f43f5e'), borderRadius: 4 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { color: '#fff', anchor: 'end', align: 'end', offset: 0, font: { size: 9 }, formatter: (v) => fmtUSD(v) } }, scales: { x: { display: false }, y: { ticks: { color: '#e2e8f0', font: { size: 10 } }, grid: { display: false } } }, layout: { padding: { right: 40 } } }
      });
  }

  function switchBreakdownTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(tab==='drivers'?'tabDrivers':'tabAreas').classList.add('active');
      document.getElementById('tabContentDrivers').classList.toggle('hidden', tab!=='drivers');
      document.getElementById('tabContentAreas').classList.toggle('hidden', tab!=='areas');
  }

  function renderPerformanceList(s, e){
      const topDiv = document.getElementById("topDriversList"); topDiv.innerHTML = "";
      const botDiv = document.getElementById("bottomDriversList"); botDiv.innerHTML = "";
      const perf = {};
      Object.keys(driverIndex).forEach(d => { 
          driverIndex[d].rows.forEach(r => { 
              // FIX: Add 6 days to align driver dates (Week Start) to Week End for filtering
              const t = r.date.getTime() + 518400000;
              // Check bounds (inclusive)
              if(t >= s && t <= e && (activeRegionId==='ALL' || r.regionId===activeRegionId)) { 
                  if(!perf[d]) perf[d]=0; perf[d]+=r.margin; 
              } 
          }); 
      });
      const sorted = Object.entries(perf).sort((a,b) => b[1] - a[1]);
      if(!sorted.length) { topDiv.innerHTML = "<div class='text-white/30 text-[10px]'>No data</div>"; return; }
      const row = (n,v,c) => `<div class="flex justify-between items-center text-[10px] bg-white/5 px-2 py-1 rounded border border-white/5"><span class="text-white/90 truncate w-24">${n}</span><span class="font-bold ${c}">${fmtUSD(v)}</span></div>`;
      sorted.slice(0,10).forEach(x => topDiv.innerHTML += row(x[0], x[1], 'text-emerald-400'));
      sorted.slice(-10).reverse().forEach(x => botDiv.innerHTML += row(x[0], x[1], 'text-rose-400'));
  }

  function renderTable(){ 
      const b = document.getElementById("lossTableBody"); b.innerHTML = "";
      weekly.slice(0,50).forEach(w => {
          const c = w.pctMargin<0?'text-rose-400':w.pctMargin<5?'text-amber-400':'text-emerald-400';
          b.innerHTML += `<tr class="hover:bg-white/5 transition"><td class="py-2 px-4 text-white/90 text-[10px]">${niceDate(w.weekEnd)}</td><td class="py-2 px-4 font-bold ${c}">${w.pctMargin.toFixed(1)}%</td><td class="py-2 px-4 text-white/70">${fmtUSD(w.revenue)}</td><td class="py-2 px-4 text-white/70">${fmtUSD(w.totalExp)}</td><td class="py-2 px-4 text-white/70">${fmtUSD(w.margin)}</td><td class="py-2 px-4 text-[9px] ${c}">${w.pctMargin<0?'CRITICAL':'OK'}</td></tr>`;
      });
  }
  
  function updateContextLabel(){ 
      const el = document.getElementById("activeContextLabel"); 
      const rName = (dataStore[activeDataSourceKey].REGION_SHEETS || []).find(r=>r.id===activeRegionId)?.name || "Global"; 
      el.innerHTML = `<span class="text-indigo-400 font-semibold">${rName}</span> <span class="text-white/30 mx-1">/</span> <span class="text-white">${activeView==='drivers'?'Drivers':'Overview'}</span>`; 
  }
  
  window.cycleKpiMode = function() {
      const modes = ['week', 'this_q', 'last_q', 'this_y', 'last_y'];
      const labels = {'week':'Weekly View', 'this_q':'This Quarter', 'last_q':'Last Quarter', 'this_y':'Year to Date', 'last_y':'Last Year'};
      let idx = modes.indexOf(kpiMode);
      kpiMode = modes[(idx+1)%modes.length];
      document.getElementById("kpiCycleLabel").textContent = labels[kpiMode];
      renderOverview();
  };

  window.setTrendMode = function(m){ trendMode=m; ['pct','net','rev'].forEach(x=>document.getElementById('btnTrend'+x.charAt(0).toUpperCase()+x.slice(1)).classList.toggle('active', x===m)); renderOverview(); };
  window.selectRegion = function(id){ activeRegionId=id; activeDriver=""; applyData(); };
  window.setView = function(v){ activeView=v; document.getElementById("view-overview").classList.toggle("hiddenView", v!=="overview"); document.getElementById("view-drivers").classList.toggle("hiddenView", v!=="drivers"); updateContextLabel(); applyData(); };
  window.exportData = function() { XLSX.writeFile(XLSX.utils.json_to_sheet(weekly), "Dashboard_Export.xlsx"); };

  forceSync();
</script>
</body>
</html>

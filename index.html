<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NEMT Dashboard ‚Äî Dark UI</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    html, body { height:100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* Subtle ‚ÄúBehance-y‚Äù depth without blur/glass */
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 55px rgba(0,0,0,0.45);
    }
    .card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .chip {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .thin-scroll::-webkit-scrollbar{ width:10px; height:10px; }
    .thin-scroll::-webkit-scrollbar-track{ background: rgba(255,255,255,0.04); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.14); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,0.20); }

    .bggrid{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,0.20), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(34,211,238,0.12), transparent 55%),
        radial-gradient(900px 550px at 50% 110%, rgba(236,72,153,0.10), transparent 60%),
        linear-gradient(180deg, #070812 0%, #05060d 60%, #04050a 100%);
    }

    /* FIX: Force calendar icon to be white in dark mode */
    input[type="date"]::-webkit-calendar-picker-indicator {
        filter: invert(1);
        cursor: pointer;
        opacity: 0.6;
    }
    input[type="date"]::-webkit-calendar-picker-indicator:hover {
        opacity: 1;
    }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: { 950:"#04050a", 900:"#070812", 850:"#0b0d16", 800:"#101426" },
            soft: { 100:"rgba(255,255,255,0.08)", 200:"rgba(255,255,255,0.12)" }
          }
        }
      }
    }
  </script>
</head>

<body class="bggrid text-white">
  <div class="mx-auto max-w-[1500px] px-4 py-6">
    <div class="panel rounded-3xl overflow-hidden">
      <div class="grid grid-cols-1 lg:grid-cols-12 min-h-[86vh]">
        <aside class="lg:col-span-3 border-b lg:border-b-0 lg:border-r border-white/10 bg-black/20">
          <div class="p-5">
            <div class="flex items-center gap-3">
              <div class="h-11 w-11 rounded-2xl bg-white/10 border border-white/10 grid place-items-center">
                <span class="font-extrabold tracking-wide">DLX</span>
              </div>
              <div>
                <div class="text-base font-semibold tracking-tight">Dashboard</div>
                <div class="text-xs text-white/60">NEMT weekly performance</div>
              </div>
            </div>

            <div class="mt-5 space-y-2 text-sm">
              <button class="w-full text-left px-3 py-2 rounded-xl bg-white/8 border border-white/10">
                <div class="flex items-center justify-between">
                  <span class="font-semibold">Overview</span>
                  <span class="text-[11px] text-white/70">Live</span>
                </div>
              </button>

              <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 border border-transparent hover:border-white/10 transition">
                Analytics
              </button>
              <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 border border-transparent hover:border-white/10 transition">
                Regions
              </button>
              <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 border border-transparent hover:border-white/10 transition">
                Loss Areas
              </button>
            </div>

            <div class="mt-6">
              <div class="text-xs text-white/60 mb-2">Regions</div>

              <div class="card rounded-2xl p-2">
                <input id="regionFilter" class="w-full bg-transparent outline-none px-2 py-2 text-sm placeholder:text-white/35"
                       placeholder="Filter regions‚Ä¶" />
              </div>

              <div id="regionList" class="mt-3 grid grid-cols-1 gap-2"></div>
            </div>

            <div class="mt-6 card rounded-2xl p-4">
              <div class="text-xs text-white/60">Status</div>
              <div id="statusLabel" class="text-xs text-white/80 mt-2">Status: ‚Äî</div>
              <div id="lastSyncLabel" class="text-xs text-white/55 mt-1">Last sync: ‚Äî</div>
              <div id="weekLabel" class="text-xs text-white/55 mt-1">Week: ‚Äî</div>

              <div class="mt-3 flex gap-2">
                <button id="refreshBtn" class="flex-1 rounded-xl px-3 py-2 text-sm bg-white/8 border border-white/10 hover:bg-white/12 transition">
                  Refresh
                </button>
                <button id="exportBtn" class="flex-1 rounded-xl px-3 py-2 text-sm bg-white/8 border border-white/10 hover:bg-white/12 transition">
                  Export
                </button>
              </div>
            </div>
          </div>
        </aside>

        <section class="lg:col-span-9">
          <div class="p-5 border-b border-white/10">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
              <div>
                <div id="dashTitle" class="text-xl font-semibold tracking-tight">DLX/DMT Weekly Dashboard</div>
                <div id="dashSubtitle" class="text-sm text-white/55 mt-1">Overhead ‚Ä¢ Revenue ‚Ä¢ Margin ‚Ä¢ Regional breakdown</div>
              </div>

              <div class="flex items-center gap-2">
                <div class="card rounded-2xl px-3 py-2 flex items-center gap-2 w-[320px] max-w-full">
                  <span class="text-white/50 text-sm">üìÖ</span>
                  <input type="date" id="searchInput" class="bg-transparent outline-none w-full text-sm placeholder:text-white/35 text-white/90 [color-scheme:dark]" />
                </div>
                <div id="activeRegionPill" class="chip rounded-2xl px-3 py-2 text-sm font-semibold">ALL</div>
              </div>
            </div>
          </div>

          <div class="p-5 space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-white/60">Revenue</div>
                  <div class="chip rounded-xl px-2 py-1 text-[11px]">Week</div>
                </div>
                <div id="kpiRevenue" class="mt-2 text-3xl font-extrabold tracking-tight">‚Äî</div>
                <div class="mt-1 text-xs text-white/55">Gross</div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-white/60">Total Expense</div>
                  <div class="chip rounded-xl px-2 py-1 text-[11px]">TL Exp</div>
                </div>
                <div id="kpiExpense" class="mt-2 text-3xl font-extrabold tracking-tight">‚Äî</div>
                <div id="kpiExpenseSub" class="mt-1 text-xs text-white/55">‚Äî</div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-white/60">Margin</div>
                  <div class="chip rounded-xl px-2 py-1 text-[11px]">Net</div>
                </div>
                <div id="kpiMargin" class="mt-2 text-3xl font-extrabold tracking-tight">‚Äî</div>
                <div id="kpiMarginSub" class="mt-1 text-xs text-white/55">‚Äî</div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-white/60">Drivers</div>
                  <div class="chip rounded-xl px-2 py-1 text-[11px]">Count</div>
                </div>
                <div id="kpiDrivers" class="mt-2 text-3xl font-extrabold tracking-tight">‚Äî</div>
                <div id="kpiDriversSub" class="mt-1 text-xs text-white/55">‚Äî</div>
              </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
              <div class="card rounded-3xl p-4 xl:col-span-2">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-sm font-semibold">Margin Trend</div>
                    <div class="text-xs text-white/55 mt-1">Most recent weeks (chart shows oldest ‚Üí newest)</div>
                  </div>
                  <button id="toggleBaseline" class="chip rounded-2xl px-3 py-2 text-sm hover:bg-white/10 transition">
                    Toggle baseline
                  </button>
                </div>
                <div class="mt-3 bg-black/25 border border-white/10 rounded-2xl p-3">
                  <canvas id="trendChart" height="110"></canvas>
                </div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="text-sm font-semibold">Expense Mix</div>
                <div class="text-xs text-white/55 mt-1">Latest week categories</div>
                <div class="mt-3 bg-black/25 border border-white/10 rounded-2xl p-3">
                  <canvas id="mixChart" height="220"></canvas>
                </div>
                <div id="mixLegend" class="mt-3 grid grid-cols-2 gap-2 text-xs text-white/70"></div>
              </div>
            </div>

            <div class="card rounded-3xl p-4">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm font-semibold">Weekly History</div>
                  <div class="text-xs text-white/55 mt-1">Recent weeks first</div>
                </div>
                <button id="resetBtn" class="chip rounded-2xl px-3 py-2 text-sm hover:bg-white/10 transition">
                  Reset
                </button>
              </div>

              <div class="mt-3 overflow-auto thin-scroll">
                <table class="min-w-full text-sm">
                  <thead class="text-white/60">
                    <tr class="border-b border-white/10">
                      <th class="py-2 text-left font-medium">Week</th>
                      <th class="py-2 text-left font-medium">% Margin</th>
                      <th class="py-2 text-left font-medium">Revenue</th>
                      <th class="py-2 text-left font-medium">TL Exp</th>
                      <th class="py-2 text-left font-medium">Margin</th>
                      <th class="py-2 text-left font-medium">Signal</th>
                    </tr>
                  </thead>
                  <tbody id="lossTableBody" class="divide-y divide-white/10"></tbody>
                </table>
              </div>
            </div>

          </div>
        </section>
      </div>
    </div>
  </div>

<script>
  // ============================
  // CONFIG
  // ============================
  const WORKER_URL = "https://withered-king-c48e.haildir12121.workers.dev/";
  const POLL_MS = 120000;

  const REGION_SHEETS = [
    { id: "ALL", name: "All Areas (Sum)", sheet: null }, // computed
    { id: "CST", name: "Coast", sheet: "CST.Wkly" },
    { id: "EUG", name: "Eugene", sheet: "EUG.Wkly" },
    { id: "RBG", name: "Roseburg", sheet: "RBG.Wkly" },
    { id: "OKRDG", name: "Oakridge", sheet: "OKRDG.Wkly" },
    { id: "MDVCR", name: "Mid-Valley/Corvallis", sheet: "MDVCR.Wkly" },
    { id: "ALBNY", name: "Albany", sheet: "ALBNY.Wkly" },
    { id: "DMT", name: "DMT", sheet: "DMT.Wkly" }
  ];

  // Weekly summary table columns (P..AB)
  const COLMAP = {
    weekStart: "P",
    weekEnd: "Q",
    driverCount: "R",
    hoursWorked: "S",
    payroll: "T",
    fuel: "U",
    insurance: "V",
    maintenance: "W",
    billbacks: "X",
    totalExp: "Y",
    revenue: "Z",
    margin: "AA",
    pctMargin: "AB",
  };

  const CONSOLIDATED_SHEET = "ConsolidatedWkly";
  const TITLE_CELL = "P1";
  const SUBTITLE_CELL = "P2";

  // ============================
  // STATE
  // ============================
  let regionSeries = {};
  let activeRegionId = "ALL";
  let weekly = [];
  let latestWeek = null;

  let trendChart = null;
  let mixChart = null;
  let regionCompareChart = null;

  let showBaseline = true;
  let _timer = null;
  let _activeView = "overview"; // overview | analytics | regions | loss

  // ============================
  // HELPERS
  // ============================
  function $(id){ return document.getElementById(id); }

  function fmtUSD(n) {
    return Number(n || 0).toLocaleString(undefined, {
      style: "currency",
      currency: "USD",
      maximumFractionDigits: 0
    });
  }

  function safeNum(v) {
    if (typeof v === "number") return isFinite(v) ? v : 0;
    if (v == null) return 0;
    const s = String(v).replace(/[^0-9.\-]/g, "");
    const n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }

  function asDate(v) {
    if (v instanceof Date && !isNaN(v)) return v;
    if (typeof v === "number" && isFinite(v)) {
      // Excel serial -> Date
      const utcDays = Math.floor(v - 25569);
      return new Date(utcDays * 86400 * 1000);
    }
    const d = new Date(v);
    return isNaN(d) ? null : d;
  }

  function niceDate(v) {
    const d = asDate(v);
    if (!d) return String(v || "");
    return `${d.getMonth() + 1}/${d.getDate()}/${d.getFullYear()}`;
  }

  function colToIndex(col) {
    let n = 0;
    const s = String(col).toUpperCase().trim();
    for (let i = 0; i < s.length; i++) n = n * 26 + (s.charCodeAt(i) - 64);
    return n - 1;
  }

  function weekTimestamp(w) {
    const d = asDate(w.weekEnd) || asDate(w.weekStart);
    return d ? d.getTime() : -Infinity;
  }

  function sortWeeksDesc(arr) {
    return (arr || []).slice().sort((a, b) => weekTimestamp(b) - weekTimestamp(a));
  }

  function weekKey(weekStart, weekEnd) {
    return `${niceDate(weekStart)}|${niceDate(weekEnd)}`;
  }

  function setStatus(text) {
    const el = $("statusLabel");
    if (el) el.textContent = `Status: ${text}`;
  }

  function readCell(ws, addr) {
    return ws?.[addr]?.v ?? "";
  }

  function pmBadge(pm) {
    if (!isFinite(pm)) return { label: "‚Äî", cls: "text-white/70" };
    if (pm < 0) return { label: "LOSS", cls: "text-rose-200" };
    if (pm < 5) return { label: "RISK", cls: "text-amber-100" };
    return { label: "OK", cls: "text-emerald-200" };
  }

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  // ============================
  // NAV / VIEWS (make sidebar buttons actually do something)
  // ============================
  function setActiveView(viewId){
    _activeView = viewId;

    // highlight nav buttons
    document.querySelectorAll("[data-view]").forEach(btn=>{
      const isOn = btn.getAttribute("data-view") === viewId;
      btn.classList.toggle("bg-white/8", isOn);
      btn.classList.toggle("border-white/10", isOn);
    });

    // sections (we create them if not present)
    const ids = ["view_overview","view_analytics","view_regions","view_loss"];
    ids.forEach(id=>{
      const el = $(id);
      if (!el) return;
      el.classList.toggle("hidden", true);
    });

    const showId =
      viewId === "overview" ? "view_overview" :
      viewId === "analytics" ? "view_analytics" :
      viewId === "regions" ? "view_regions" :
      "view_loss";

    if ($(showId)) $(showId).classList.toggle("hidden", false);

    // render view-specific things
    renderAll();
  }

  function attachNavHandlers(){
    // Bind to your existing sidebar buttons by text or by adding data-view attr
    // We will prefer data-view if present, else we guess based on label.
    const candidates = Array.from(document.querySelectorAll("aside button"));
    candidates.forEach(btn=>{
      const t = (btn.textContent || "").trim().toLowerCase();
      if (btn.id === "refreshBtn" || btn.id === "exportBtn") return;

      // If user didn't set data-view, infer:
      if (!btn.getAttribute("data-view")){
        if (t === "overview") btn.setAttribute("data-view","overview");
        else if (t === "analytics") btn.setAttribute("data-view","analytics");
        else if (t === "regions") btn.setAttribute("data-view","regions");
        else if (t === "loss areas") btn.setAttribute("data-view","loss");
      }

      const v = btn.getAttribute("data-view");
      if (!v) return;

      btn.addEventListener("click", ()=>{
        setActiveView(v);
      }, { passive:true });
    });
  }

  // Create 3 extra content sections under your existing content (no HTML edits required)
  function ensureViewContainers(){
    // We are going to wrap existing KPI/chart/table area as "overview"
    // and append hidden sections for analytics/regions/loss.
    // This assumes your main content area contains: canvas#trendChart, canvas#mixChart, table#lossTableBody.
    const trendCanvas = $("trendChart");
    if (!trendCanvas) return; // page not ready

    // Find a reasonable container to inject views into: parent section content block
    // We'll locate the nearest common ancestor inside the main area.
    let root = trendCanvas.closest(".p-5") || trendCanvas.closest("section") || trendCanvas.parentElement;
    if (!root) return;

    // If already created, skip
    if ($("view_overview")) return;

    // Create wrappers
    const wrap = document.createElement("div");
    wrap.id = "viewsRoot";
    wrap.className = "space-y-4";
    // Move existing blocks into overview by cloning container: easiest = create overview container and move siblings until end.
    // We'll just insert containers and then leave existing content visible as overview by default.
    // We will hide/show by toggling on these containers; so we need actual containers.

    // Create containers
    const vOverview = document.createElement("div");
    vOverview.id = "view_overview";
    vOverview.className = "space-y-4";

    const vAnalytics = document.createElement("div");
    vAnalytics.id = "view_analytics";
    vAnalytics.className = "space-y-4 hidden";

    const vRegions = document.createElement("div");
    vRegions.id = "view_regions";
    vRegions.className = "space-y-4 hidden";

    const vLoss = document.createElement("div");
    vLoss.id = "view_loss";
    vLoss.className = "space-y-4 hidden";

    // We want overview to contain the original content currently inside root.
    // So: move all children of root into overview, then put overview/others back.
    const originalKids = Array.from(root.children);
    originalKids.forEach(ch => vOverview.appendChild(ch));

    // Build Analytics section UI
    vAnalytics.innerHTML = `
      <div class="card rounded-3xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold">Analytics</div>
            <div class="text-xs text-white/55 mt-1">Region comparison based on latest available week</div>
          </div>
          <div class="chip rounded-2xl px-3 py-2 text-sm font-semibold" id="analyticsWeekPill">‚Äî</div>
        </div>
        <div class="mt-3 bg-black/25 border border-white/10 rounded-2xl p-3">
          <canvas id="regionCompareChart" height="130"></canvas>
        </div>
        <div class="mt-3 grid grid-cols-2 lg:grid-cols-4 gap-3" id="topRegionsGrid"></div>
      </div>
    `;

    // Build Regions section UI
    vRegions.innerHTML = `
      <div class="card rounded-3xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold">Regions</div>
            <div class="text-xs text-white/55 mt-1">Pick a region from the sidebar. Data is week-sorted newest ‚Üí oldest.</div>
          </div>
          <div class="chip rounded-2xl px-3 py-2 text-sm font-semibold">Active: <span id="regionsActivePill">‚Äî</span></div>
        </div>
        <div class="mt-3 grid grid-cols-1 lg:grid-cols-3 gap-3" id="regionKpiGrid"></div>
      </div>
    `;

    // Build Loss section UI (separate from overview table)
    vLoss.innerHTML = `
      <div class="card rounded-3xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold">Loss Areas</div>
            <div class="text-xs text-white/55 mt-1">Weeks filtered to margin &lt; 0%, newest first</div>
          </div>
          <button id="lossResetBtn" class="chip rounded-2xl px-3 py-2 text-sm hover:bg-white/10 transition">Reset</button>
        </div>

        <div class="mt-3 thin-scroll overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="text-white/60">
              <tr class="border-b border-white/10">
                <th class="py-2 text-left font-medium">Week</th>
                <th class="py-2 text-left font-medium">% Margin</th>
                <th class="py-2 text-left font-medium">Revenue</th>
                <th class="py-2 text-left font-medium">TL Exp</th>
                <th class="py-2 text-left font-medium">Margin</th>
                <th class="py-2 text-left font-medium">Signal</th>
              </tr>
            </thead>
            <tbody id="lossOnlyBody" class="divide-y divide-white/10"></tbody>
          </table>
        </div>
      </div>
    `;

    // Assemble
    wrap.appendChild(vOverview);
    wrap.appendChild(vAnalytics);
    wrap.appendChild(vRegions);
    wrap.appendChild(vLoss);

    root.appendChild(wrap);

    // loss reset button handler
    $("lossResetBtn")?.addEventListener("click", ()=>{
      renderLossOnlyTable();
    });
  }

  // ============================
  // FETCH + XLSX ‚úÖ BINARY ONLY
  // ============================
  async function fetchWorkbookBinary() {
    const res = await fetch(WORKER_URL, { cache: "no-store" });

    if (!res.ok) {
      // try to read JSON error if worker returns it
      let detail = "";
      try {
        const maybeJson = await res.clone().json();
        detail = maybeJson?.detail || maybeJson?.error || JSON.stringify(maybeJson);
      } catch {
        detail = (await res.text()).slice(0, 500);
      }
      throw new Error(`Fetch failed (${res.status}): ${detail}`);
    }

    // IMPORTANT: this endpoint returns XLSX bytes, not JSON
    const fileName = res.headers.get("X-File-Name") || "shared-file.xlsx";
    const fetchedAt = res.headers.get("X-Fetched-At") || new Date().toISOString();

    const bytes = await res.arrayBuffer();
    const wb = XLSX.read(bytes, { type: "array" });

    return { wb, meta: { fileName, fetchedAt } };
  }

  async function fetchWorkbook() {
    return fetchWorkbookBinary();
  }

  // ============================
  // PARSE REGION WEEKLY TABLE (P..AB)
  // ============================
  function parseRegionSheet(ws) {
    const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

    const idx = {};
    for (const [k, col] of Object.entries(COLMAP)) idx[k] = colToIndex(col);

    const P = idx.weekStart;
    const Q = idx.weekEnd;
    const hasWord = (v, word) => String(v || "").toLowerCase().includes(word);

    // Find header row
    let headerRow = -1;
    for (let r = 0; r < Math.min(140, aoa.length); r++) {
      const row = aoa[r] || [];
      const z = row[idx.revenue];
      const aa = row[idx.margin];
      const ab = row[idx.pctMargin];
      const p = row[P];
      const q = row[Q];

      const looksLikeHeader =
        (hasWord(p, "week") && hasWord(q, "week")) ||
        (hasWord(z, "revenue") && hasWord(aa, "margin")) ||
        (hasWord(ab, "margin") && (String(ab).includes("%") || hasWord(ab, "%")));

      if (looksLikeHeader) { headerRow = r; break; }
    }
    if (headerRow === -1) headerRow = 2;

    const dataStart = headerRow + 1;
    const out = [];

    for (let r = dataStart; r < aoa.length; r++) {
      const row = aoa[r] || [];
      const wsVal = row[P];
      const weVal = row[Q];

      if (String(wsVal).trim() === "" && String(weVal).trim() === "") break;

      const revenue = safeNum(row[idx.revenue]);
      const totalExp = safeNum(row[idx.totalExp]);
      const margin = safeNum(row[idx.margin]);

      const hasMoney =
        Math.abs(revenue) > 0.0001 ||
        Math.abs(totalExp) > 0.0001 ||
        Math.abs(margin) > 0.0001;

      if (!hasMoney) continue;

      let pmRaw = row[idx.pctMargin];
      let pm = 0;
      if (typeof pmRaw === "number") pm = pmRaw <= 1.5 ? pmRaw * 100 : pmRaw;
      else {
        const n = safeNum(pmRaw);
        pm = n <= 1.5 ? n * 100 : n;
      }
      if (!isFinite(pm)) pm = 0;

      out.push({
        weekStart: wsVal,
        weekEnd: weVal,
        revenue,
        totalExp,
        margin,
        pctMargin: pm,
        driverCount: Math.round(safeNum(row[idx.driverCount])),
        hoursWorked: safeNum(row[idx.hoursWorked]),
        payroll: safeNum(row[idx.payroll]),
        fuel: safeNum(row[idx.fuel]),
        insurance: safeNum(row[idx.insurance]),
        maintenance: safeNum(row[idx.maintenance]),
        billbacks: safeNum(row[idx.billbacks]),
      });
    }

    return sortWeeksDesc(out);
  }

  function sumRegionsByWeek(seriesById) {
    const map = new Map();

    for (const [id, series] of Object.entries(seriesById || {})) {
      if (id === "ALL") continue;

      for (const w of (series || [])) {
        const key = weekKey(w.weekStart, w.weekEnd);
        const cur = map.get(key) || {
          weekStart: w.weekStart,
          weekEnd: w.weekEnd,
          revenue: 0, totalExp: 0, margin: 0, pctMargin: 0,
          payroll: 0, fuel: 0, insurance: 0, maintenance: 0, billbacks: 0,
          driverCount: 0, hoursWorked: 0
        };

        cur.revenue += w.revenue || 0;
        cur.totalExp += w.totalExp || 0;
        cur.margin += w.margin || 0;

        cur.payroll += w.payroll || 0;
        cur.fuel += w.fuel || 0;
        cur.insurance += w.insurance || 0;
        cur.maintenance += w.maintenance || 0;
        cur.billbacks += w.billbacks || 0;

        cur.driverCount += w.driverCount || 0;
        cur.hoursWorked += w.hoursWorked || 0;

        map.set(key, cur);
      }
    }

    const all = Array.from(map.values());
    for (const w of all) {
      w.pctMargin = ((w.revenue - w.totalExp) / Math.max(1, w.revenue)) * 100;
      if (!isFinite(w.pctMargin)) w.pctMargin = 0;
    }

    return sortWeeksDesc(all);
  }

  // ============================
  // UI RENDER (sidebar, kpis, charts, tables)
  // ============================
  function renderRegionSidebar() {
    const list = $("regionList");
    if (!list) return;

    const filter = String($("regionFilter")?.value || "").trim().toLowerCase();
    list.innerHTML = "";

    REGION_SHEETS
      .filter(r => !filter || r.name.toLowerCase().includes(filter) || r.id.toLowerCase().includes(filter))
      .forEach(r => {
        const series = regionSeries[r.id] || [];
        const w = series[0];
        const pm = w ? w.pctMargin : NaN;
        const b = pmBadge(pm);

        const btn = document.createElement("button");
        btn.className =
          "card rounded-2xl px-3 py-3 text-left hover:bg-white/7 transition " +
          (r.id === activeRegionId ? "ring-1 ring-white/25" : "");

        btn.innerHTML = `
          <div class="flex items-center justify-between gap-3">
            <div class="min-w-0">
              <div class="text-sm font-semibold truncate">${r.name}</div>
              <div class="text-xs text-white/55 truncate">${r.sheet ? r.sheet : "computed sum"}</div>
            </div>
            <div class="text-right shrink-0">
              <div class="text-sm font-bold">${w ? w.pctMargin.toFixed(2) + "%" : "‚Äî"}</div>
              <div class="text-[11px] ${b.cls}">${b.label}</div>
            </div>
          </div>
        `;

        btn.addEventListener("click", () => {
          activeRegionId = r.id;
          if ($("activeRegionPill")) $("activeRegionPill").textContent = r.id;

          weekly = sortWeeksDesc(regionSeries[activeRegionId] || []);
          latestWeek = weekly[0] || null;

          renderRegionSidebar();
          renderAll();
        });

        list.appendChild(btn);
      });
  }

  function renderKpis() {
    const w = latestWeek;
    if (!w) return;

    const rev = w.revenue || 0;
    const exp = w.totalExp || 0;
    const pm = isFinite(w.pctMargin) ? w.pctMargin : ((rev - exp) / Math.max(1, rev)) * 100;

    if ($("kpiRevenue")) $("kpiRevenue").textContent = fmtUSD(rev);
    if ($("kpiExpense")) $("kpiExpense").textContent = fmtUSD(exp);
    if ($("kpiExpenseSub")) $("kpiExpenseSub").textContent = `TL Exp ‚Ä¢ ${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}`;
    if ($("kpiMargin")) $("kpiMargin").textContent = `${pm.toFixed(2)}%`;
    if ($("kpiMarginSub")) $("kpiMarginSub").textContent = `${fmtUSD(w.margin || 0)} margin`;

    if ($("kpiDrivers")) $("kpiDrivers").textContent = `${w.driverCount || 0}`;
    if ($("kpiDriversSub")) {
      const costPer = (exp / Math.max(1, w.driverCount || 0)) || 0;
      $("kpiDriversSub").textContent = `Hours: ${Math.round(w.hoursWorked || 0)} ‚Ä¢ Cost/Driver: ${fmtUSD(costPer)}`;
    }

    if ($("weekLabel")) $("weekLabel").textContent = `Week: ${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}`;
  }

  function renderTrendChart() {
    const canvas = $("trendChart");
    if (!canvas) return;

    const seriesDesc = (weekly || []).filter(w => isFinite(w.pctMargin) && Math.abs(w.revenue) > 0.0001);
    const take = seriesDesc.slice(0, 16).reverse(); // oldest->newest for chart
    const labels = take.map(w => niceDate(w.weekEnd));
    const data = take.map(w => w.pctMargin);
    const baseline = data.length ? data.reduce((a, b) => a + b, 0) / data.length : 0;

    const ctx = canvas.getContext("2d");
    if (trendChart) trendChart.destroy();

    const datasets = [{
      label: "% Margin",
      data,
      borderColor: "rgba(255,255,255,0.85)",
      borderWidth: 2,
      pointRadius: 0,
      tension: 0.35,
      fill: true,
      backgroundColor: "rgba(255,255,255,0.08)"
    }];

    if (showBaseline) {
      datasets.push({
        label: "Baseline",
        data: Array(data.length).fill(baseline),
        borderColor: "rgba(255,255,255,0.25)",
        borderWidth: 1,
        pointRadius: 0,
        tension: 0.2
      });
    }

    trendChart = new Chart(ctx, {
      type: "line",
      data: { labels, datasets },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false }, ticks: { color: "rgba(255,255,255,0.55)" } },
          y: { grid: { color: "rgba(255,255,255,0.06)" }, ticks: { color: "rgba(255,255,255,0.55)", callback: v => `${v}%` } }
        }
      }
    });
  }

  function renderMixChart() {
    const w = latestWeek;
    const canvas = $("mixChart");
    if (!w || !canvas) return;

    const labels = ["Payroll", "Fuel", "Insurance", "Maintenance", "Billbacks", "Other"];
    const vals = [
      w.payroll || 0,
      w.fuel || 0,
      w.insurance || 0,
      w.maintenance || 0,
      w.billbacks || 0
    ];
    const known = vals.reduce((a, b) => a + b, 0);
    const other = Math.max(0, (w.totalExp || 0) - known);
    vals.push(other);

    const ctx = canvas.getContext("2d");
    if (mixChart) mixChart.destroy();

    mixChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels,
        datasets: [{
          data: vals,
          borderColor: "rgba(255,255,255,0.12)",
          borderWidth: 1
        }]
      },
      options: {
        plugins: { legend: { display: false } },
        cutout: "62%"
      }
    });

    const legend = $("mixLegend");
    if (!legend) return;

    legend.innerHTML = "";
    const total = Math.max(1, (w.totalExp || 0));

    labels.forEach((lab, i) => {
      const pct = (vals[i] / total) * 100;
      const div = document.createElement("div");
      div.className = "chip rounded-xl px-2 py-2";
      div.innerHTML = `
        <div class="text-[11px] text-white/60">${lab}</div>
        <div class="text-sm font-semibold">${pct.toFixed(1)}%</div>
      `;
      legend.appendChild(div);
    });
  }

  function buildSignal(w) {
    const pm = w.pctMargin || 0;
    if (pm < 0) return "Loss week. Check payroll, maintenance, and fuel burdens.";
    if (pm < 5) return "Low margin. Investigate expense spikes and underpriced weeks.";
    return "Healthy week.";
  }

  // Newest -> Oldest by default
  function renderHistoryTable(customData = null) {
    const tbody = $("lossTableBody");
    if (!tbody) return;
    tbody.innerHTML = "";

    let series = customData || weekly;
    series = (series || []).filter(w => isFinite(w.pctMargin) && Math.abs(w.revenue) > 0.0001);
    series = sortWeeksDesc(series);

    const rows = series.slice(0, 50);

    if (rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-white/50">No data found.</td></tr>`;
      return;
    }

    rows.forEach(w => {
      const b = pmBadge(w.pctMargin);
      const tr = document.createElement("tr");
      tr.className = "hover:bg-white/5 transition";
      tr.innerHTML = `
        <td class="py-3 pr-3">
          <div class="font-semibold">${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}</div>
          <div class="text-xs text-white/55">Drivers: ${w.driverCount || 0}</div>
        </td>
        <td class="py-3 pr-3 font-semibold ${b.cls}">${(w.pctMargin || 0).toFixed(2)}%</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.revenue)}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.totalExp)}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.margin)}</td>
        <td class="py-3 pr-3 text-white/70"><div class="max-w-[520px] truncate">${buildSignal(w)}</div></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Loss-only table for the "Loss Areas" view
  function renderLossOnlyTable(){
    const tbody = $("lossOnlyBody");
    if (!tbody) return;
    tbody.innerHTML = "";

    let series = (weekly || []).filter(w => isFinite(w.pctMargin) && Math.abs(w.revenue) > 0.0001);
    series = sortWeeksDesc(series).filter(w => (w.pctMargin || 0) < 0);

    const rows = series.slice(0, 60);

    if (rows.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-white/50">No loss weeks in this region.</td></tr>`;
      return;
    }

    rows.forEach(w => {
      const b = pmBadge(w.pctMargin);
      const tr = document.createElement("tr");
      tr.className = "hover:bg-white/5 transition";
      tr.innerHTML = `
        <td class="py-3 pr-3">
          <div class="font-semibold">${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}</div>
          <div class="text-xs text-white/55">Drivers: ${w.driverCount || 0}</div>
        </td>
        <td class="py-3 pr-3 font-semibold ${b.cls}">${(w.pctMargin || 0).toFixed(2)}%</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.revenue)}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.totalExp)}</td>
        <td class="py-3 pr-3 text-white/85">${fmtUSD(w.margin)}</td>
        <td class="py-3 pr-3 text-white/70"><div class="max-w-[520px] truncate">${buildSignal(w)}</div></td>
      `;
      tbody.appendChild(tr);
    });
  }

  // Analytics: region comparison for latest common week
  function getLatestCommonWeekKey(){
    // We want the most recent week that exists for activeRegion (or ALL) for display.
    // For analytics compare, we just use each region's latest week independently.
    const w = latestWeek;
    if (!w) return null;
    return weekKey(w.weekStart, w.weekEnd);
  }

  function renderAnalytics(){
    ensureViewContainers();
    const pill = $("analyticsWeekPill");
    const wk = latestWeek ? `${niceDate(latestWeek.weekStart)} ‚Üí ${niceDate(latestWeek.weekEnd)}` : "‚Äî";
    if (pill) pill.textContent = wk;

    // Build bar chart: revenue + margin % for latest week of each region
    const rows = REGION_SHEETS.filter(r => r.id !== "ALL").map(r=>{
      const s = regionSeries[r.id] || [];
      const w = s[0] || null;
      return {
        id: r.id,
        name: r.name,
        revenue: w ? (w.revenue||0) : 0,
        pctMargin: w ? (w.pctMargin||0) : 0,
        totalExp: w ? (w.totalExp||0) : 0
      };
    });

    // Sort by revenue desc for readability
    rows.sort((a,b)=> (b.revenue||0) - (a.revenue||0));

    const canvas = $("regionCompareChart");
    if (!canvas) return;

    const labels = rows.map(r => r.id);
    const rev = rows.map(r => r.revenue);
    const pm = rows.map(r => r.pctMargin);

    const ctx = canvas.getContext("2d");
    if (regionCompareChart) regionCompareChart.destroy();

    regionCompareChart = new Chart(ctx, {
      type: "bar",
      data: {
        labels,
        datasets: [
          { label: "Revenue", data: rev },
          { label: "% Margin", data: pm, yAxisID: "y2" }
        ]
      },
      options: {
        plugins: { legend: { display: false } },
        scales: {
          y: {
            ticks: { color: "rgba(255,255,255,0.55)", callback: v => fmtUSD(v) },
            grid: { color: "rgba(255,255,255,0.06)" }
          },
          y2: {
            position: "right",
            ticks: { color: "rgba(255,255,255,0.55)", callback: v => `${v}%` },
            grid: { display: false }
          },
          x: {
            ticks: { color: "rgba(255,255,255,0.55)" },
            grid: { display: false }
          }
        }
      }
    });

    // Top regions quick cards
    const grid = $("topRegionsGrid");
    if (!grid) return;
    grid.innerHTML = "";

    const top = rows.slice(0, 8);
    top.forEach(r=>{
      const b = pmBadge(r.pctMargin);
      const div = document.createElement("div");
      div.className = "chip rounded-2xl p-3";
      div.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="text-sm font-semibold">${r.name}</div>
          <div class="text-xs ${b.cls} font-semibold">${b.label}</div>
        </div>
        <div class="mt-2 text-xs text-white/60">Revenue</div>
        <div class="text-lg font-extrabold">${fmtUSD(r.revenue)}</div>
        <div class="mt-1 text-xs text-white/60">% Margin</div>
        <div class="text-base font-semibold">${(r.pctMargin||0).toFixed(2)}%</div>
      `;
      div.addEventListener("click", ()=>{
        activeRegionId = r.id;
        $("activeRegionPill") && ($("activeRegionPill").textContent = r.id);
        weekly = sortWeeksDesc(regionSeries[activeRegionId] || []);
        latestWeek = weekly[0] || null;
        renderRegionSidebar();
        renderAll();
        setActiveView("overview");
      });
      grid.appendChild(div);
    });
  }

  function renderRegionsView(){
    ensureViewContainers();
    if ($("regionsActivePill")) $("regionsActivePill").textContent = activeRegionId;

    const grid = $("regionKpiGrid");
    if (!grid) return;
    grid.innerHTML = "";

    const series = sortWeeksDesc(regionSeries[activeRegionId] || []);
    const w0 = series[0];
    const w1 = series[1];

    if (!w0){
      grid.innerHTML = `<div class="text-white/60 text-sm">No data for this region.</div>`;
      return;
    }

    const delta = (a,b)=> (safeNum(a) - safeNum(b));
    const pct = (a,b)=> ( (delta(a,b) / Math.max(1, Math.abs(safeNum(b)))) * 100 );

    const cards = [
      { title:"Revenue", val: fmtUSD(w0.revenue), sub: w1 ? `${pct(w0.revenue, w1.revenue).toFixed(1)}% vs prior` : "‚Äî" },
      { title:"Total Expense", val: fmtUSD(w0.totalExp), sub: w1 ? `${pct(w0.totalExp, w1.totalExp).toFixed(1)}% vs prior` : "‚Äî" },
      { title:"% Margin", val: `${(w0.pctMargin||0).toFixed(2)}%`, sub: w1 ? `${delta(w0.pctMargin, w1.pctMargin).toFixed(2)} pts vs prior` : "‚Äî" },
      { title:"Maintenance", val: fmtUSD(w0.maintenance), sub: w1 ? `${pct(w0.maintenance, w1.maintenance).toFixed(1)}% vs prior` : "‚Äî" },
      { title:"Fuel", val: fmtUSD(w0.fuel), sub: w1 ? `${pct(w0.fuel, w1.fuel).toFixed(1)}% vs prior` : "‚Äî" },
      { title:"Payroll", val: fmtUSD(w0.payroll), sub: w1 ? `${pct(w0.payroll, w1.payroll).toFixed(1)}% vs prior` : "‚Äî" },
    ];

    cards.forEach(c=>{
      const div = document.createElement("div");
      div.className = "card rounded-3xl p-4";
      div.innerHTML = `
        <div class="text-xs text-white/60">${c.title}</div>
        <div class="mt-2 text-2xl font-extrabold tracking-tight">${c.val}</div>
        <div class="mt-1 text-xs text-white/55">${c.sub}</div>
      `;
      grid.appendChild(div);
    });
  }

  function renderAll(){
    if (!latestWeek){
      setStatus("No data");
      // still try to render view containers
      ensureViewContainers();
      return;
    }

    // Always update sidebar + header pill
    if ($("activeRegionPill")) $("activeRegionPill").textContent = activeRegionId;

    // Overview always updates its base elements
    renderKpis();
    renderTrendChart();
    renderMixChart();
    renderHistoryTable();
    setStatus(`OK (${activeRegionId})`);

    // View-specific
    if (_activeView === "analytics") renderAnalytics();
    if (_activeView === "regions") renderRegionsView();
    if (_activeView === "loss") renderLossOnlyTable();
  }

  // ============================
  // EVENTS
  // ============================
  $("toggleBaseline")?.addEventListener("click", () => {
    showBaseline = !showBaseline;
    renderTrendChart();
  });

  $("exportBtn")?.addEventListener("click", () => {
    const payload = { generatedAt: new Date().toISOString(), activeRegionId, latestWeek, weekly };
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `weekly_snapshot_${activeRegionId}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  $("resetBtn")?.addEventListener("click", () => {
    const si = $("searchInput");
    if (si) si.value = "";
    renderHistoryTable();
  });

  // Date filter (type="date")
  $("searchInput")?.addEventListener("change", (e) => {
    const val = e.target.value; // YYYY-MM-DD
    if (!val) return renderHistoryTable();

    const inputDate = new Date(val + "T12:00:00");
    const inputTime = inputDate.getTime();

    const filtered = (weekly || []).filter(w => {
      const start = asDate(w.weekStart);
      const end = asDate(w.weekEnd);
      if (!start || !end) return false;
      return inputTime >= start.getTime() && inputTime <= end.getTime();
    });

    renderHistoryTable(filtered);
  });

  $("regionFilter")?.addEventListener("input", () => {
    renderRegionSidebar();
  });

  // ‚úÖ Refresh button should call refresh()
  $("refreshBtn")?.addEventListener("click", () => {
    refresh();
  });

  // ============================
  // LIVE LOOP
  // ============================
  async function refresh() {
    try {
      setStatus("Syncing‚Ä¶");
      const { wb, meta } = await fetchWorkbook();

      // title/subtitle from consolidated
      const cws = wb.Sheets[CONSOLIDATED_SHEET];
      if (cws) {
        const title = readCell(cws, TITLE_CELL);
        const subtitle = readCell(cws, SUBTITLE_CELL);
        if (title && $("dashTitle")) $("dashTitle").textContent = String(title);
        if (subtitle && $("dashSubtitle")) $("dashSubtitle").textContent = String(subtitle);
      }

      // parse region sheets
      regionSeries = {};
      for (const r of REGION_SHEETS) {
        if (r.id === "ALL") continue;
        const ws = wb.Sheets[r.sheet];
        regionSeries[r.id] = ws ? parseRegionSheet(ws) : [];
      }

      // compute ALL
      regionSeries["ALL"] = sumRegionsByWeek(regionSeries);

      // keep selection
      weekly = sortWeeksDesc(regionSeries[activeRegionId] || regionSeries["ALL"] || []);
      latestWeek = weekly[0] || null;

      if (!latestWeek) throw new Error("No valid weekly rows found across region sheets.");

      const fetchedAt = meta?.fetchedAt ? new Date(meta.fetchedAt) : new Date();
      const lastSync = $("lastSyncLabel");
      if (lastSync) lastSync.textContent = `Last sync: ${fetchedAt.toLocaleString()} ‚Ä¢ ${meta.fileName || ""}`;

      // Ensure view containers exist and nav works
      ensureViewContainers();
      attachNavHandlers();

      // Update sidebar + render
      renderRegionSidebar();
      renderAll();

    } catch (err) {
      console.error(err);
      setStatus(`Sync failed: ${String(err?.message || err)}`);
    }
  }

  function start() {
    // Ensure view containers even before first refresh if possible
    ensureViewContainers();
    attachNavHandlers();

    // default view is overview
    setActiveView("overview");

    refresh();
    if (_timer) clearInterval(_timer);
    _timer = setInterval(refresh, POLL_MS);
  }

  start();
</script>

</body>
</html>

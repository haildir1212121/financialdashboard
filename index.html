<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OT/DMT/DLX</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #121212; color: #e5e5e5; }
        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #121212; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        .bg-card { background-color: #1e1e1e; border: 1px solid #333; border-radius: 12px; display: flex; flex-direction: column; }
        .nav-item { transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent; }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: linear-gradient(90deg, rgba(59,130,246,0.1) 0%, transparent 100%); border-left-color: #3b82f6; color: #3b82f6; font-weight: 700; }
        .kpi-card { background: linear-gradient(145deg, #252525, #1e1e1e); border: 1px solid #333; padding: 16px; border-radius: 12px; position: relative; overflow: hidden; }
        .kpi-forecast { background: linear-gradient(145deg, #2e1065, #1e1e1e); border: 1px solid #4c1d95; }
        .kpi-loss { background: linear-gradient(145deg, #2d1212, #1a0a0a); border: 1px solid #450a0a; }
        .kpi-warn { background: linear-gradient(145deg, #271a00, #1a1200); border: 1px solid #422006; }
        .row-loss { background-color: rgba(239, 68, 68, 0.1); }
        .text-loss { color: #f87171; font-weight: bold; }
        .text-profit { color: #4ade80; font-weight: bold; }
        .filter-chip { background: #333; padding: 4px 10px; border-radius: 12px; font-size: 11px; color: #ccc; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .filter-chip:hover { border-color: #555; color: white; }
        .filter-chip.active { background: #3b82f6; color: white; border-color: #3b82f6; }
        .fav-icon { opacity: 0; transition: opacity 0.2s; }
        .nav-item:hover .fav-icon { opacity: 1; }
        .fav-icon.active { opacity: 1; color: #fbbf24; }
        details > summary { list-style: none; outline: none; cursor: pointer; transition: 0.2s; }
        details > summary::-webkit-details-marker { display: none; }
        details[open] > summary .arrow { transform: rotate(180deg); }
        .arrow { transition: transform 0.2s; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-sm">

    <aside class="w-64 bg-[#181818] flex-shrink-0 flex flex-col border-r border-[#2a2a2a] z-30">
        <div class="h-16 flex items-center px-6 border-b border-[#2a2a2a]">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-900/50">
                <i class="ph-bold ph-chart-polar"></i>
            </div>
            <div class="ml-3">
                <div class="text-base font-bold text-white leading-none">OT/DMT/DLX</div>
                <div class="text-[10px] text-gray-500 font-mono mt-1">Visual Finance Tool</div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scroll p-3 space-y-2">
            <div id="favorites-section" class="hidden mb-4">
                <div class="px-3 mb-1 text-[10px] font-bold text-yellow-500 uppercase tracking-wider flex items-center gap-1"><i class="ph-fill ph-star"></i> Favorites</div>
                <div id="favorites-container" class="space-y-1"></div>
                <div class="h-[1px] bg-[#2a2a2a] mx-3 my-2"></div>
            </div>
            <div class="px-3 mb-1 text-[10px] font-bold text-gray-500 uppercase tracking-wider">Dashboards</div>
            <div onclick="switchContext('ALL', 'Overview', 'Overview')" id="nav-all" class="nav-item active flex items-center gap-3 px-3 py-2 rounded text-gray-400">
                <i class="ph-bold ph-squares-four text-lg"></i><span>Overview</span>
            </div>
            <div onclick="switchContext('TRIPLOG', 'TripLog', 'TripLog')" id="nav-triplog" class="nav-item flex items-center gap-3 px-3 py-2 rounded text-gray-400">
                <i class="ph-bold ph-road-horizon text-lg"></i><span>TripLog</span>
            </div>
            <div onclick="switchContext('DRIVER', 'Driver', 'Driver')" id="nav-driver" class="nav-item flex items-center gap-3 px-3 py-2 rounded text-gray-400">
                <i class="ph-bold ph-steering-wheel text-lg"></i><span>Driver Perf</span>
            </div>
            <div class="px-3 mt-4 mb-1 text-[10px] font-bold text-gray-500 uppercase tracking-wider">Financial Areas</div>
            <div id="accordion-container" class="space-y-1 mt-1"><div class="text-xs text-gray-600 italic px-3 pt-2 text-center">Import Excel files...</div></div>
        </div>
        <div class="p-4 border-t border-[#2a2a2a] bg-[#151515] text-[10px] text-gray-600">
            <div class="flex justify-between"><span>Status:</span><span id="status-indicator" class="text-red-500 font-bold">No Data</span></div>
            <div class="flex justify-between mt-1"><span>Records:</span><span id="record-count-debug" class="text-blue-400">0</span></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative h-full overflow-hidden bg-[#121212]">
        
        <header class="h-16 px-6 flex items-center justify-between border-b border-[#2a2a2a] bg-[#181818]/95 backdrop-blur z-20">
            <div>
                <div class="flex items-center gap-2 text-gray-500 text-xs mb-0.5">
                    <span id="bc-company" class="uppercase tracking-wider font-bold text-gray-400">DASHBOARD</span>
                    <i class="ph-bold ph-caret-right"></i>
                    <span id="bc-location" class="text-blue-400 font-mono">Overview</span>
                </div>
                <h1 class="text-xl font-bold text-white tracking-tight" id="page-title">All Areas</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-2 mr-2 border-r border-[#333] pr-4">
                    <span class="text-xs font-bold text-gray-400">Compare</span>
                    <button onclick="toggleCompareMode()" id="btn-compare" class="w-8 h-4 rounded-full bg-[#333] relative transition-colors cursor-pointer"><div class="w-2 h-2 bg-white rounded-full absolute top-1 left-1 transition-all duration-200"></div></button>
                </div>
                <div class="flex items-center bg-[#252525] rounded-lg p-1 border border-[#333]">
                    <button onclick="setDatePreset(7)" class="px-3 py-1 text-xs font-bold text-gray-400 hover:text-white border-r border-[#333]">7D</button>
                    <button onclick="setDatePreset(30)" class="px-3 py-1 text-xs font-bold text-gray-400 hover:text-white border-r border-[#333]">30D</button>
                    <button onclick="setDatePreset(90)" class="px-3 py-1 text-xs font-bold text-gray-400 hover:text-white">90D</button>
                </div>
                <div class="relative group">
                    <i class="ph-bold ph-calendar-blank absolute left-3 top-2.5 text-gray-400"></i>
                    <input type="text" id="dateRange" placeholder="Select Range" class="bg-[#252525] hover:bg-[#333] border border-[#333] text-white text-xs rounded-lg pl-9 pr-3 py-2 w-48 focus:outline-none focus:border-blue-600 font-mono transition-colors">
                    <button onclick="clearDate()" id="clear-date-btn" class="hidden absolute right-2 top-2 text-gray-500 hover:text-white"><i class="ph-bold ph-x"></i></button>
                </div>
                <div class="relative group">
                    <button class="bg-[#252525] hover:bg-[#333] text-white px-3 py-2 rounded-lg border border-[#333] flex items-center gap-2 text-xs font-bold"><i class="ph-bold ph-export"></i> Export</button>
                    <div class="absolute right-0 top-full mt-2 w-40 bg-[#1e1e1e] border border-[#333] rounded-lg shadow-xl hidden group-hover:block z-50">
                        <button onclick="exportReport('pdf')" class="w-full text-left px-4 py-2 text-xs text-gray-300 hover:bg-[#333] hover:text-white">As PDF Report</button>
                        <button onclick="exportReport('excel')" class="w-full text-left px-4 py-2 text-xs text-gray-300 hover:bg-[#333] hover:text-white">As Excel Data</button>
                    </div>
                </div>
                <button onclick="initDropbox()" id="sync-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-2 shadow-lg shadow-blue-900/20"><i class="ph-bold ph-arrows-clockwise text-lg"></i><span>Sync</span></button>
                <input type="file" id="fileInput" hidden accept=".xlsx, .xls, .csv" multiple>
            </div>
        </header>

        <div id="filter-bar" class="bg-[#181818] border-b border-[#2a2a2a] px-6 py-2 flex items-center gap-4 overflow-x-auto hidden">
            <div class="text-[10px] font-bold text-gray-500 uppercase">Quick Filters:</div>
            <div class="flex gap-2">
                <button onclick="toggleFilter('loss')" id="filter-loss" class="filter-chip">‚ö†Ô∏è Loss Only</button>
                <button onclick="toggleFilter('profit')" id="filter-profit" class="filter-chip">üí∞ High Profit</button>
                <button onclick="toggleFilter('long')" id="filter-long" class="filter-chip">üõ£Ô∏è Long Trips (>50mi)</button>
            </div>
            <div class="h-4 w-[1px] bg-[#333]"></div>
            <select id="adv-driver-select" onchange="updateDashboard()" class="bg-[#252525] border border-[#333] text-gray-300 text-[10px] rounded px-2 py-1 focus:outline-none"><option value="">All Drivers</option></select>
        </div>

        <div class="flex-1 overflow-y-auto p-6 custom-scroll" id="main-scroll">
            <div id="ui-empty" class="flex flex-col items-center justify-center h-[60vh] text-center fade-in">
                <div class="w-24 h-24 bg-[#1e1e1e] rounded-full flex items-center justify-center border border-[#333] mb-6 shadow-2xl"><i class="ph-duotone ph-chart-polar text-4xl text-blue-600"></i></div>
                <h2 class="text-2xl font-bold text-white mb-2">Financial Intelligence</h2>
                <p class="text-gray-500 max-w-md text-sm mb-8">Connect your <strong>Dropbox</strong> or upload files to begin.</p>
                <div class="flex gap-4">
                    <button onclick="document.getElementById('fileInput').click()" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg text-sm font-bold">Import File</button>
                    <button onclick="initDropbox()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg">Sync Dropbox</button>
                </div>
            </div>

            <div id="ui-dashboard" class="hidden space-y-6 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <div class="kpi-card"><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Revenue</div><div class="text-2xl font-bold text-white" id="kpi-rev">$0</div><div class="mt-2" id="trend-rev">-</div></div>
                    <div class="kpi-card"><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Expenses</div><div class="text-2xl font-bold text-white" id="kpi-exp">$0</div><div class="mt-2" id="trend-exp">-</div></div>
                    <div class="kpi-card"><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Net Margin</div><div class="text-2xl font-bold text-white" id="kpi-mar">$0</div><div class="mt-2" id="trend-mar">-</div></div>
                    <div class="kpi-card"><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Cost Ratio</div><div class="text-2xl font-bold text-white" id="kpi-ratio">0%</div><div class="mt-2 text-xs text-gray-500" id="kpi-drivers">-</div></div>
                    <div class="kpi-card kpi-forecast" id="card-forecast-rev"><div class="text-[10px] text-purple-300 uppercase font-bold tracking-wider mb-1 flex items-center gap-1">Proj. 4-Wk Rev</div><div class="text-2xl font-bold text-white" id="kpi-fc-rev">$0</div></div>
                    <div class="kpi-card kpi-forecast" id="card-forecast-mar"><div class="text-[10px] text-purple-300 uppercase font-bold tracking-wider mb-1 flex items-center gap-1">Proj. 4-Wk Margin</div><div class="text-2xl font-bold text-white" id="kpi-fc-mar">$0</div></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-card p-6 h-[400px]">
                        <div class="flex justify-between items-start mb-4"><div><h3 class="text-white font-bold text-lg">Weekly Overview</h3><p class="text-xs text-blue-400 font-mono mt-1" id="chart-subtitle">All Time</p></div></div>
                        <div class="flex-grow w-full relative"><canvas id="chartTrend"></canvas></div>
                    </div>
                    <div class="bg-card p-6 h-[400px]"><h3 class="text-white font-bold mb-4 text-lg">Cash Flow</h3><div class="flex-grow relative"><canvas id="chartWaterfall"></canvas></div></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-card p-6 h-[320px]"><h3 class="text-white font-bold mb-4 text-sm uppercase tracking-wider">Profit Heatmap</h3><div class="flex-grow relative flex justify-center items-center" id="heatmap-container"><canvas id="chartHeatmap"></canvas></div></div>
                    <div class="bg-card p-6 h-[320px]"><h3 class="text-white font-bold mb-4 text-sm uppercase tracking-wider">Cost Structure</h3><div class="flex-grow relative flex justify-center"><canvas id="chartCostRadial"></canvas></div></div>
                    <div class="bg-card p-6 h-[320px]"><h3 class="text-white font-bold mb-4 text-sm uppercase tracking-wider">Top Driver Margin</h3><div class="flex-grow relative"><canvas id="chartDriverMargin"></canvas></div></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 h-[500px]">
                    <div class="bg-card flex flex-col overflow-hidden h-full">
                        <div class="p-4 border-b border-[#2e2e2e] bg-[#1a1a1a]"><h3 class="text-xs font-bold text-gray-300 uppercase tracking-wider">Driver Leaderboard</h3></div>
                        <div class="overflow-x-auto custom-scroll flex-1">
                            <table class="w-full text-left text-gray-400 whitespace-nowrap"><thead class="text-[10px] font-bold uppercase bg-[#151515] text-gray-500 sticky top-0"><tr><th class="p-3">Name</th><th class="p-3 text-right">Payroll</th><th class="p-3 text-right">Rev</th><th class="p-3 text-right">Margin</th><th class="p-3 text-right">Score %</th></tr></thead><tbody id="driver-table-body" class="text-xs divide-y divide-[#2a2a2a] font-mono"></tbody></table>
                        </div>
                    </div>
                    <div class="bg-card flex flex-col overflow-hidden h-full">
                        <div class="p-4 border-b border-[#2e2e2e] bg-[#1a1a1a] flex justify-between items-center"><h3 class="text-xs font-bold text-gray-300 uppercase tracking-wider">Weekly Financials</h3></div>
                        <div class="overflow-x-auto custom-scroll flex-1">
                            <table class="w-full text-left text-gray-400 whitespace-nowrap"><thead class="text-[10px] font-bold uppercase bg-[#151515] text-gray-500 sticky top-0 z-10 shadow-sm"><tr><th class="p-3 border-b border-[#333]">Date</th><th class="p-3 border-b border-[#333] text-right text-red-400">Total Exp</th><th class="p-3 border-b border-[#333] text-right text-blue-400">Revenue</th><th class="p-3 border-b border-[#333] text-right text-green-400">Margin</th><th class="p-3 border-b border-[#333] text-right">%</th></tr></thead><tbody id="table-body" class="text-xs divide-y divide-[#2a2a2a] font-mono"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="ui-triplog" class="hidden space-y-6 fade-in">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="kpi-card kpi-loss"><div class="text-[10px] text-red-400 uppercase font-bold tracking-wider mb-1 flex items-center gap-1"><i class="ph-fill ph-trend-down"></i> Loss Exposure</div><div class="text-2xl font-bold text-white tracking-tight" id="loss-total">$0</div><div class="mt-2 text-xs text-red-400 font-mono" id="loss-count">0 Trips</div></div>
                    <div class="kpi-card kpi-warn"><div class="text-[10px] text-yellow-500 uppercase font-bold tracking-wider mb-1">Worst Driver</div><div class="text-xl font-bold text-white truncate" id="loss-driver-name">-</div><div class="text-sm font-mono text-red-400" id="loss-driver-amt">$0</div></div>
                    <div class="kpi-card kpi-warn"><div class="text-[10px] text-yellow-500 uppercase font-bold tracking-wider mb-1">Worst Account</div><div class="text-xl font-bold text-white truncate" id="loss-acct-name">-</div><div class="text-sm font-mono text-red-400" id="loss-acct-amt">$0</div></div>
                    <div class="kpi-card"><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Daily Loss Alert</div><div class="text-lg font-bold text-white" id="loss-alert-date">No Alerts</div><div class="text-xs text-gray-500 mt-1" id="loss-alert-amt">All days OK</div></div>
                </div>
                <div class="bg-card flex flex-col overflow-hidden shadow-xl min-h-[600px]">
                    <div class="p-4 border-b border-[#2e2e2e] bg-[#1a1a1a] flex flex-wrap gap-4 justify-between items-center">
                        <div class="flex items-center gap-3"><h3 class="text-white font-bold text-lg">Trip Log</h3><span id="triplog-count" class="text-xs text-gray-500 font-mono bg-[#252525] px-2 py-1 rounded">0</span></div>
                        <input type="text" id="triplog-search" onkeyup="handleTripSearch()" placeholder="Search..." class="bg-[#252525] border border-[#333] text-white text-xs rounded-lg pl-3 pr-3 py-2 w-64 focus:border-blue-600 focus:outline-none">
                    </div>
                    <div class="overflow-x-auto custom-scroll flex-1">
                        <table class="w-full text-left text-gray-400 whitespace-nowrap"><thead class="text-[10px] font-bold uppercase bg-[#151515] text-gray-500 sticky top-0 z-10 shadow-sm"><tr><th class="p-3">Driver</th><th class="p-3">Date</th><th class="p-3">Account</th><th class="p-3 text-right">Fare</th><th class="p-3 text-right">Cost</th><th class="p-3 text-right">Profit</th><th class="p-3">Notes</th></tr></thead><tbody id="triplog-body" class="text-xs divide-y divide-[#2a2a2a] font-mono"></tbody></table>
                    </div>
                </div>
            </div>

            <div id="ui-driver" class="hidden space-y-6 fade-in text-center pt-20">
                <i class="ph-duotone ph-steering-wheel text-6xl text-gray-700 mb-4"></i>
                <h2 class="text-xl font-bold text-white">Driver Performance</h2>
                <p class="text-gray-500">Select a driver from the filter bar to view details.</p>
            </div>
        </div>
    </main>

<script>
    const DBX_TOKEN = 'sl.u.AGKWqc00gHV7_e8PJ75Y_rY3pp2sYHV9Nta6IwMFCZVXFUg0US1_wW7nyiH_RW1468Yq4v9YtlNJ_QN3ITSRKwEnQAetLxJRh9Gf7IfRr_KcIgX0hR03-tfSXi9Up4tLgT2vKU6-pBlyZYhWfcy4nUmlg2iOOj6M58i3N9PE-qOkZ2NVisD2F0YDWeWXvt7Iqg9QxYy-ZSwqXVKUSsmfufaiYh-rUcCXVmjrMFubCYIIpie8qnDFCsEv1Akr9uxKuK4RS0bDW2RzjFg1CtvlrPsemc-9tNVwPedXm5EccAuavn5o67GAKOTJZOmy00VBGoZG0NWfif4_t3J0OX-xeh30LBffTN8K0NfPJgXwY556fVPDQBWcYObDHdhXpjo-bFJZQWQD8NUkvsVAQs_nZurPDH190VyYrP78S8ISQqjowvqgY-aREGKqRjWhmnKsrf1-AqgUeV1LxdMM7n610h1ws5LUZZjxWfjDVsqcBribfsjvaCXy3ocZT2NrxgealzFykRLnJLQbVQiHmbloootVIMBI3-Z4JEGoKorv1iIr9GSLc0e6yeIPGeAze-VOYopH_TbR5cxtlSPBoTiAsJfzHh_l4YojGx3aj5a_Nevv5eGq2IntxjWhUJsZgYwoih11ykZdctRahXH4x2mXVINbnmP2y7ckd8VLQ9T6eVdJEex6hs85xdP2VMYajOZDSFdjagvGhHVWd4F2_gft_4VzjgdhM8BVm8NjEUG5HygWV5m8yWwwUhwSvG5ANWffoGq65Tq4JZeY4nsFXD5pkxSPYlnbN0rqE5xUDIvxUawCD-blw2NPLCSYWT4km3ogwoKeesD1YUN3wDcH1MPH-CQqearTJ8wkrO2p_SVCpjXw4c-NLaO-CRnLcYx8Jvqv14XGUtPeDj9G_oatkEgqHviZWXfkBk06x4_58aj7voUup0w0k2fK8DqGQiLmVNgs4j8GOXZwxJ-2aDZ76CSCvSyhWeDjw14bFm3LTeS0bZRc5wdVyhT673qdwRPoKAd4y08NZlQhORLFOnMXZnCNkjUhX6le4QOdV3kvjVsqt7flHKPQ-lEpYzNIh6MrZj929-nDhHQGo3ayzCLWuOYO6h5NDNbVMIsCQ38SQ-ix2KdxweCyZW2giTh5nE_vaGASYWZblTvR7G8BhVCbC8AvolKTyby37XSbOTI-ai3iqRmxTnHz7aEmomuGPX7kpMd8kEkJu9X6QWua7CG_fESyVvb1_X4nHl0K1Rp2ya4fpSZxRcWevAprfNshzN5zSpeQiuRPTgnTmObXS7-DArrHqsRSnDzu8TkDXAVQitVkvmtZ9VnFM9tHT1b8ehfMZQdVy2R1aU0v5KfsTpUy_nKasZ2UvepOV9J3xW02S1uY9tp3muw1g6WUq45IsniMH_zqR7BswqzXfdmlWfZq0KL-Kx8qK2DIVESsk319G-7JdOl_bIq6BnU8O5YzT5HxBxx9830'; 

    const DROPBOX_CONFIG = [
        { company: 'Deluxe', link: 'https://www.dropbox.com/scl/fi/estjsmhffbxy0y4b3n2se/DLX-Margin.Labor-Spreadsheet-2.27.25.xlsx?rlkey=ecggt0myxuyqylnmtajx3j8id&st=d1vpmema&dl=0', type: 'finance' },
        { company: 'DMT',    link: 'https://www.dropbox.com/scl/fi/4ua44lgj7vqm0nrb15qfz/DMT-Test-File.xlsx?rlkey=ccnfs1etglvkesn16gjhlh60v&st=cf28c1iv&dl=0', type: 'finance' },
        { company: 'TripLog', link: 'https://www.dropbox.com/scl/fi/3x76us3schnyezkcfrefs/Margin-Reports-11.1.25-11.30.25-Repaired-Comb.csv?rlkey=0cp03zv5ib5nhb6ku7rzz5zf6&st=uprlqnfb&dl=0', type: 'triplog' }
    ];

    // --- GLOBAL STATE ---
    const FMT = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
    const K_FMT = (num) =>
        Math.abs(num) > 999
            ? '$' + (Math.sign(num) * Math.round(Math.abs(num) / 1000) + 'k')
            : '$' + Math.sign(num) * Math.abs(num);

    Chart.defaults.font.family = "'Nunito', sans-serif";
    Chart.defaults.color = '#888';
    Chart.defaults.borderColor = '#2a2a2a';
    Chart.register(ChartDataLabels);

    const SHEET_MAP = {
        'ABNY.WKLY': 'Albany',
        'CST.WKLY': 'Coast',
        'CONSOLIDATEDWKLY': 'Company Overview',
        'CONSOLIDATED.WKLY': 'Company Overview',
        'DMTWKLY': 'DMT',
        'EUGWKLY': 'DLX-EUG',
        'EUG.WKLY': 'Eugene Weekly',
        'MDVCR.WKLY': 'Modivcare',
        'OKRDG.WKLY': 'Oakridge',
        'OT': 'Oregon Taxi',
        'RBG.WKLY': 'Roseburg',
        'ALBANY.SALEM': 'Albany/Salem',
        'E.OREGON': 'Eastern Oregon',
        'NEVADA': 'Nevada'
    };

    let STATE = {
        data: {},
        tripLog: [],
        filteredTripLog: [],
        ctxType: 'ALL',
        ctxComp: 'Overview',
        ctxLoc: 'Overview',
        dateRange: null,
        compareMode: false,
        activeFilter: null,
        favorites: JSON.parse(localStorage.getItem('favs')) || []
    };

    // --- INIT ---
    const fp = flatpickr("#dateRange", {
        mode: "range",
        dateFormat: "Y-m-d",
        theme: "dark",
        maxDate: "today",
        onChange: (d) => {
            STATE.dateRange = d.length === 2 ? d : null;
            document.getElementById('clear-date-btn').classList.toggle('hidden', !STATE.dateRange);
            updateAllViews();
        }
    });

    function clearDate() {
        fp.clear();
        STATE.dateRange = null;
        document.getElementById('clear-date-btn').classList.add('hidden');
        updateAllViews();
    }

    function setDatePreset(days) {
        const end = new Date();
        const start = new Date();
        start.setDate(end.getDate() - days);
        fp.setDate([start, end], false);
        STATE.dateRange = [start, end];
        document.getElementById('clear-date-btn').classList.remove('hidden');
        updateAllViews();
    }

    function toggleCompareMode() {
        STATE.compareMode = !STATE.compareMode;
        document.getElementById('btn-compare').classList.toggle('bg-blue-600', STATE.compareMode);
        document
            .getElementById('btn-compare')
            .querySelector('div')
            .classList.toggle('translate-x-4', STATE.compareMode);
        updateDashboard();
    }

    function toggleFilter(type) {
        STATE.activeFilter = STATE.activeFilter === type ? null : type;
        document.querySelectorAll('.filter-chip').forEach((el) => el.classList.remove('active'));
        if (STATE.activeFilter) document.getElementById('filter-' + type).classList.add('active');
        updateTripLogView();
    }

    function setText(id, text) {
        const el = document.getElementById(id);
        if (el) el.innerText = text;
    }

    // --- EXPORT ---
    function exportReport(type) {
        const docName = `Report_${moment().format('YYYY-MM-DD')}`;
        if (type === 'pdf') {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Financial Intelligence Report", 14, 15);
            doc.setFontSize(10);
            doc.text(`Generated: ${moment().format('LLL')}`, 14, 22);
            const headers = [["Metric", "Value", "Trend"]];
            const rows = [
                ["Revenue", document.getElementById('kpi-rev').innerText, document.getElementById('trend-rev').innerText],
                ["Margin", document.getElementById('kpi-mar').innerText, document.getElementById('trend-mar').innerText]
            ];
            doc.autoTable({ head: headers, body: rows, startY: 30 });
            doc.save(docName + '.pdf');
        } else if (type === 'excel') {
            const wb = XLSX.utils.book_new();
            let tbl = STATE.ctxType === 'TRIPLOG'
                ? document.getElementById('triplog-body')
                : document.getElementById('table-body');
            if (tbl) {
                const ws = XLSX.utils.table_to_sheet(tbl.parentNode);
                XLSX.utils.book_append_sheet(wb, ws, "Data");
                XLSX.writeFile(wb, docName + '.xlsx');
            }
        }
    }

    // --- DATA LOADERS ---
    document.getElementById('fileInput').addEventListener('change', async (e) => {
        const files = e.target.files;
        if (!files.length) return;
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data, { type: 'array' });
            if (file.name.includes("Comb") || file.name.includes("Trip")) {
                const rows = XLSX.utils.sheet_to_json(
                    workbook.Sheets[workbook.SheetNames[0]],
                    { header: 1 }
                );
                processTripLog(rows);
            } else {
                let company = "Deluxe";
                if (file.name.includes("DMT")) company = "DMT";
                workbook.SheetNames.forEach((name) => {
                    const target = SHEET_MAP[name.trim().toUpperCase()];
                    if (target)
                        processSheetData(
                            XLSX.utils.sheet_to_json(workbook.Sheets[name], { header: 1 }),
                            company,
                            target
                        );
                });
            }
        }
        finishLoad();
        e.target.value = '';
    });

    async function initDropbox() {
        setText('status-indicator', 'Syncing...');
        try {
            for (const cfg of DROPBOX_CONFIG) {
                const res = await fetch(
                    'https://content.dropboxapi.com/2/sharing/get_shared_link_file',
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${DBX_TOKEN}`,
                            'Dropbox-API-Arg': JSON.stringify({ url: cfg.link })
                        }
                    }
                );
                if (!res.ok) continue;
                const data = await res.arrayBuffer();
                const wb = XLSX.read(data, { type: 'array' });
                if (cfg.type === 'triplog')
                    processTripLog(
                        XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {
                            header: 1
                        })
                    );
                else
                    wb.SheetNames.forEach((n) => {
                        const t = SHEET_MAP[n.trim().toUpperCase()];
                        if (t)
                            processSheetData(
                                XLSX.utils.sheet_to_json(wb.Sheets[n], { header: 1 }),
                                cfg.company,
                                t
                            );
                    });
            }
            finishLoad();
        } catch (e) {
            console.error(e);
            setText('status-indicator', 'Error');
        }
    }

    function finishLoad() {
        buildNavigation();
        populateDriverSelect();
        setText('status-indicator', 'Live');
        document.getElementById('ui-empty').classList.add('hidden');
        const saved = JSON.parse(localStorage.getItem('lastContext'));
        setDatePreset(7);
        if (saved) switchContext(saved.type, saved.comp, saved.loc);
        else switchContext('ALL', 'Overview', 'Overview');
    }

    function cleanMoney(val) {
        if (!val) return 0;
        let s = val.toString();
        let isNeg = s.includes('(') || s.includes('-');
        let n = parseFloat(s.replace(/[^0-9.]/g, ''));
        return isNaN(n) ? 0 : isNeg ? -n : n;
    }

    function processSheetData(rows, company, location) {
        const key = `${company}_${location}`;
        const weeks = [],
            drivers = [];
        const today = moment();
        let colMap = {
            name: 0,
            drPay: 5,
            drRev: 11,
            drMar: 12,
            drPct: 13,
            date: 15,
            pay: 19,
            fuel: 20,
            ins: 21,
            maint: 22,
            exp: 24,
            rev: 25,
            mar: 26,
            pct: 27
        };
        for (let r = 0; r < Math.min(rows.length, 10); r++) {
            const row = rows[r] || [];
            for (let c = 10; c < 30; c++) {
                if (row[c] && String(row[c]).toLowerCase().includes('start date')) {
                    colMap = {
                        ...colMap,
                        date: c,
                        pay: c + 4,
                        fuel: c + 5,
                        ins: c + 6,
                        maint: c + 7,
                        exp: c + 9,
                        rev: c + 10,
                        mar: c + 11,
                        pct: c + 12
                    };
                    break;
                }
            }
        }
        for (let i = 2; i < rows.length; i++) {
            const r = rows[i];
            if (!r) continue;
            if (r[colMap.name] && String(r[colMap.name]).length > 2 && r[colMap.drPct])
                drivers.push({
                    name: r[colMap.name],
                    payroll: cleanMoney(r[colMap.drPay]),
                    rev: cleanMoney(r[colMap.drRev]),
                    margin: cleanMoney(r[colMap.drMar]),
                    pct: r[colMap.drPct]
                });
            const dVal = r[colMap.date];
            if (dVal) {
                let mDate =
                    typeof dVal === 'number'
                        ? moment(
                              new Date(Math.round((dVal - 25569) * 86400 * 1000))
                          )
                        : moment(dVal, ['M/D/YYYY', 'YYYY-MM-DD']);
                if (
                    mDate.isValid() &&
                    mDate.year() > 2000 &&
                    mDate.isBefore(today.clone().add(1, 'day'))
                )
                    weeks.push({
                        date: mDate.format('YYYY-MM-DD'),
                        displayDate: mDate.format('MMM D, YYYY'),
                        company,
                        location,
                        payroll: cleanMoney(r[colMap.pay]),
                        fuel: cleanMoney(r[colMap.fuel]),
                        totalExp: cleanMoney(r[colMap.exp]),
                        revenue: cleanMoney(r[colMap.rev]),
                        margin: cleanMoney(r[colMap.mar]),
                        marginPct: r[colMap.pct]
                    });
            }
        }
        if (weeks.length) STATE.data[key] = { weeks, drivers };
    }

    // --- TRIP LOG PROCESSOR (Comb sheet mapping) ---
    function processTripLog(rows) {
        STATE.tripLog = [];
        for (let i = 3; i < rows.length; i++) {
            const r = rows[i];
            if (!r || !r[5]) continue; // need driver name

            let dStr = r[10];
            let mDate = null;
            if (dStr && dStr !== '1/0/1900') {
                if (typeof dStr === 'number') {
                    mDate = moment(
                        new Date(Math.round((dStr - 25569) * 86400 * 1000))
                    );
                } else {
                    mDate = moment(dStr);
                }
            }
            const safeDate = mDate && mDate.isValid() ? mDate : null;

            // Column mapping: Fare = AS (44), Cost = AU (46), Profit = AP (41)
            const fare = cleanMoney(r[44]);
            const cost = cleanMoney(r[46]);
            const profit =
                r[41] !== undefined &&
                r[41] !== null &&
                String(r[41]).toString().trim() !== ''
                    ? cleanMoney(r[41])
                    : fare - cost;

            const miles = cleanMoney(r[23]);
            const fuelOps = miles * 3.6;
            const marginPct = fare ? ((profit / fare) * 100).toFixed(1) : 0;

            STATE.tripLog.push({
                name: r[5],
                acct: r[6] || '-',
                bookId: r[7] || '-',
                pax: r[8] || '-',
                date: safeDate ? safeDate.format('YYYY-MM-DD') : '',
                displayDate: safeDate ? safeDate.format('MMM D HH:mm') : '-',
                pickup: r[12] || '',
                dropoff: r[17] || '',
                notes: r[22] || '',
                dispute: r[35] || '',
                miles,
                fare,
                totalCost: cost,
                fuelOps,
                profit,
                marginPct
            });
        }
        STATE.filteredTripLog = STATE.tripLog;
        updateTripLogView();
        populateDriverSelect();
    }

    function updateAllViews() {
        if (STATE.ctxType === 'TRIPLOG') updateTripLogView();
        else if (STATE.ctxType === 'DRIVER') updateDriverView();
        else updateDashboard();
    }

    function updateDashboard() {
        let allWeeks = [],
            allDrivers = [];
        Object.keys(STATE.data).forEach((key) => {
            const [dComp, dLoc] = key.split('_');
            const block = STATE.data[key];
            let match = false;
            if (STATE.ctxType === 'ALL') match = !block.weeks[0]?.isSummary;
            else if (STATE.ctxType === 'COMPANY')
                match = dComp === STATE.ctxComp && !block.weeks[0]?.isSummary;
            else if (STATE.ctxType === 'LOCATION')
                match = dComp === STATE.ctxComp && dLoc === STATE.ctxLoc;
            if (match) {
                allWeeks = [...allWeeks, ...block.weeks];
                allDrivers = [...allDrivers, ...block.drivers];
            }
        });

        // Fallback placeholder if no finance data but triplog exists
        if (allWeeks.length === 0 && STATE.tripLog.length > 0) {
            // could aggregate trips into weeks here if needed
        }

        let currentData = allWeeks;
        let previousData = [];
        let subtitle = "All Time";

        if (STATE.dateRange) {
            const s = moment(STATE.dateRange[0]).startOf('day');
            const e = moment(STATE.dateRange[1]).endOf('day');
            subtitle = `${s.format('MMM D')} - ${e.format('MMM D')}`;
            currentData = allWeeks.filter((d) =>
                moment(d.date).isBetween(s, e, undefined, '[]')
            );
            if (STATE.compareMode) {
                const days = e.diff(s, 'days') + 1;
                const prevS = moment(s).subtract(days, 'days');
                const prevE = moment(e).subtract(days, 'days');
                previousData = allWeeks.filter((d) =>
                    moment(d.date).isBetween(prevS, prevE, undefined, '[]')
                );
                subtitle += ` vs Prev ${days} Days`;
            }
        }
        document.getElementById('chart-subtitle').innerText = subtitle;
        setText('record-count-debug', `${currentData.length} Weeks`);

        updateKPIs(currentData, previousData);
        updateCharts(currentData, allDrivers);
        updateTables(currentData, allDrivers);

        const driverSelect = document.getElementById('adv-driver-select');
        if (driverSelect && allDrivers.length > 0) {
            const uniqueDrivers = [...new Set(allDrivers.map((d) => d.name))].sort();
            driverSelect.innerHTML =
                '<option value="">All Drivers</option>' +
                uniqueDrivers.map((d) => `<option value="${d}">${d}</option>`).join('');
        }
    }

    function updateKPIs(curr, prev = []) {
        const sum = (arr, prop) => arr.reduce((a, b) => a + (b[prop] || 0), 0);
        const animate = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.innerText = FMT.format(val);
        };
        const rev = sum(curr, 'revenue'),
            exp = sum(curr, 'totalExp'),
            mar = sum(curr, 'margin');

        animate('kpi-rev', rev);
        animate('kpi-exp', exp);
        animate('kpi-mar', mar);
        document.getElementById('kpi-ratio').innerText = rev
            ? ((exp / rev) * 100).toFixed(1) + '%'
            : '0%';

        if (STATE.compareMode && prev.length > 0) {
            const pRev = sum(prev, 'revenue'),
                pMar = sum(prev, 'margin');
            renderTrend('trend-rev', rev, pRev);
            renderTrend('trend-mar', mar, pMar);
        } else {
            ['trend-rev', 'trend-exp', 'trend-mar'].forEach(
                (id) =>
                    (document.getElementById(id).innerHTML =
                        '<span class="text-gray-600">-</span>')
            );
        }
    }

    function renderTrend(id, curr, prev, inverse = false) {
        const diff = curr - prev;
        const pct = prev ? ((diff / prev) * 100).toFixed(1) : 0;
        const isGood = inverse ? diff < 0 : diff > 0;
        document.getElementById(id).innerHTML = `<div class="${
            isGood ? 'text-green-500' : 'text-red-500'
        } flex items-center gap-1 text-xs font-bold"><i class="ph-bold ${
            diff > 0 ? 'ph-trend-up' : 'ph-trend-down'
        }"></i> ${Math.abs(pct)}%</div>`;
    }

    // --- CHARTS & TABLES ---
    let charts = {};
    function destroyChart(id) {
        if (charts[id]) {
            charts[id].destroy();
            delete charts[id];
        }
    }

    function updateCharts(weeks, drivers) {
        destroyChart('trend');
        destroyChart('costRadial');
        destroyChart('costStack');
        destroyChart('driverMargin');
        destroyChart('waterfall');
        destroyChart('heatmap');

        const agg = {};
        weeks.forEach((d) => {
            if (!agg[d.date]) agg[d.date] = { r: 0, e: 0, m: 0, p: 0, f: 0 };
            agg[d.date].r += d.revenue;
            agg[d.date].e += d.totalExp;
            agg[d.date].m += d.margin;
            agg[d.date].p += d.payroll;
            agg[d.date].f += d.fuel;
        });
        const dates = Object.keys(agg).sort();

        // Trend chart (labels OFF)
        charts.trend = new Chart(document.getElementById('chartTrend'), {
            type: 'line',
            data: {
                labels: dates.map((d) => moment(d).format('MMM D')),
                datasets: [
                    {
                        label: 'Rev',
                        data: dates.map((d) => agg[d].r),
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59,130,246,0.1)',
                        fill: true,
                        tension: 0.3
                    },
                    {
                        label: 'Exp',
                        data: dates.map((d) => agg[d].e),
                        borderColor: '#ef4444',
                        borderDash: [4, 4],
                        tension: 0.3
                    },
                    {
                        label: 'Margin',
                        data: dates.map((d) => agg[d].m),
                        type: 'bar',
                        backgroundColor: (c) => (c.raw < 0 ? '#ef4444' : '#10b981'),
                        barThickness: 8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: (c) =>
                                ` ${c.dataset.label}: ${FMT.format(c.raw)}`
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: {
                        grid: { color: '#333' },
                        ticks: { callback: (v) => K_FMT(v) }
                    }
                }
            }
        });

        // Cash flow waterfall (labels OFF so no text on bars)
        const rev = weeks.reduce((a, b) => a + b.revenue, 0);
        let tots = { p: 0, f: 0, i: 0, m: 0 };
        weeks.forEach((d) => {
            tots.p += d.payroll || 0;
            tots.f += d.fuel || 0;
            tots.i += d.insurance || 0;
            tots.m += d.maint || 0;
        });
        charts.waterfall = new Chart(document.getElementById('chartWaterfall'), {
            type: 'bar',
            data: {
                labels: ['Revenue', 'Payroll', 'Fuel', 'Net Profit'],
                datasets: [
                    {
                        data: [rev, -tots.p, -tots.f, rev - tots.p - tots.f],
                        backgroundColor: (c) =>
                            c.raw > 0 ? '#10b981' : '#ef4444'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    datalabels: { display: false }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: {
                        grid: { color: '#333' },
                        ticks: { callback: (v) => K_FMT(v) }
                    }
                }
            }
        });

        // Profit heatmap (labels OFF)
        charts.heatmap = new Chart(document.getElementById('chartHeatmap'), {
            type: 'bar',
            data: {
                labels: dates.slice(-7).map((d) => moment(d).format('ddd')),
                datasets: [
                    {
                        label: 'Profit',
                        data: dates.slice(-7).map((d) => agg[d].m),
                        backgroundColor: dates
                            .slice(-7)
                            .map((d) =>
                                agg[d].m > 0 ? '#10b981' : '#ef4444'
                            )
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { grid: { display: false } },
                    y: { display: false }
                },
                plugins: {
                    legend: { display: false },
                    datalabels: { display: false }
                }
            }
        });

        // Cost structure doughnut
        charts.costRadial = new Chart(
            document.getElementById('chartCostRadial'),
            {
                type: 'doughnut',
                data: {
                    labels: ['Payroll', 'Fuel', 'Ins', 'Maint'],
                    datasets: [
                        {
                            data: [tots.p, tots.f, tots.i, tots.m],
                            backgroundColor: [
                                '#3b82f6',
                                '#ef4444',
                                '#f59e0b',
                                '#10b981'
                            ],
                            borderWidth: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    layout: { padding: 0 },
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#999',
                                boxWidth: 10,
                                usePointStyle: true
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            formatter: (v, ctx) => {
                                let sum = ctx.dataset.data.reduce(
                                    (a, b) => a + b,
                                    0
                                );
                                return sum && v / sum > 0.05
                                    ? ((v * 100) / sum).toFixed(0) + '%'
                                    : '';
                            }
                        }
                    }
                }
            }
        );

        // Top driver margin (labels OFF so no text on bars)
        const dAgg = {};
        drivers.forEach((d) => {
            if (!dAgg[d.name]) dAgg[d.name] = { mar: 0 };
            dAgg[d.name].mar += d.margin;
        });
        const top = Object.entries(dAgg)
            .map(([k, v]) => ({ name: k, ...v }))
            .sort((a, b) => b.mar - a.mar)
            .slice(0, 10);

        charts.driverMargin = new Chart(
            document.getElementById('chartDriverMargin'),
            {
                type: 'bar',
                data: {
                    labels: top.map((d) => d.name.split(' ')[0]),
                    datasets: [
                        {
                            label: 'Margin',
                            data: top.map((d) => d.mar),
                            backgroundColor: top.map((d) =>
                                d.mar < 0 ? '#ef4444' : '#10b981'
                            ),
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: '#333' } },
                        y: { grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        datalabels: { display: false }
                    }
                }
            }
        );
    }

    function updateTables(weeks, drivers) {
        const sorted = [...weeks].sort(
            (a, b) => new Date(b.date) - new Date(a.date)
        );
        document.getElementById('table-body').innerHTML = sorted
            .slice(0, 100)
            .map(
                (d) => `<tr class="hover:bg-[#222] transition-colors border-b border-[#2a2a2a]">
                    <td class="p-3 text-white font-mono">${d.displayDate}</td>
                    <td class="p-3 text-right text-red-400 font-bold">${FMT.format(
                        d.totalExp
                    )}</td>
                    <td class="p-3 text-right text-blue-400 font-bold">${FMT.format(
                        d.revenue
                    )}</td>
                    <td class="p-3 text-right font-bold ${
                        d.margin < 0 ? 'text-red-500' : 'text-green-500'
                    }">${FMT.format(d.margin)}</td>
                    <td class="p-3 text-right text-xs text-gray-400">${
                        d.marginPct || '-'
                    }</td>
                </tr>`
            )
            .join('');

        const dAgg = {};
        drivers.forEach((d) => {
            if (!dAgg[d.name]) dAgg[d.name] = { rev: 0, pay: 0, mar: 0 };
            dAgg[d.name].rev += d.rev;
            dAgg[d.name].pay += d.payroll;
            dAgg[d.name].mar += d.margin;
        });
        const drvSorted = Object.entries(dAgg)
            .map(([k, v]) => ({ name: k, ...v }))
            .sort((a, b) => b.mar - a.mar);
        document.getElementById('driver-table-body').innerHTML = drvSorted
            .slice(0, 100)
            .map((d) => {
                const score = d.rev
                    ? ((d.mar / d.rev) * 100).toFixed(0)
                    : 0;
                return `<tr class="hover:bg-[#222] transition-colors border-b border-[#2a2a2a]">
                    <td class="p-3 text-white font-bold text-xs">${d.name}</td>
                    <td class="p-3 text-right text-gray-500 text-xs">${FMT.format(
                        d.pay
                    )}</td>
                    <td class="p-3 text-right text-blue-400 text-xs">${FMT.format(
                        d.rev
                    )}</td>
                    <td class="p-3 text-right font-bold text-xs ${
                        d.mar < 0 ? 'text-red-500' : 'text-green-500'
                    }">${FMT.format(d.mar)}</td>
                    <td class="p-3 text-right text-xs font-bold ${
                        score < 0 ? 'text-red-500' : 'text-blue-400'
                    }">${score}%</td>
                </tr>`;
            })
            .join('');
    }

    // --- TRIPLOG VIEW ---
    function handleTripSearch() {
        const search = document
            .getElementById('triplog-search')
            .value.toLowerCase();
        STATE.filteredTripLog = STATE.tripLog.filter((d) =>
            (d.name + d.acct + d.bookId).toLowerCase().includes(search)
        );
        updateTripLogView();
    }

    function sortTripLog(field) {
        STATE.tripSort = field;
        STATE.filteredTripLog.sort((a, b) =>
            field === 'date'
                ? new Date(b.date) - new Date(a.date)
                : field === 'profit'
                ? b.profit - a.profit
                : a[field].localeCompare(b[field])
        );
        updateTripLogView();
    }

    function updateTripLogView() {
        let data = STATE.filteredTripLog;
        if (STATE.dateRange) {
            const s = moment(STATE.dateRange[0]).startOf('day');
            const e = moment(STATE.dateRange[1]).endOf('day');
            data = data.filter((d) =>
                moment(d.date).isBetween(s, e, undefined, '[]')
            );
        }
        if (STATE.activeFilter === 'loss') data = data.filter((d) => d.profit < 0);
        if (STATE.activeFilter === 'profit')
            data = data.filter((d) => d.profit > 100);
        if (STATE.activeFilter === 'long') data = data.filter((d) => d.miles > 50);

        const losses = data.filter((d) => d.profit < 0);
        setText(
            'loss-total',
            FMT.format(losses.reduce((a, b) => a + b.profit, 0))
        );
        setText('loss-count', `${losses.length} Neg Trips`);

        const dLoss = {};
        losses.forEach((d) => {
            dLoss[d.name] = (dLoss[d.name] || 0) + d.profit;
        });
        const worstD =
            Object.entries(dLoss).sort((a, b) => a[1] - b[1])[0] || ['-', 0];
        setText('loss-driver-name', worstD[0]);
        setText('loss-driver-amt', FMT.format(worstD[1]));

        const aLoss = {};
        losses.forEach((d) => {
            aLoss[d.acct] = (aLoss[d.acct] || 0) + d.profit;
        });
        const worstA =
            Object.entries(aLoss).sort((a, b) => a[1] - b[1])[0] || ['-', 0];
        setText('loss-acct-name', worstA[0]);
        setText('loss-acct-amt', FMT.format(worstA[1]));

        setText('loss-alert-date', 'No Alerts');
        setText('loss-alert-amt', 'All days OK');

        const tbody = document.getElementById('triplog-body');
        setText('triplog-count', `${data.length} Entries`);

        // Row cells now match header: Driver / Date / Account / Fare / Cost / Profit / Notes
        tbody.innerHTML = data
            .slice(0, 200)
            .map(
                (d) => `<tr class="hover:bg-[#222] border-b border-[#2a2a2a] ${
                    d.profit < 0 ? 'row-loss' : ''
                }">
                <td class="p-3 text-white font-bold">${d.name}</td>
                <td class="p-3 font-mono text-gray-400">${d.displayDate}</td>
                <td class="p-3 text-blue-400 font-mono font-bold">${d.acct}</td>
                <td class="p-3 text-right text-blue-400 font-mono font-bold">${FMT.format(
                    d.fare
                )}</td>
                <td class="p-3 text-right text-yellow-500 font-mono">${FMT.format(
                    d.totalCost
                )}</td>
                <td class="p-3 text-right font-mono font-bold ${
                    d.profit < 0 ? 'text-loss' : 'text-profit'
                }">${FMT.format(d.profit)}</td>
                <td class="p-3 text-gray-500 text-[10px] truncate max-w-xs">${
                    d.notes
                }</td>
            </tr>`
            )
            .join('');
    }

    // --- NAVIGATION HELPERS ---
    function buildNavigation() {
        const container = document.getElementById('accordion-container');
        container.innerHTML = '';
        const favContainer = document.getElementById('favorites-container');
        favContainer.innerHTML = '';
        let hasFavs = false;
        const hierarchy = {};
        Object.keys(STATE.data).forEach((key) => {
            const [comp, loc] = key.split('_');
            if (!hierarchy[comp]) hierarchy[comp] = [];
            if (!hierarchy[comp].includes(loc)) hierarchy[comp].push(loc);
        });

        Object.keys(hierarchy).forEach((comp) => {
            const locs = hierarchy[comp].sort();
            const details = document.createElement('details');
            details.open = true;
            details.className =
                'group rounded-lg bg-[#252525] overflow-hidden border border-[#333] mb-2';
            details.innerHTML = `<summary onclick="switchContext('COMPANY', '${comp}', 'Overview')" class="nav-item flex items-center justify-between px-3 py-2 bg-[#222] text-xs text-gray-400 select-none border-b border-[#333]">
                    <div class="flex items-center gap-2">
                        <i class="ph-bold ph-buildings"></i>
                        <span class="font-bold">${comp}</span>
                    </div>
                    <i class="ph-bold ph-caret-down arrow"></i>
                </summary>
                <div class="p-1 space-y-0.5 bg-[#1e1e1e]">
                    ${locs
                        .map((loc) => {
                            const isFav = STATE.favorites.includes(
                                `${comp}|${loc}`
                            );
                            if (isFav) {
                                hasFavs = true;
                                favContainer.innerHTML += `<div onclick="switchContext('LOCATION', '${comp}', '${loc}')" class="nav-item flex items-center gap-2 px-3 py-1.5 rounded text-xs text-yellow-500 hover:text-white pl-3 border-l-2 border-yellow-500 bg-yellow-900/10 mb-1">
                                        <i class="ph-fill ph-star text-yellow-500"></i>
                                        <span>${loc} (${comp})</span>
                                    </div>`;
                            }
                            return `<div class="nav-item flex items-center justify-between px-3 py-1.5 rounded text-xs text-gray-500 hover:text-white pl-8 group/item">
                                    <div onclick="switchContext('LOCATION', '${comp}', '${loc}')" class="flex items-center gap-2 flex-1">
                                        <i class="ph-fill ph-map-pin"></i>
                                        <span>${loc}</span>
                                    </div>
                                    <i onclick="toggleFavorite('${comp}','${loc}')" class="ph-fill ph-star fav-icon ${
                                isFav ? 'active' : ''
                            }"></i>
                                </div>`;
                        })
                        .join('')}
                </div>`;
            container.appendChild(details);
        });
        document
            .getElementById('favorites-section')
            .classList.toggle('hidden', !hasFavs);
    }

    function toggleFavorite(comp, loc) {
        const key = `${comp}|${loc}`;
        if (STATE.favorites.includes(key))
            STATE.favorites = STATE.favorites.filter((k) => k !== key);
        else STATE.favorites.push(key);
        localStorage.setItem('favs', JSON.stringify(STATE.favorites));
        buildNavigation();
    }

    function switchContext(type, comp, loc) {
        STATE.ctxType = type;
        STATE.ctxComp = comp;
        STATE.ctxLoc = loc;
        localStorage.setItem('lastContext', JSON.stringify({ type, comp, loc }));
        document.querySelectorAll('.nav-item').forEach((el) =>
            el.classList.remove('active')
        );

        if (type === 'TRIPLOG') {
            document.getElementById('nav-triplog').classList.add('active');
            document.getElementById('ui-dashboard').classList.add('hidden');
            document.getElementById('ui-triplog').classList.remove('hidden');
            document.getElementById('filter-bar').classList.remove('hidden');
            document.getElementById('page-title').innerText = "Trip Logs";
            updateTripLogView();
            return;
        }
        if (type === 'DRIVER') {
            document.getElementById('nav-driver').classList.add('active');
            document.getElementById('ui-dashboard').classList.add('hidden');
            document.getElementById('ui-triplog').classList.add('hidden');
            document.getElementById('filter-bar').classList.add('hidden');
            document.getElementById('page-title').innerText = "Driver Perf";
            return;
        }

        document.getElementById('ui-triplog').classList.add('hidden');
        document.getElementById('ui-dashboard').classList.remove('hidden');
        document.getElementById('filter-bar').classList.add('hidden');
        document.getElementById('bc-company').innerText = comp;
        document.getElementById('bc-location').innerText = loc;
        document.getElementById('page-title').innerText =
            loc === 'Overview' ? comp : loc;
        updateDashboard();
    }

    function populateDriverSelect() {
        const select = document.getElementById('adv-driver-select');
        if (!select) return;
        const drivers = [...new Set(STATE.tripLog.map((d) => d.name))].sort();
        select.innerHTML =
            '<option value="">All Drivers</option>' +
            drivers.map((d) => `<option value="${d}">${d}</option>`).join('');
    }

    function updateDriverView() {}
</script>

</body>
</html>



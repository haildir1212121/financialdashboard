<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NEMT Dashboard — DLX</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* GLOBAL */
    html, body { height:100%; }
    body { 
      font-family: 'Inter', system-ui, sans-serif; 
      background: #050505; 
      background-image: radial-gradient(circle at 50% 0%, #16161a 0%, #050505 70%);
      color: #e2e8f0; 
      overflow: hidden; 
    }

    /* CARDS */
    .panel { 
      background: rgba(10, 10, 10, 0.75); 
      backdrop-filter: blur(16px); 
      border: 1px solid rgba(255,255,255,0.08); 
    }
    .card  { 
      background: rgba(255, 255, 255, 0.03); 
      border: 1px solid rgba(255,255,255,0.05); 
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      transition: all 0.2s ease;
    }
    .card:hover { border-color: rgba(255,255,255,0.12); background: rgba(255,255,255,0.05); }
    
    /* SCROLLBARS */
    .thin-scroll::-webkit-scrollbar{ width:5px; height:5px; }
    .thin-scroll::-webkit-scrollbar-track{ background: transparent; }
    .thin-scroll::-webkit-scrollbar-thumb{ background: #333; border-radius: 99px; }
    .thin-scroll::-webkit-scrollbar-thumb:hover{ background: #555; }

    .navbtn { width:100%; text-align:left; padding:8px 10px; border-radius:8px; border:1px solid transparent; transition: all 0.2s; color: #94a3b8; font-size: 0.8rem; }
    .navbtn:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .navbtn.active { 
      background: rgba(99, 102, 241, 0.15); 
      border-color: rgba(99, 102, 241, 0.3); 
      color: #818cf8; 
      font-weight: 600; 
    }

    .view-hidden { opacity: 0; pointer-events: none; position: absolute; width: 100%; }
    .hiddenView { display:none !important; }
    .hidden { display: none !important; }
    
    /* CHART TOGGLES */
    .chart-toggle { 
      padding: 4px 8px; font-size: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; 
      color: rgba(255,255,255,0.5); background: transparent; text-transform: uppercase; font-weight: 700; 
      transition: all 0.2s; cursor: pointer;
    }
    .chart-toggle:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .chart-toggle.active { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; border-color: rgba(99, 102, 241, 0.4); }
    
    /* CYCLE BUTTON */
    .cycle-btn {
      display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 8px;
      font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em;
      color: #a5b4fc; background: rgba(99, 102, 241, 0.15); border: 1px solid rgba(99, 102, 241, 0.3);
      transition: all 0.2s; cursor: pointer; select-none: none; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }
    .cycle-btn:hover { background: rgba(99, 102, 241, 0.25); border-color: rgba(99, 102, 241, 0.5); color: #fff; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
    .cycle-btn:active { transform: translateY(1px); }
  </style>
</head>

<body>
  <div class="mx-auto max-w-[1800px] h-full p-2 lg:p-4">
    <div class="panel rounded-2xl overflow-hidden h-full flex flex-col lg:flex-row shadow-2xl">

      <aside class="w-full lg:w-[260px] flex-shrink-0 border-b lg:border-b-0 lg:border-r border-white/10 bg-[#080808] flex flex-col h-full">
        <div class="p-4 border-b border-white/5">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-lg bg-gradient-to-br from-indigo-600/30 to-purple-600/30 border border-white/10 grid place-items-center shadow-lg shadow-indigo-900/20">
              <span id="brandBadge" class="font-extrabold tracking-wide text-indigo-400 text-xs">DLX</span>
            </div>
            <div>
              <div class="text-sm font-bold tracking-tight text-white">Dashboard</div>
              <div class="text-[10px] text-white/40 font-medium">Management Console</div>
            </div>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto thin-scroll p-2 space-y-4">
          <div>
            <div class="text-[9px] uppercase tracking-widest text-white/30 font-bold mb-1 pl-2">Views</div>
            <div class="space-y-0.5">
              <button class="navbtn active group flex items-center gap-2" data-view="overview" onclick="setView('overview')">
                <svg class="w-3.5 h-3.5 opacity-60 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                Overview
              </button>
              <button class="navbtn group flex items-center gap-2" data-view="drivers" onclick="setView('drivers')">
                 <svg class="w-3.5 h-3.5 opacity-60 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                 Drivers
              </button>
            </div>
          </div>

          <div>
            <div class="flex items-center justify-between mb-1 pl-2 pr-1">
              <div class="text-[9px] uppercase tracking-widest text-white/30 font-bold">Driver Roster</div>
              <div class="text-[9px] text-white/20" id="regionCountLabel">...</div>
            </div>
            <div id="regionTreeList" class="space-y-0.5"></div>
            <div class="mt-4 pt-2 border-t border-white/5">
                              <div id="archiveList" class="hidden space-y-0.5 mt-1 pl-2 border-l border-white/5 ml-2"></div>
            </div>
          </div>
        </div>

        <div class="p-3 border-t border-white/5 bg-black/30">
          <div class="text-[9px] text-white/30 mb-2 truncate" id="lastSyncLabel">Waiting for sync...</div>
          <div class="flex gap-2">
            <button id="refreshBtn" class="flex-1 rounded bg-white/5 border border-white/10 py-1.5 text-[10px] font-semibold text-white/70 hover:bg-white/10 hover:text-white transition">SYNC</button>
            <button id="exportBtn" class="flex-1 rounded bg-white/5 border border-white/10 py-1.5 text-[10px] font-semibold text-white/70 hover:bg-white/10 hover:text-white transition">EXPORT</button>
          </div>
        </div>
      </aside>

      <section class="flex-1 flex flex-col h-full relative overflow-hidden bg-black/20">
        <div class="p-4 border-b border-white/10 flex-shrink-0 z-10 bg-[#0a0a0a]/80 backdrop-blur-md">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <div id="dashTitle" class="text-lg font-bold tracking-tight text-white">Weekly Performance</div>
              <div id="activeContextLabel" class="text-xs font-medium text-indigo-400 mt-0.5 flex items-center gap-2">Global • Overview</div>
            </div>
            <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2">
                <div class="text-[10px] uppercase tracking-widest text-white/30 font-bold">Data</div>
                <button id="dataToggleBtn" onclick="toggleDataSource()"
                  class="bg-white/5 border border-white/10 text-white/80 text-[11px] font-semibold rounded-lg px-3 py-1 hover:bg-white/10 transition focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
                  <span id="dataToggleLabel">DLX</span>
                </button>
              </div>

              <button id="kpiCycleBtn" onclick="cycleKpiMode()" class="cycle-btn shadow-lg shadow-indigo-500/10">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                <span id="kpiCycleLabel">Weekly View</span>
              </button>
            </div>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto thin-scroll p-4 scroll-smooth">

          <div id="view-overview" class="view-container pb-10 space-y-3">
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
              <div class="card rounded-2xl p-4 relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/10 rounded-full blur-2xl group-hover:bg-blue-500/20 transition"></div>
                <div class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1">Total Revenue</div>
                <div id="kpiRevenue" class="text-2xl font-bold text-white tracking-tight">—</div>
                <div id="kpiRevenueLabel" class="text-[10px] text-white/30 mt-0.5">Current Week</div>
              </div>
              <div class="card rounded-2xl p-4 relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/10 rounded-full blur-2xl group-hover:bg-emerald-500/20 transition"></div>
                <div class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1">Net Margin ($)</div>
                <div id="kpiMargin" class="text-2xl font-bold tracking-tight text-white">—</div>
                <div id="kpiMarginLabel" class="text-[10px] text-white/30 mt-0.5 truncate">Profit</div>
              </div>
              <div class="card rounded-2xl p-4 relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-indigo-500/10 rounded-full blur-2xl group-hover:bg-indigo-500/20 transition"></div>
                <div class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1">Margin (%)</div>
                <div id="kpiPctMargin" class="text-2xl font-bold text-white tracking-tight">—</div>
                <div id="kpiPctMarginLabel" class="text-[10px] text-white/30 mt-0.5 truncate">Efficiency</div>
              </div>
              <div class="card rounded-2xl p-4 relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-purple-500/10 rounded-full blur-2xl group-hover:bg-purple-500/20 transition"></div>
                <div class="text-[10px] uppercase tracking-wider text-white/50 font-bold mb-1">Projected Margin</div>
                <div id="kpiProjected" class="text-2xl font-bold text-white tracking-tight">—</div>
                <div id="kpiProjectedLabel" class="text-[10px] text-white/30 mt-0.5 truncate">Annual Run Rate</div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
              <div class="card rounded-2xl p-5 lg:col-span-2 flex flex-col">
                <div class="flex flex-wrap items-end justify-between mb-4">
                   <div class="flex items-end gap-3">
                      <div>
                         <h3 class="text-xs font-bold text-white/50 uppercase tracking-widest mb-1">Trend Analysis</h3>
                         <h4 id="trendBigNumber" class="text-3xl font-bold text-white leading-none">$0</h4>
                      </div>
                      <div id="trendPercent" class="text-sm font-bold mb-0.5 text-white/50">—%</div>
                   </div>
                   <div class="flex gap-1 bg-white/5 p-0.5 rounded-lg">
                      <button class="chart-toggle active" id="btnTrendPct" onclick="setTrendMode('pct')">Margin %</button>
                      <button class="chart-toggle" id="btnTrendNet" onclick="setTrendMode('net')">Net $</button>
                      <button class="chart-toggle" id="btnTrendRev" onclick="setTrendMode('rev')">Rev $</button>
                   </div>
                </div>
                <div class="relative flex-1 min-h-[220px]">
                  <canvas id="trendChart"></canvas>
                </div>
              </div>

              <div class="card rounded-2xl p-0 flex flex-col overflow-hidden h-[380px]">
                <div class="p-3 border-b border-white/5 bg-white/5 flex justify-between items-center">
                  <div class="text-xs font-bold text-white">Driver Performance</div>
                  <div id="perfPeriodLabel" class="text-[10px] text-white/40">Viewed Period</div>
                </div>
                <div class="flex-1 overflow-y-auto thin-scroll relative p-3">
                    <div class="text-[9px] uppercase tracking-widest text-emerald-400 font-bold mb-2">Top 10 Performers</div>
                    <div id="topDriversList" class="space-y-1 mb-4"></div>
                    <div class="text-[9px] uppercase tracking-widest text-rose-400 font-bold mb-2">Bottom 10 Performers</div>
                    <div id="bottomDriversList" class="space-y-1"></div>
                </div>
              </div>
            </div>

            <div class="card rounded-2xl p-0 overflow-hidden flex flex-col max-h-[500px]">
              <div class="p-3 border-b border-white/5 flex justify-between items-center bg-white/5">
                <div class="font-bold text-xs">Weekly History</div>
                <div class="text-[10px] text-white/40">Full Record</div>
              </div>
              <div class="thin-scroll overflow-y-auto flex-1">
                <table class="w-full text-left text-xs border-collapse">
                  <thead class="sticky top-0 bg-[#121212] text-white/40 uppercase tracking-wider z-10 shadow-lg font-semibold">
                    <tr><th class="py-3 px-4">Week</th><th class="py-3 px-4">% Margin</th><th class="py-3 px-4">Revenue</th><th class="py-3 px-4">TL Exp</th><th class="py-3 px-4">Margin</th><th class="py-3 px-4">Signal</th></tr>
                  </thead>
                  <tbody id="lossTableBody" class="divide-y divide-white/5 text-white/80 font-mono"></tbody>
                </table>
              </div>
            </div>
          </div> 

          <div id="view-drivers" class="view-hidden hiddenView pb-10">
            <div id="driverTopPerformer" class="mb-3"></div>
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-3 h-full">
              <div class="card rounded-2xl p-0 overflow-hidden flex flex-col max-h-[75vh]">
                <div class="p-3 border-b border-white/5 bg-white/5">
                  <div class="font-bold text-xs">Driver History</div>
                  <div class="text-[10px] text-white/40">Aggregated Performance</div>
                </div>
                <div class="thin-scroll overflow-y-auto flex-1">
                  <table class="w-full text-left text-xs">
                    <thead class="sticky top-0 bg-[#121212] text-white/40 uppercase tracking-wider z-10">
                      <tr><th class="py-2 px-4">Week</th><th class="py-2 px-4">% Margin</th><th class="py-2 px-4">Revenue</th><th class="py-2 px-4">Margin</th><th class="py-2 px-4">Hours</th></tr>
                    </thead>
                    <tbody id="driverWeeklyBody" class="divide-y divide-white/5 text-white/80 font-mono"></tbody>
                  </table>
                </div>
              </div>
              <div class="card rounded-2xl p-0 overflow-hidden flex flex-col h-auto">
                <div class="p-3 border-b border-white/5 bg-white/5">
                  <div class="font-bold text-xs">Region Breakdown</div>
                  <div class="text-[10px] text-white/40">Latest Active Week</div>
                </div>
                <div class="thin-scroll overflow-y-auto flex-1">
                  <table class="w-full text-left text-xs">
                    <thead class="sticky top-0 bg-[#121212] text-white/40 uppercase tracking-wider z-10">
                      <tr><th class="py-2 px-4">Region</th><th class="py-2 px-4">Revenue</th><th class="py-2 px-4">Margin</th><th class="py-2 px-4">Hours</th></tr>
                    </thead>
                    <tbody id="driverRegionBody" class="divide-y divide-white/5 text-white/80 font-mono"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div> 
      </section>
    </div>
  </div>



<script>
  // ============================
  // CONFIGURATION
  // ============================
  const WORKER_URL_DLX = "https://withered-king-c48e.haildir12121.workers.dev/";
  const WORKER_URL_DMT = "https://spring-grass-bbc2.haildir12121.workers.dev/";

  const DATA_SOURCES = {
    DLX: { key: "DLX", label: "DLX", workerUrl: WORKER_URL_DLX },
    DMT: { key: "DMT", label: "DMT", workerUrl: WORKER_URL_DMT }
  };

  const OFFSETS = { 
    driver:0, hours:1, payroll:2, fuel:3, insurance:4, maintenance:5, 
    totalExp:7, revenue:8, margin:9 
  };

  const SCHEMAS = {
    DLX: {
      dateCol: "D", headerRow: 2,
      areas: [
        { id: "CST",   name: "Coast",    start: "E" },
        { id: "RBG",   name: "Roseburg", start: "P" },
        { id: "EUG",   name: "Eugene",   start: "AA" },
        { id: "OKRDG", name: "Oakridge", start: "AL" },
        { id: "ALBNY", name: "Albany",   start: "AW" },
        { id: "DMT",   name: "DMT",      start: "BR" } 
      ]
    },
    DMT: {
      dateCol: "D", headerRow: 2,
      areas: [
        { id: "CST",   name: "Coast",     start: "E" },
        { id: "RBG",   name: "Roseburg",  start: "P" },
        { id: "EUG",   name: "Eugene",    start: "AA" },
        { id: "NV",    name: "Nevada",    start: "AL" },
        { id: "ALBNY", name: "Albany",    start: "AW" },
        { id: "PDX",   name: "Portland",  start: "BG" },
        { id: "STR",   name: "Stretcher", start: "BR" }
      ]
    }
  };

  // ============================
  // STATE
  // ============================
  let activeDataSourceKey = localStorage.getItem("dash_data_source") || "DLX";
  let activeRegionId = "ALL";
  let activeDriver = "";
  let kpiMode = "week"; // 'week', 'this_q', 'last_q', 'this_y', 'last_y'
  let trendMode = "pct"; // 'pct', 'net', 'rev'

  let rawRows = [];     
  let weeklyData = [];  
  let driverData = {};  
  let regionList = [];  
  let chartInst = null;

  const dataCache = { 
    DLX: { loaded: false, rows: [], regions: [], hash: "" }, 
    DMT: { loaded: false, rows: [], regions: [], hash: "" } 
  };

  // Helpers
  function colToIndex(col) { let n=0; const s=String(col).toUpperCase().trim(); for(let i=0;i<s.length;i++) n=n*26+(s.charCodeAt(i)-64); return n-1; }
  function asDate(v) { if(v instanceof Date) return v; if(typeof v==="number") return new Date(Math.floor(v-25569)*86400000); return new Date(v); }
  function niceDate(d) { const dt=asDate(d); return dt && !isNaN(dt) ? `${dt.getMonth()+1}/${dt.getDate()}/${dt.getFullYear()}` : ""; }
  function safeNum(v) { const n = parseFloat(String(v).replace(/[^0-9.\-]/g,"")); return isFinite(n) ? n : 0; }
  function fmtUSD(n) { return (n||0).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}); }
  function simpleHash(b) { let h=0, a=new Uint8Array(b); for(let i=0; i<a.length; i+=50) h=(h<<5)-h+a[i]; return h; }

  function getWeekRange(dateObj) {
    const d = asDate(dateObj);
    const day = d.getDay(); 
    const diff = 6 - day; 
    const end = new Date(d); 
    end.setDate(d.getDate() + diff);
    const start = new Date(end);
    start.setDate(end.getDate() - 6);
    return { start, end, key: `${niceDate(start)}|${niceDate(end)}` };
  }

  // ============================
  // PARSING & SYNC
  // ============================
  async function syncAll() {
    const sl = document.getElementById("lastSyncLabel");
    if(sl) sl.textContent = "Syncing All...";
    
    await Promise.all([
        refreshDataSource("DLX"),
        refreshDataSource("DMT")
    ]);

    if(sl) sl.textContent = "Synced: " + new Date().toLocaleTimeString();
  }

  async function refreshDataSource(key, force=false) {
    const cache = dataCache[key];

    try {
      const res = await fetch(DATA_SOURCES[key].workerUrl, {cache: "no-store"});
      const buf = await res.arrayBuffer();
      const newHash = simpleHash(buf);
      
      if(!force && cache.loaded && cache.hash === newHash) {
        if(key === activeDataSourceKey) restoreFromCache(); 
        return;
      }

      const wb = XLSX.read(buf, {type:"array"});
      const ws = wb.Sheets["Running Sheet"];
      if(!ws) throw new Error(`Missing 'Running Sheet' in ${key}`);

      const schema = SCHEMAS[key];
      const aoa = XLSX.utils.sheet_to_json(ws, {header:1, defval:""});
      const dateIdx = colToIndex(schema.dateCol);
      
      let rows = [];
      let foundRegions = schema.areas.map(a => ({...a})); 
      foundRegions.forEach(a => a.startIdx = colToIndex(a.start));

      for(let r = schema.headerRow + 1; r < aoa.length; r++) {
        const row = aoa[r];
        if(!row) continue;
        const date = asDate(row[dateIdx]);
        if(!date || isNaN(date)) continue;

        foundRegions.forEach(area => {
          const base = area.startIdx;
          const driver = String(row[base + OFFSETS.driver] || "").trim();
          if(!driver) return;

          const rev = safeNum(row[base + OFFSETS.revenue]);
          const hrs = safeNum(row[base + OFFSETS.hours]);
          if(Math.abs(rev) < 0.1 && Math.abs(hrs) < 0.1) return;

          rows.push({
            date: date,
            regionId: area.id,
            regionName: area.name,
            driver: driver,
            revenue: rev,
            margin: safeNum(row[base + OFFSETS.margin]),
            totalExp: safeNum(row[base + OFFSETS.totalExp]),
            hours: hrs,
            week: getWeekRange(date)
          });
        });
      }

      cache.rows = rows;
      cache.regions = foundRegions;
      cache.loaded = true;
      cache.hash = newHash;

      if(key === activeDataSourceKey) {
        restoreFromCache();
      }

    } catch(err) {
      console.error(`Failed to load ${key}:`, err);
    }
  }

  function restoreFromCache() {
    const c = dataCache[activeDataSourceKey];
    if(!c || !c.loaded) return;
    rawRows = c.rows;
    regionList = c.regions;
    updateLabels();
    processData();
  }

  // ============================
  // AGGREGATION
  // ============================
  function processData() {
    // Filter by Region or Driver if selected
    let contextRows = rawRows;
    
    if (activeRegionId !== "ALL") {
        contextRows = contextRows.filter(r => r.regionId === activeRegionId);
    }
    
    if (activeDriver !== "") {
        contextRows = contextRows.filter(r => r.driver === activeDriver);
    }

    const weekMap = new Map();
    contextRows.forEach(r => {
      const k = r.week.key;
      if(!weekMap.has(k)) {
        weekMap.set(k, { weekStart: r.week.start, weekEnd: r.week.end, revenue:0, margin:0, totalExp:0, count:0, rows: [] });
      }
      const w = weekMap.get(k);
      w.revenue += r.revenue;
      w.margin += r.margin;
      w.totalExp += r.totalExp;
      w.count++;
      w.rows.push(r);
    });

    weeklyData = Array.from(weekMap.values()).sort((a,b) => b.weekEnd - a.weekEnd);
    weeklyData.forEach(w => w.pctMargin = w.revenue !== 0 ? (w.margin / w.revenue) * 100 : 0);

    // Build Driver Index (Global context for Roster)
    driverData = {};
    const globalRows = activeRegionId !== "ALL" ? rawRows.filter(r => r.regionId === activeRegionId) : rawRows;
    globalRows.forEach(r => {
      if(!driverData[r.driver]) driverData[r.driver] = { rows: [], risk: null };
      driverData[r.driver].rows.push(r);
    });

    renderUI();
  }

  function getKpiAggregates() {
    if(!weeklyData.length) return null;
    const anchorWeek = weeklyData[0];
    const anchorDate = anchorWeek.weekEnd;
    
    let start, end, prevStart, prevEnd;
    let label = "Current Week";

    if(kpiMode === 'week') {
      start = asDate(anchorWeek.weekStart);
      end = asDate(anchorWeek.weekEnd);
      
      // Prev week logic
      prevEnd = new Date(start); prevEnd.setDate(start.getDate() - 1);
      prevStart = new Date(prevEnd); prevStart.setDate(prevEnd.getDate() - 6);
      
      label = "Current Week";
    } else {
        const y = anchorDate.getFullYear();
        const m = anchorDate.getMonth();
        const q = Math.floor(m / 3);

        if(kpiMode === 'this_q') {
          start = new Date(y, q*3, 1); end = new Date(y, (q*3)+3, 0); label = "This Quarter";
          // Prev Q
          const pq = q-1 < 0 ? 3 : q-1; const py = q-1 < 0 ? y-1 : y;
          prevStart = new Date(py, pq*3, 1); prevEnd = new Date(py, (pq*3)+3, 0);
        } else if(kpiMode === 'last_q') {
          const lq = q-1 < 0 ? 3 : q-1; const ly = q-1 < 0 ? y-1 : y;
          start = new Date(ly, lq*3, 1); end = new Date(ly, (lq*3)+3, 0); label = "Last Quarter";
           // Prev Prev Q
           const ppq = lq-1 < 0 ? 3 : lq-1; const ppy = lq-1 < 0 ? ly-1 : ly;
           prevStart = new Date(ppy, ppq*3, 1); prevEnd = new Date(ppy, (ppq*3)+3, 0);
        } else if(kpiMode === 'this_y') {
          start = new Date(y, 0, 1); end = new Date(y, 11, 31); label = "This Year";
          prevStart = new Date(y-1, 0, 1); prevEnd = new Date(y-1, 11, 31);
        } else if(kpiMode === 'last_y') {
          start = new Date(y-1, 0, 1); end = new Date(y-1, 11, 31); label = "Last Year";
          prevStart = new Date(y-2, 0, 1); prevEnd = new Date(y-2, 11, 31);
        }
    }

    const agg = { revenue:0, margin:0, totalExp:0, rows:[], prevRevenue:0, prevMargin:0 };
    
    // Aggregation loop
    weeklyData.forEach(w => {
      // Current Period
      if(w.weekEnd >= start && w.weekEnd <= end) {
        agg.revenue += w.revenue; agg.margin += w.margin; agg.totalExp += w.totalExp;
        agg.rows = agg.rows.concat(w.rows);
      }
      // Previous Period (for comparison)
      if(w.weekEnd >= prevStart && w.weekEnd <= prevEnd) {
         agg.prevRevenue += w.revenue;
         agg.prevMargin += w.margin;
      }
    });

    agg.pctMargin = agg.revenue ? (agg.margin / agg.revenue)*100 : 0;
    agg.prevPctMargin = agg.prevRevenue ? (agg.prevMargin / agg.prevRevenue)*100 : 0;
    agg.label = label;
    return agg;
  }

  // ============================
  // RENDERING
  // ============================
  function renderUI() {
    renderRegionTree();
    updateLabels();
    
    // Always render overview (Driver view removed)
    renderOverview();
    
    // Hide old nav elements if they exist
    const dBtn = document.querySelector('[data-view="drivers"]');
    if(dBtn) dBtn.style.display = 'none';
    const oBtn = document.querySelector('[data-view="overview"]');
    if(oBtn) oBtn.click(); // Force click overview
  }

  function renderOverview() {
    const kpi = getKpiAggregates();
    
    if(!kpi) {
      document.getElementById("kpiRevenue").textContent = "—";
      return;
    }

    // --- CARDS ---
    document.getElementById("kpiRevenue").textContent = fmtUSD(kpi.revenue);
    document.getElementById("kpiRevenueLabel").textContent = kpi.label;
    document.getElementById("kpiMargin").textContent = fmtUSD(kpi.margin);
    
    const mP = document.getElementById("kpiPctMargin");
    mP.textContent = kpi.pctMargin.toFixed(2) + "%";
    mP.className = `text-2xl font-bold tracking-tight ${kpi.pctMargin<25?'text-rose-400':kpi.pctMargin<35?'text-amber-400':'text-emerald-400'}`;
    
    const projVal = kpiMode === 'week' ? kpi.margin * 52 : kpi.margin;
    document.getElementById("kpiProjected").textContent = fmtUSD(projVal);

    // --- TREND STATS FIX ---
    // Update the Big Number based on the selected mode
    let trendVal = 0, trendPrev = 0, trendLabel = "";
    if (trendMode === 'pct') { 
        trendVal = kpi.pctMargin; trendPrev = kpi.prevPctMargin; trendLabel = "%"; 
    } else if (trendMode === 'net') { 
        trendVal = kpi.margin; trendPrev = kpi.prevMargin; trendLabel = "$"; 
    } else if (trendMode === 'rev') { 
        trendVal = kpi.revenue; trendPrev = kpi.prevRevenue; trendLabel = "$"; 
    }

    const bigStr = trendMode === 'pct' ? trendVal.toFixed(2)+"%" : fmtUSD(trendVal);
    document.getElementById("trendBigNumber").textContent = bigStr;

    // Calculate Diff
    let diffStr = "—", diffClass = "text-white/50";
    if (trendPrev !== 0) {
        const diff = ((trendVal - trendPrev) / Math.abs(trendPrev)) * 100;
        const sign = diff >= 0 ? "▲" : "▼";
        diffClass = diff >= 0 ? "text-emerald-400" : "text-rose-400";
        diffStr = `${sign} ${Math.abs(diff).toFixed(1)}%`;
    }
    const elP = document.getElementById("trendPercent");
    if(elP) { elP.textContent = diffStr; elP.className = `text-sm font-bold mb-0.5 ${diffClass}`; }


    // --- CHART ---
    renderChart();


    // --- TABLE ---
    const tbody = document.getElementById("lossTableBody");
    tbody.innerHTML = "";
    weeklyData.slice(0,50).forEach(w => {
       const col = w.pctMargin<25?"text-rose-400":w.pctMargin<35?"text-amber-400":"text-emerald-400";
       tbody.innerHTML += `
         <tr class="hover:bg-white/5 text-xs text-white/70 border-b border-white/5">
           <td class="py-2 px-4 text-white">${niceDate(w.weekEnd)}</td>
           <td class="py-2 px-4 font-bold ${col}">${w.pctMargin.toFixed(1)}%</td>
           <td class="py-2 px-4">${fmtUSD(w.revenue)}</td>
           <td class="py-2 px-4">${fmtUSD(w.totalExp)}</td>
           <td class="py-2 px-4">${fmtUSD(w.margin)}</td>
         </tr>
       `;
    });

    // --- DRIVERS LIST (From KPI period) ---
    const topList = document.getElementById("topDriversList");
    const botList = document.getElementById("bottomDriversList");
    topList.innerHTML=""; botList.innerHTML="";
    
    const drvStats = {};
    kpi.rows.forEach(r => {
      if(!drvStats[r.driver]) drvStats[r.driver] = 0;
      drvStats[r.driver] += r.margin;
    });
    
    const sorted = Object.entries(drvStats).sort((a,b)=>b[1]-a[1]);
    sorted.slice(0,10).forEach(([name, val]) => {
      topList.innerHTML += `<div class="flex justify-between text-[10px] p-1 border-b border-white/5"><span class="text-white/80 w-32 truncate">${name}</span><span class="text-emerald-400 font-bold">${fmtUSD(val)}</span></div>`;
    });
    sorted.slice(-10).reverse().forEach(([name, val]) => {
      botList.innerHTML += `<div class="flex justify-between text-[10px] p-1 border-b border-white/5"><span class="text-white/80 w-32 truncate">${name}</span><span class="${val<0?'text-rose-400':'text-white/50'} font-bold">${fmtUSD(val)}</span></div>`;
    });
  }

  function renderChart() {
    const ctx = document.getElementById("trendChart").getContext("2d");
    if(chartInst) chartInst.destroy();
    
    // If KPI mode is Yearly, show more data points (52 weeks), else standard 16
    const limit = (kpiMode==='this_y' || kpiMode==='last_y') ? 52 : 16;
    const data = weeklyData.slice(0, limit).reverse(); 
    
    let vals = [], label = "", color = "", bgStr = "";
    if (trendMode === 'pct') { 
        vals = data.map(d => d.pctMargin); label = "Margin %"; color = "#818cf8"; bgStr = "129, 140, 248";
    } else if (trendMode === 'net') { 
        vals = data.map(d => d.margin); label = "Net Margin $"; color = "#10b981"; bgStr = "16, 185, 129";
    } else if (trendMode === 'rev') { 
        vals = data.map(d => d.revenue); label = "Revenue $"; color = "#3b82f6"; bgStr = "59, 130, 246";
    }

    const grad = ctx.createLinearGradient(0,0,0,300);
    grad.addColorStop(0, `rgba(${bgStr}, 0.2)`);
    grad.addColorStop(1, `rgba(${bgStr}, 0.0)`); 

    chartInst = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(d => niceDate(d.weekEnd)),
        datasets: [{
          label: label,
          data: vals,
          borderColor: color,
          backgroundColor: grad,
          fill: true, tension: 0.3, pointRadius: 3
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: {display:false} },
        scales: { 
            x: {display:false}, 
            y: {
                grid:{color:'rgba(255,255,255,0.05)'},
                ticks: {
                    color:'#666',
                    callback: (v) => trendMode==='pct' ? v+'%' : (v/1000).toFixed(0)+'k'
                }
            } 
        }
      }
    });
  }

  function renderRegionTree() {
    const cont = document.getElementById("regionTreeList");
    const arc = document.getElementById("archiveList");
    cont.innerHTML = ""; arc.innerHTML = "";
    document.getElementById("regionCountLabel").textContent = regionList.length + " Regions";

    const now = new Date();
    const cutoff = new Date(now.setDate(now.getDate()-45)).getTime();
    
    const regionGroups = {};
    const archived = [];

    Object.keys(driverData).forEach(d => {
      const rows = driverData[d].rows;
      const lastWork = Math.max(...rows.map(r => r.date.getTime()));
      
      const regCounts = {};
      rows.forEach(r => regCounts[r.regionId] = (regCounts[r.regionId]||0)+1);
      const mainReg = Object.keys(regCounts).sort((a,b) => regCounts[b]-regCounts[a])[0];

      if(lastWork < cutoff) archived.push(d);
      else {
        if(!regionGroups[mainReg]) regionGroups[mainReg] = [];
        regionGroups[mainReg].push(d);
      }
    });

    regionList.forEach(reg => {
      const isAct = activeRegionId === reg.id;
      const drvs = regionGroups[reg.id] || [];
      const drvList = drvs.map(d => {
        const dRows = driverData[d].rows;
        const totRev = dRows.reduce((a,b)=>a+b.revenue,0);
        const totMar = dRows.reduce((a,b)=>a+b.margin,0);
        const pct = totRev? (totMar/totRev)*100 : 0;
        let risk = pct < 10 ? "HIGH" : pct < 25 ? "WATCH" : "LOW";
        return { name: d, risk, pct };
      }).sort((a,b) => a.name.localeCompare(b.name));

      const item = document.createElement('div');
      item.className = `rounded-lg transition overflow-hidden mb-1 ${isAct?'bg-white/5 border border-white/10':'border border-transparent'}`;
      
      let html = `
        <div class="flex items-center justify-between p-2 cursor-pointer hover:bg-white/5" onclick="toggleRegion('${reg.id}')">
          <div class="flex items-center gap-2">
            <svg id="ic-${reg.id}" class="w-3 h-3 text-white/40 transition ${isAct?'rotate-90':''}" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
            <span class="text-xs font-medium ${isAct?'text-white':'text-white/70'}">${reg.name}</span>
          </div>
          <span class="text-[9px] text-white/20">${drvList.length}</span>
        </div>
        <div id="sub-${reg.id}" class="${isAct?'block':'hidden'} pl-4 pr-2 pb-2 space-y-0.5">
          <button class="w-full text-left text-[10px] py-1 px-2 rounded text-white/50 hover:text-white hover:bg-white/5" onclick="selectRegion('${reg.id}')">Overview</button>
      `;
      
      drvList.forEach(d => {
        const isSel = activeDriver === d.name;
        const dot = d.risk==="HIGH"?"bg-rose-500":d.risk==="WATCH"?"bg-amber-400":"bg-emerald-500/30";
        html += `<button class="w-full flex items-center gap-2 text-left text-[10px] py-1 px-2 rounded ${isSel?'bg-emerald-500/10 text-emerald-400':'text-white/70 hover:text-white hover:bg-white/5'}" onclick="selectDriver('${reg.id}','${d.name}')"><div class="w-1.5 h-1.5 rounded-full ${dot}"></div> ${d.name}</button>`;
      });
      html += `</div>`;
      item.innerHTML = html;
      cont.appendChild(item);
    });

    archived.sort().forEach(d => arc.innerHTML += `<button class="w-full text-left text-[10px] py-1 px-2 text-white/30 hover:text-white" onclick="selectDriver('ALL','${d}')">${d}</button>`);
  }


  // ============================
  // INTERACTION HANDLERS
  // ============================

  window.toggleDataSource = function() {
    activeDataSourceKey = activeDataSourceKey==="DLX"?"DMT":"DLX";
    localStorage.setItem("dash_data_source", activeDataSourceKey);
    
    // Reset selection but keep cache
    activeRegionId = "ALL";
    activeDriver = "";
    
    if (dataCache[activeDataSourceKey].loaded) {
        restoreFromCache();
    } else {
        refreshDataSource(activeDataSourceKey, true);
    }
  };

  window.setTrendMode = function(mode) {
    trendMode = mode;
    ['btnTrendPct', 'btnTrendNet', 'btnTrendRev'].forEach(id => {
        document.getElementById(id).classList.remove('active');
    });
    if(mode==='pct') document.getElementById('btnTrendPct').classList.add('active');
    if(mode==='net') document.getElementById('btnTrendNet').classList.add('active');
    if(mode==='rev') document.getElementById('btnTrendRev').classList.add('active');
    
    // Re-render overview to update Big Number and Chart
    renderOverview();
  };

  window.cycleKpiMode = function() {
    if(kpiMode === 'week') kpiMode = 'this_q';
    else if(kpiMode === 'this_q') kpiMode = 'last_q';
    else if(kpiMode === 'last_q') kpiMode = 'this_y';
    else if(kpiMode === 'this_y') kpiMode = 'last_y';
    else kpiMode = 'week';
    
    const labels = { week: "Weekly View", this_q: "This Quarter", last_q: "Last Quarter", this_y: "This Year", last_y: "Last Year" };
    document.getElementById("kpiCycleLabel").textContent = labels[kpiMode];
    renderOverview();
  };

  window.toggleRegion = function(id) {
    document.getElementById('sub-'+id).classList.toggle('hidden');
    document.getElementById('ic-'+id).classList.toggle('rotate-90');
  }

  window.selectRegion = function(id) {
    activeRegionId = id; activeDriver = "";
    processData();
  };

  window.selectDriver = function(rid, name) {
    activeRegionId = rid; activeDriver = name;
    processData();
  };
  
  // Note: setView is no longer really used as we locked to Overview, but kept for safety
  window.setView = function(v) {}; 

  function updateLabels() {
    document.getElementById("brandBadge").textContent = activeDataSourceKey;
    document.getElementById("dataToggleLabel").textContent = activeDataSourceKey;
    let txt = activeRegionId === "ALL" ? "All Areas" : regionList.find(r=>r.id===activeRegionId)?.name;
    if(activeDriver) txt += " / " + activeDriver;
    else txt += " / Overview";
    document.getElementById("activeContextLabel").textContent = txt;
  }

  document.getElementById("refreshBtn").onclick = () => syncAll();
  
  // Start
  syncAll();

</script>






</body>
</html>

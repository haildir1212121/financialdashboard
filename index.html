<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NEMT Dashboard — Regions (Live)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    html, body { height: 100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    .grain:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      mix-blend-mode: overlay;
      opacity: .35;
    }

    .glass{
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 10px 35px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
    }

    .glass-soft{
      background: rgba(255,255,255,0.045);
      border: 1px solid rgba(255,255,255,0.09);
      box-shadow: 0 12px 40px rgba(0,0,0,0.35);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    .thin-scroll::-webkit-scrollbar{ width: 8px; height: 8px; }
    .thin-scroll::-webkit-scrollbar-track{ background: rgba(255,255,255,0.04); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.14); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,0.20); }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { ink: { 950:"#05070d", 900:"#070a12", 800:"#0b1020", 700:"#101a33" } }
        }
      }
    }
  </script>
</head>

<body class="grain bg-ink-950 text-white">
  <!-- Background glows -->
  <div class="fixed inset-0 -z-10 overflow-hidden">
    <div class="absolute -top-40 -left-40 h-[540px] w-[540px] rounded-full bg-indigo-600/20 blur-3xl"></div>
    <div class="absolute top-1/3 -right-40 h-[520px] w-[520px] rounded-full bg-cyan-500/16 blur-3xl"></div>
    <div class="absolute -bottom-48 left-1/3 h-[560px] w-[560px] rounded-full bg-fuchsia-500/14 blur-3xl"></div>
    <div class="absolute inset-0 bg-gradient-to-b from-white/[0.03] via-transparent to-black/40"></div>
  </div>

  <!-- Top bar -->
  <header class="mx-auto max-w-[1400px] px-4 pt-6">
    <div class="glass rounded-2xl px-5 py-4 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-xl bg-white/10 border border-white/10 grid place-items-center">
          <span class="text-white/80 font-semibold">DLX</span>
        </div>
        <div>
          <div id="dashTitle" class="text-lg font-semibold tracking-tight">DLX/DMT Weekly Dashboard</div>
          <div id="dashSubtitle" class="text-xs text-white/60">Regions • live workbook</div>
        </div>
      </div>

      <div class="flex flex-wrap items-center gap-2">
        <div class="glass-soft rounded-xl px-3 py-2 border border-white/10">
          <div id="lastSyncLabel" class="text-xs text-white/60">Last sync: —</div>
          <div id="weekLabel" class="text-[11px] text-white/45 mt-0.5">Week: —</div>
        </div>

        <button id="exportBtn" class="glass-soft rounded-xl px-3 py-2 text-sm hover:bg-white/10 transition border border-white/10">
          Export Snapshot
        </button>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-[1400px] px-4 pb-10 pt-5">
    <!-- Regions + KPIs -->
    <section class="grid grid-cols-1 gap-3 xl:grid-cols-12">
      <aside class="glass rounded-2xl p-3 xl:col-span-3">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold tracking-tight">Regions</div>
            <div class="text-xs text-white/55">Click to switch view.</div>
          </div>
          <div id="activeRegionPill" class="text-[11px] px-2 py-1 rounded-full bg-white/8 border border-white/10 text-white/80">ALL</div>
        </div>
        <div id="regionList" class="mt-3 grid grid-cols-1 gap-2"></div>

        <div class="mt-3 glass-soft rounded-2xl p-3 border border-white/10">
          <div class="text-xs text-white/60">Ordering</div>
          <div class="text-xs text-white/70 mt-1">Always newest → oldest. Always focused on most recent week.</div>
        </div>
      </aside>

      <div class="xl:col-span-9">
        <section class="grid grid-cols-1 gap-3 md:grid-cols-2 xl:grid-cols-4">
          <div class="glass rounded-2xl p-4">
            <div class="flex items-center justify-between">
              <div class="text-xs text-white/60">Net Margin</div>
              <span class="text-xs px-2 py-1 rounded-full bg-white/8 border border-white/10 text-white/80">Live</span>
            </div>
            <div class="mt-2">
              <div id="kpiMargin" class="text-3xl font-semibold tracking-tight">—</div>
              <div id="kpiMarginSub" class="text-xs text-white/55 mt-1">—</div>
            </div>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="flex items-center justify-between">
              <div class="text-xs text-white/60">Revenue (Week)</div>
              <span class="text-xs px-2 py-1 rounded-full bg-white/8 border border-white/10 text-white/80">Live</span>
            </div>
            <div class="mt-2">
              <div id="kpiRevenue" class="text-3xl font-semibold tracking-tight">—</div>
              <div class="text-xs text-white/55 mt-1">gross</div>
            </div>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="flex items-center justify-between">
              <div class="text-xs text-white/60">Total Expense (Week)</div>
              <span class="text-xs px-2 py-1 rounded-full bg-white/8 border border-white/10 text-white/80">Live</span>
            </div>
            <div class="mt-2">
              <div id="kpiExpense" class="text-3xl font-semibold tracking-tight">—</div>
              <div id="kpiExpenseSub" class="text-xs text-white/55 mt-1">TL Exp</div>
            </div>
          </div>

          <div class="glass rounded-2xl p-4">
            <div class="flex items-center justify-between">
              <div class="text-xs text-white/60">Cost / Driver</div>
              <span class="text-xs px-2 py-1 rounded-full bg-white/8 border border-white/10 text-white/80">Proxy</span>
            </div>
            <div class="mt-2">
              <div id="kpiCostPerDriver" class="text-3xl font-semibold tracking-tight">—</div>
              <div id="kpiDriversSub" class="text-xs text-white/55 mt-1">Driver Count: —</div>
            </div>
          </div>
        </section>
      </div>
    </section>

    <!-- Trend + Expense Burden -->
    <section class="mt-3 grid grid-cols-1 gap-3 xl:grid-cols-3">
      <div class="glass rounded-2xl p-4 xl:col-span-2">
        <div class="flex items-end justify-between gap-2">
          <div>
            <div class="text-sm font-semibold tracking-tight">Margin Trend</div>
            <div class="text-xs text-white/55">Shows oldest → newest for readability. Uses newest week as “current”.</div>
          </div>
          <button id="toggleBaseline" class="glass-soft rounded-xl px-3 py-2 text-sm hover:bg-white/10 transition border border-white/10">
            Toggle Baseline
          </button>
        </div>

        <div class="mt-3 glass-soft rounded-2xl p-3 border border-white/10">
          <canvas id="trendChart" height="110"></canvas>
        </div>

        <div class="mt-3 grid grid-cols-1 gap-2 md:grid-cols-3">
          <div class="glass-soft rounded-2xl p-3 border border-white/10">
            <div class="text-xs text-white/60">Best Week</div>
            <div id="bestWeek" class="text-sm font-semibold mt-1">—</div>
            <div id="bestWeekMeta" class="text-xs text-white/55 mt-1">—</div>
          </div>
          <div class="glass-soft rounded-2xl p-3 border border-white/10">
            <div class="text-xs text-white/60">Worst Week</div>
            <div id="worstWeek" class="text-sm font-semibold mt-1 text-rose-200">—</div>
            <div id="worstWeekMeta" class="text-xs text-white/55 mt-1">—</div>
          </div>
          <div class="glass-soft rounded-2xl p-3 border border-white/10">
            <div class="text-xs text-white/60">Primary Pressure</div>
            <div id="primaryPressure" class="text-sm font-semibold mt-1">—</div>
            <div id="primaryPressureMeta" class="text-xs text-white/55 mt-1">—</div>
          </div>
        </div>
      </div>

      <div class="glass rounded-2xl p-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm font-semibold tracking-tight">Expense Burden</div>
            <div class="text-xs text-white/55">Cost categories as % of revenue (latest week).</div>
          </div>
          <div class="text-xs text-white/60">Latest</div>
        </div>

        <div id="expenseTiles" class="mt-3 grid grid-cols-2 gap-2"></div>

        <div class="mt-3 glass-soft rounded-2xl p-3 border border-white/10">
          <div class="text-xs text-white/60">Legend</div>
          <div class="mt-2 flex items-center gap-2 text-xs text-white/70">
            <span class="inline-block h-2.5 w-2.5 rounded-full bg-emerald-400/70"></span> Good
            <span class="inline-block h-2.5 w-2.5 rounded-full bg-amber-300/70 ml-3"></span> Elevated
            <span class="inline-block h-2.5 w-2.5 rounded-full bg-rose-400/70 ml-3"></span> Critical
          </div>
        </div>
      </div>
    </section>

    <!-- Loss Radar -->
    <section class="mt-3 glass rounded-2xl p-4">
      <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div>
          <div class="text-sm font-semibold tracking-tight">Loss Radar (Weeks)</div>
          <div class="text-xs text-white/55">Worst weeks first (still only valid weeks). Remember: newest data is the focus.</div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <div class="glass-soft rounded-xl px-3 py-2 flex items-center gap-2 border border-white/10">
            <span class="text-xs text-white/60">Search</span>
            <input id="searchInput" class="bg-transparent outline-none text-sm placeholder:text-white/35 w-48" placeholder="mm/dd/yyyy" />
          </div>
          <button id="resetBtn" class="glass-soft rounded-xl px-3 py-2 text-sm hover:bg-white/10 transition border border-white/10">
            Reset
          </button>
        </div>
      </div>

      <div class="mt-3 overflow-auto thin-scroll">
        <table class="min-w-full text-sm">
          <thead class="text-white/60">
            <tr class="border-b border-white/10">
              <th class="py-2 text-left font-medium">Week</th>
              <th class="py-2 text-left font-medium">% Margin</th>
              <th class="py-2 text-left font-medium">Revenue</th>
              <th class="py-2 text-left font-medium">TL Exp</th>
              <th class="py-2 text-left font-medium">Margin</th>
              <th class="py-2 text-left font-medium">Signal</th>
            </tr>
          </thead>
          <tbody id="lossTableBody" class="divide-y divide-white/10"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    // ============================
    // LIVE CONFIG
    // ============================
    const WORKER_URL = "https://withered-king-c48e.haildir12121.workers.dev/";
    const POLL_MS = 120000;

    // Region sheet names (as seen in your workbook tabs)
    const REGION_SHEETS = [
      { id: "ALL", name: "All Areas (Sum)", sheet: null }, // computed
      { id: "CST", name: "Coast", sheet: "CST.Wkly" },
      { id: "RBG", name: "Roseburg", sheet: "RBG.Wkly" },
      { id: "EUG", name: "Eugene", sheet: "EUG.Wkly" },
      { id: "OKRDG", name: "Oakridge", sheet: "OKRDG.Wkly" },
      { id: "ALBNY", name: "Albany", sheet: "ALBNY.Wkly" },
      { id: "MDVCR", name: "Mid-Valley/Corvallis", sheet: "MDVCR.Wkly" },
      { id: "DMT", name: "DMT", sheet: "DMT.Wkly" },
    ];

    // Columns in weekly summary table (P..AB block)
    // Matches your ConsolidatedWkly and region tables.
    const COLMAP = {
      weekStart: "P",
      weekEnd: "Q",
      driverCount: "R",
      hoursWorked: "S",
      payroll: "T",
      fuel: "U",
      insurance: "V",
      maintenance: "W",
      billbacks: "X",
      totalExp: "Y",
      revenue: "Z",
      margin: "AA",
      pctMargin: "AB",
    };

    // Optional title/subtitle from consolidated sheet if present
    const CONSOLIDATED_SHEET = "ConsolidatedWkly";
    const TITLE_CELL = "P1";
    const SUBTITLE_CELL = "P2";

    // ============================
    // STATE
    // ============================
    let regionSeries = {};          // { CST: [weeks...], ... , ALL: [weeks...] }
    let activeRegionId = "ALL";
    let weekly = [];
    let latestWeek = null;
    let trendChart = null;
    let showBaseline = true;

    // ============================
    // HELPERS
    // ============================
    function fmtUSD(n){ return Number(n||0).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }
    function fmtShort(n){
      const x = Number(n||0);
      const a = Math.abs(x);
      if (a >= 1e6) return (x/1e6).toFixed(1)+"m";
      if (a >= 1e3) return (x/1e3).toFixed(1)+"k";
      return x.toFixed(0);
    }
    function safeNum(v){
      if (typeof v === "number") return isFinite(v) ? v : 0;
      if (v == null) return 0;
      const s = String(v).replace(/[^0-9.\-]/g,"");
      const n = parseFloat(s);
      return isFinite(n) ? n : 0;
    }
    function asDate(v){
      if (v instanceof Date && !isNaN(v)) return v;
      if (typeof v === "number" && isFinite(v)) {
        const utcDays = Math.floor(v - 25569);
        return new Date(utcDays * 86400 * 1000);
      }
      const d = new Date(v);
      return isNaN(d) ? null : d;
    }
    function niceDate(v){
      const d = asDate(v);
      if (!d) return String(v||"");
      return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
    }

    function colToIndex(col){
      let n = 0;
      const s = String(col).toUpperCase().trim();
      for (let i=0;i<s.length;i++){
        n = n * 26 + (s.charCodeAt(i) - 64);
      }
      return n - 1;
    }

    function weekTimestamp(w){
      const d = asDate(w.weekEnd) || asDate(w.weekStart);
      return d ? d.getTime() : -Infinity;
    }

    function sortWeeksDesc(arr){
      return arr.slice().sort((a,b)=> weekTimestamp(b) - weekTimestamp(a));
    }

    function weekKey(weekStart, weekEnd){
      return `${niceDate(weekStart)}|${niceDate(weekEnd)}`;
    }

    // ============================
    // WORKER FETCH + XLSX PARSE
    // ============================
    async function fetchWorkbook(){
      const res = await fetch(WORKER_URL, { cache: "no-store" });
      const data = await res.json();
      if (!res.ok || data?.error) throw new Error(data?.detail || data?.error || `Fetch failed (${res.status})`);
      if (data.kind !== "binary" || data.encoding !== "base64" || !data.base64) {
        throw new Error("Worker response isn't XLSX base64 (expected kind=binary).");
      }
      const bytes = base64ToUint8Array(data.base64);
      const wb = XLSX.read(bytes, { type: "array" });
      return { wb, meta: data };
    }

    function base64ToUint8Array(b64){
      const bin = atob(b64);
      const len = bin.length;
      const bytes = new Uint8Array(len);
      for (let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
      return bytes;
    }

    function readCell(ws, addr){
      return ws?.[addr]?.v ?? "";
    }

    // ============================
    // REGION WEEKLY TABLE PARSER
    // ============================
    function parseRegionSheet(ws){
      // Weekly summary table lives in P..AB and has Week Start/End columns P/Q.
      // We detect the header row by scanning top section for "Revenue/Margin" headers
      // or week words, then parse rows below until P/Q go blank.

      const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

      const P = colToIndex("P");
      const Q = colToIndex("Q");

      const idx = {};
      for (const [k, col] of Object.entries(COLMAP)){
        idx[k] = colToIndex(col);
      }

      const hasWord = (v, word) => String(v||"").toLowerCase().includes(word);

      let headerRow = -1;
      for (let r = 0; r < Math.min(80, aoa.length); r++){
        const row = aoa[r] || [];
        const p = row[P], q = row[Q];
        const z = row[idx.revenue];
        const aa = row[idx.margin];
        const ab = row[idx.pctMargin];

        const looksLikeHeader =
          (hasWord(p, "week") && hasWord(q, "week")) ||
          (hasWord(z, "revenue") && hasWord(aa, "margin")) ||
          (hasWord(ab, "margin") && (String(ab).includes("%") || hasWord(ab, "%")));

        if (looksLikeHeader) { headerRow = r; break; }
      }

      if (headerRow === -1) headerRow = 2; // safe fallback

      const dataStart = headerRow + 1;

      const out = [];
      for (let r = dataStart; r < aoa.length; r++){
        const row = aoa[r] || [];

        const wsVal = row[P];
        const weVal = row[Q];

        // Stop at end of weekly table (prevents reading driver list area)
        if (String(wsVal).trim()==="" && String(weVal).trim()==="") break;

        const revenue = safeNum(row[idx.revenue]);
        const totalExp = safeNum(row[idx.totalExp]);
        const margin = safeNum(row[idx.margin]);

        const hasMoney = Math.abs(revenue) > 0.0001 || Math.abs(totalExp) > 0.0001 || Math.abs(margin) > 0.0001;
        if (!hasMoney) continue;

        let pmRaw = row[idx.pctMargin];
        let pm = 0;
        if (typeof pmRaw === "number") pm = pmRaw <= 1.5 ? pmRaw * 100 : pmRaw;
        else {
          const n = safeNum(pmRaw);
          pm = n <= 1.5 ? n * 100 : n;
        }

        out.push({
          weekStart: wsVal,
          weekEnd: weVal,
          revenue,
          totalExp,
          margin,
          pctMargin: pm,

          driverCount: Math.round(safeNum(row[idx.driverCount])),
          hoursWorked: safeNum(row[idx.hoursWorked]),
          payroll: safeNum(row[idx.payroll]),
          fuel: safeNum(row[idx.fuel]),
          insurance: safeNum(row[idx.insurance]),
          maintenance: safeNum(row[idx.maintenance]),
          billbacks: safeNum(row[idx.billbacks]),
        });
      }

      // ALWAYS newest -> oldest
      return sortWeeksDesc(out);
    }

    function sumRegionsByWeek(seriesById){
      const map = new Map();

      for (const [id, series] of Object.entries(seriesById)){
        if (id === "ALL") continue;
        for (const w of series){
          const key = weekKey(w.weekStart, w.weekEnd);
          const cur = map.get(key) || {
            weekStart: w.weekStart,
            weekEnd: w.weekEnd,
            revenue: 0, totalExp: 0, margin: 0,
            pctMargin: 0,
            maintenance: 0, payroll: 0, fuel: 0, insurance: 0, billbacks: 0,
            driverCount: 0, hoursWorked: 0
          };

          cur.revenue += w.revenue || 0;
          cur.totalExp += w.totalExp || 0;
          cur.margin += w.margin || 0;

          cur.maintenance += w.maintenance || 0;
          cur.payroll += w.payroll || 0;
          cur.fuel += w.fuel || 0;
          cur.insurance += w.insurance || 0;
          cur.billbacks += w.billbacks || 0;

          cur.driverCount += w.driverCount || 0;
          cur.hoursWorked += w.hoursWorked || 0;

          map.set(key, cur);
        }
      }

      const all = Array.from(map.values());
      for (const w of all){
        w.pctMargin = ((w.revenue - w.totalExp) / Math.max(1, w.revenue)) * 100;
        if (!isFinite(w.pctMargin)) w.pctMargin = 0;
      }
      return sortWeeksDesc(all);
    }

    // ============================
    // UI: REGIONS SIDEBAR
    // ============================
    function renderRegionSidebar(){
      const list = document.getElementById("regionList");
      list.innerHTML = "";

      REGION_SHEETS.forEach(r=>{
        const btn = document.createElement("button");
        const isActive = r.id === activeRegionId;
        btn.className = `glass-soft rounded-xl px-3 py-2 text-left border border-white/10 hover:bg-white/[0.07] transition
          ${isActive ? "bg-white/[0.09]" : ""}`;

        const series = regionSeries[r.id] || [];
        const w = series[0];

        const pm = w ? w.pctMargin : 0;
        const cls = !w ? "text-white/60" : pm < 0 ? "text-rose-200" : pm < 5 ? "text-amber-100" shown: "text-emerald-200";
      });
    }
  </script>
</body>
</html>

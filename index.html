<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>NEMT Dashboard — DLX</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    /* GLOBAL */
    html, body { height:100%; }
    body { 
      font-family: 'Inter', system-ui, sans-serif; 
      background: #050505; 
      background-image: radial-gradient(circle at 50% 0%, #16161a 0%, #050505 70%);
      color: #e2e8f0; 
      overflow: hidden; 
    }

    /* CARDS */
    .panel { background: rgba(10, 10, 10, 0.75); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.08); }
    .card  { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 4px 20px rgba(0,0,0,0.3); transition: all 0.2s ease; cursor: pointer; }
    .card:hover { border-color: rgba(255,255,255,0.12); background: rgba(255,255,255,0.05); transform: translateY(-1px); }
    
    /* SCROLLBARS */
    .thin-scroll::-webkit-scrollbar{ width:5px; height:5px; }
    .thin-scroll::-webkit-scrollbar-track{ background: transparent; }
    .thin-scroll::-webkit-scrollbar-thumb{ background: #333; border-radius: 99px; }
    .thin-scroll::-webkit-scrollbar-thumb:hover{ background: #555; }

    .navbtn { width:100%; text-align:left; padding:8px 10px; border-radius:8px; border:1px solid transparent; transition: all 0.2s; color: #94a3b8; font-size: 0.8rem; }
    .navbtn:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .navbtn.active { background: rgba(99, 102, 241, 0.15); border-color: rgba(99, 102, 241, 0.3); color: #818cf8; font-weight: 600; }
    
    /* REGION BUTTONS */
    .region-btn { width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-radius: 8px; font-size: 0.85rem; font-weight: 500; transition: all 0.2s; border: 1px solid transparent; color: rgba(255,255,255,0.6); }
    .region-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
    .region-btn.active { background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

    .view-hidden { opacity: 0; pointer-events: none; position: absolute; width: 100%; }
    .hiddenView { display:none !important; }
    .hidden { display: none !important; }
    
    /* COMPONENTS */
    .chart-toggle { padding: 4px 8px; font-size: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: rgba(255,255,255,0.5); background: transparent; text-transform: uppercase; font-weight: 700; transition: all 0.2s; cursor: pointer; }
    .chart-toggle:hover { color: #fff; background: rgba(255,255,255,0.05); }
    .chart-toggle.active { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; border-color: rgba(99, 102, 241, 0.4); }
    
    .cycle-btn { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #a5b4fc; background: rgba(99, 102, 241, 0.15); border: 1px solid rgba(99, 102, 241, 0.3); transition: all 0.2s; cursor: pointer; select-none: none; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1); }
    .cycle-btn:hover { background: rgba(99, 102, 241, 0.25); border-color: rgba(99, 102, 241, 0.5); color: #fff; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); }
    .cycle-btn:active { transform: translateY(1px); }

    .tab-btn { padding-bottom: 4px; border-bottom: 2px solid transparent; color: rgba(255,255,255,0.4); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s; }
    .tab-btn.active { border-color: #818cf8; color: #fff; }
    .tab-btn:hover:not(.active) { color: rgba(255,255,255,0.8); }

    /* SEARCH */
    .search-input { width: 100%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); padding: 8px 12px; border-radius: 8px; color: #fff; font-size: 0.85rem; outline: none; transition: all 0.2s; }
    .search-input:focus { border-color: #818cf8; background: rgba(255,255,255,0.08); box-shadow: 0 0 0 2px rgba(129,140,248,0.2); }
    .search-results { position: absolute; top: 100%; left: 0; right: 0; background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; margin-top: 4px; max-height: 200px; overflow-y: auto; z-index: 50; display: none; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .search-item { padding: 8px 12px; cursor: pointer; font-size: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .search-item:hover { background: rgba(129,140,248,0.1); color: #fff; }
    .search-item:last-child { border-bottom: none; }

    /* MODAL */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
    .modal-backdrop.open { opacity: 1; pointer-events: auto; }
    .modal-content { background: #111; border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; width: 90%; max-width: 600px; padding: 24px; transform: scale(0.95); transition: transform 0.2s; box-shadow: 0 20px 50px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
    .modal-backdrop.open .modal-content { transform: scale(1); }
    
    .info-icon { display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); color: rgba(255,255,255,0.5); font-size: 9px; margin-left: 6px; cursor: help; }
    .info-icon:hover { color: #fff; border-color: #fff; background: rgba(255,255,255,0.1); }
  </style>
</head>

<body>
  <div id="appModal" class="modal-backdrop">
    <div class="modal-content">
      <div class="flex justify-between items-start mb-4">
        <h3 id="modalTitle" class="text-lg font-bold text-white">Logic Explanation</h3>
        <button onclick="closeModal()" class="text-white/50 hover:text-white"><svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button>
      </div>
      <div id="modalBody" class="text-sm text-white/80 space-y-4"></div>
    </div>
  </div>

  <div class="mx-auto max-w-[1800px] h-full p-0 lg:p-4">
    <div class="panel lg:rounded-2xl overflow-hidden h-full flex flex-col lg:flex-row shadow-2xl relative">

      <div id="mobileOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 z-40 hidden lg:hidden backdrop-blur-sm transition-opacity"></div>

      <aside id="sidebarPanel" class="fixed inset-y-0 left-0 z-50 w-[280px] lg:w-[260px] bg-[#080808] border-r border-white/10 flex flex-col h-full transform -translate-x-full lg:translate-x-0 lg:static transition-transform duration-300 shadow-2xl lg:shadow-none">
        <div class="p-4 border-b border-white/5 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="h-9 w-9 rounded-lg bg-gradient-to-br from-indigo-600/30 to-purple-600/30 border border-white/10 grid place-items-center shadow-lg shadow-indigo-900/20">
              <span id="brandBadge" class="font-extrabold tracking-wide text-indigo-400 text-xs">DLX</span>
            </div>
            <div>
              <div class="text-sm font-bold tracking-tight text-white">Dashboard</div>
              <div class="text-[10px] text-white/40 font-medium">Management Console</div>
            </div>
          </div>
          <button onclick="toggleSidebar()" class="lg:hidden text-white/50 hover:text-white">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>

        <div class="flex-1 overflow-y-auto thin-scroll p-3 space-y-6">
          
          <div class="relative">
              <input type="text" id="globalSearch" placeholder="Search driver or region..." class="search-input" oninput="handleSearch(this.value)">
              <div id="searchResults" class="search-results thin-scroll"></div>
          </div>

          <div>
            <div class="text-[9px] uppercase tracking-widest text-white/30 font-bold mb-2 pl-1">Display Mode</div>
            <div class="space-y-1">
              <button class="navbtn active group flex items-center gap-2" data-view="overview" onclick="setView('overview'); toggleSidebar(false)">
                <svg class="w-3.5 h-3.5 opacity-60 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                Overview
              </button>
              <button class="navbtn group flex items-center gap-2" data-view="drivers" onclick="setView('drivers'); toggleSidebar(false)">
                 <svg class="w-3.5 h-3.5 opacity-60 group-hover:opacity-100" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                 Drivers
              </button>
            </div>
          </div>

          <div>
            <div class="flex items-center justify-between mb-2 pl-1">
              <div class="text-[9px] uppercase tracking-widest text-white/30 font-bold">Filter Scope</div>
              <div class="text-[9px] text-white/20" id="regionCountLabel">...</div>
            </div>
            <div id="regionListContainer" class="space-y-1"></div>
          </div>
        </div>

        <div class="p-3 border-t border-white/5 bg-black/30">
          <div class="text-[9px] text-white/30 mb-2 truncate" id="lastSyncLabel">Waiting for sync...</div>
          <div class="flex gap-2">
            <button id="refreshBtn" onclick="forceSync()" class="flex-1 rounded bg-white/5 border border-white/10 py-1.5 text-[10px] font-semibold text-white/70 hover:bg-white/10 hover:text-white transition">SYNC ALL</button>
            <button id="exportBtn" onclick="exportData()" class="flex-1 rounded bg-white/5 border border-white/10 py-1.5 text-[10px] font-semibold text-white/70 hover:bg-white/10 hover:text-white transition">EXPORT</button>
          </div>
        </div>
      </aside>

      <section class="flex-1 flex flex-col h-full relative overflow-hidden bg-black/20 w-full">
        <div class="p-4 border-b border-white/10 flex-shrink-0 z-10 bg-[#0a0a0a]/80 backdrop-blur-md">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            
            <div class="flex items-center gap-3 w-full md:w-auto">
              <button onclick="toggleSidebar()" class="lg:hidden p-2 -ml-2 text-white/70 hover:text-white bg-white/5 rounded-lg border border-white/10">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
              </button>
              
              <div>
                <div id="dashTitle" class="text-lg font-bold tracking-tight text-white leading-tight">Performance</div>
                <div class="flex flex-col">
                    <div id="activeContextLabel" class="text-xs font-medium text-indigo-400 mt-0.5 flex items-center gap-2">Global • Overview</div>
                    <div id="viewDateLabel" class="text-[10px] text-white/50 font-mono mt-0.5"></div>
                </div>
              </div>
            </div>

            <div class="flex items-center gap-3 overflow-x-auto pb-1 md:pb-0">
                
                <button onclick="analyzeVariance()" class="hidden sm:flex items-center gap-2 px-3 py-1.5 rounded-lg border border-indigo-500/30 bg-indigo-500/10 text-indigo-300 text-[11px] font-bold hover:bg-indigo-500/20 transition whitespace-nowrap">
                    <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                    Analyze Variance
                </button>

                <div class="flex items-center gap-2 flex-shrink-0">
                <div class="text-[10px] uppercase tracking-widest text-white/30 font-bold hidden sm:block">Data</div>
                <button id="dataToggleBtn" onclick="toggleDataSource()"
                  class="bg-white/5 border border-white/10 text-white/80 text-[11px] font-semibold rounded-lg px-3 py-1 hover:bg-white/10 transition focus:outline-none focus:ring-2 focus:ring-indigo-500/40">
                  <span id="dataToggleLabel">DLX</span>
                </button>
              </div>

              <button id="kpiCycleBtn" onclick="cycleKpiMode()" class="cycle-btn shadow-lg shadow-indigo-500/10 flex-shrink-0">
                <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                <span id="kpiCycleLabel">Weekly View</span>
              </button>
            </div>
          </div>
        </div>

        <div class="flex-1 overflow-y-auto thin-scroll p-3 lg:p-4 scroll-smooth">

          <div id="view-overview" class="view-container pb-20 space-y-3">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
              <div class="card rounded-2xl p-4 relative overflow-hidden group" onclick="scrollToTable('revenue')">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/10 rounded-full blur-2xl group-hover:bg-blue-500/20 transition"></div>
                <div class="flex items-center gap-1 mb-1">
                    <div class="text-[10px] uppercase tracking-wider text-white/50 font-bold">Total Revenue</div>
                    <div class="info-icon" title="Aggregated from weekly sheets. Click to view history table.">i</div>
                </div>
                <div id="kpiRevenue" class="text-2xl font-bold text-white tracking-tight">—</div>
                <div id="kpiRevenueLabel" class="text-[10px] text-white/30 mt-0.5">Current Week</div>
              </div>
              
              <div class="card rounded-2xl p-4 relative overflow-hidden group" onclick="setTrendMode('net')">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/10 rounded-full blur-2xl group-hover:bg-emerald-500/20 transition"></div>
                <div class="flex items-center gap-1 mb-1">
                    <div class="text-[10px] uppercase tracking-wider text-white/50 font-bold">Net Margin ($)</div>
                    <div class="info-icon" title="Revenue - Total Expenses. Click to see Trend.">i</div>
                </div>
                <div id="kpiMargin" class="text-2xl font-bold tracking-tight text-white">—</div>
                <div id="kpiMarginLabel" class="text-[10px] text-white/30 mt-0.5 truncate">Profit</div>
              </div>
              
              <div class="card rounded-2xl p-4 relative overflow-hidden group" onclick="setTrendMode('pct')">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-indigo-500/10 rounded-full blur-2xl group-hover:bg-indigo-500/20 transition"></div>
                <div class="flex items-center gap-1 mb-1">
                    <div class="text-[10px] uppercase tracking-wider text-white/50 font-bold">Margin (%)</div>
                    <div class="info-icon" title="(Net Margin / Revenue) * 100. Click to see Trend.">i</div>
                </div>
                <div id="kpiPctMargin" class="text-2xl font-bold text-white tracking-tight">—</div>
                <div id="kpiPctMarginLabel" class="text-[10px] text-white/30 mt-0.5 truncate">Efficiency</div>
              </div>
              
              <div class="card rounded-2xl p-4 relative overflow-hidden group" onclick="showMathModal()">
                <div class="absolute -right-6 -top-6 w-24 h-24 bg-purple-500/10 rounded-full blur-2xl group-hover:bg-purple-500/20 transition"></div>
                <div class="flex items-center gap-1 mb-1">
                    <div id="kpiProjectedTitle" class="text-[10px] uppercase tracking-wider text-white/50 font-bold">Projected Annual</div>
                    <div class="info-icon" title="Click to see Run Rate math.">i</div>
                </div>
                <div class="mt-1">
                   <div id="kpiProjected" class="text-2xl font-bold text-indigo-300 tracking-tight bg-indigo-500/15 border border-indigo-500/20 inline-block px-3 py-0.5 rounded-lg shadow-[0_0_15px_rgba(99,102,241,0.2)]">—</div>
                </div>
                <div id="kpiProjectedLabel" class="text-[10px] text-white/30 mt-1 truncate">Run Rate</div>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
              <div class="card rounded-2xl p-4 lg:p-5 lg:col-span-2 flex flex-col">
                <div class="flex flex-col sm:flex-row sm:items-end justify-between mb-4 gap-3">
                   <div class="flex items-end gap-3">
                      <div>
                         <h3 class="text-xs font-bold text-white/50 uppercase tracking-widest mb-1">Trend Analysis</h3>
                         <h4 id="trendBigNumber" class="text-3xl font-bold text-white leading-none">$0</h4>
                      </div>
                      <div id="trendPercent" class="text-sm font-bold mb-0.5 text-white/50">—%</div>
                   </div>
                   <div class="flex gap-1 bg-white/5 p-0.5 rounded-lg self-start sm:self-auto">
                      <button class="chart-toggle active" id="btnTrendPct" onclick="setTrendMode('pct')">Margin %</button>
                      <button class="chart-toggle" id="btnTrendNet" onclick="setTrendMode('net')">Net $</button>
                      <button class="chart-toggle" id="btnTrendRev" onclick="setTrendMode('rev')">Rev $</button>
                   </div>
                </div>
                <div class="relative flex-1 min-h-[250px]">
                  <canvas id="trendChart"></canvas>
                </div>
              </div>

              <div class="card rounded-2xl p-0 flex flex-col overflow-hidden h-[380px]">
                <div class="p-3 border-b border-white/5 bg-white/5 flex flex-col gap-2">
                  <div class="flex justify-between items-center">
                    <div class="text-xs font-bold text-white">Breakdown</div>
                    <div id="perfPeriodLabel" class="text-[10px] text-white/40">Viewed Period</div>
                  </div>
                  <div class="flex gap-4 mt-1">
                    <button id="tabDrivers" class="tab-btn active" onclick="switchBreakdownTab('drivers')">Top Drivers</button>
                    <button id="tabAreas" class="tab-btn" onclick="switchBreakdownTab('areas')">By Area</button>
                  </div>
                </div>
                
                <div class="flex-1 relative overflow-hidden">
                    <div id="tabContentDrivers" class="absolute inset-0 overflow-y-auto thin-scroll p-3">
                        <div class="text-[9px] uppercase tracking-widest text-emerald-400 font-bold mb-2">Top 10 Performers</div>
                        <div id="topDriversList" class="space-y-1 mb-4"></div>
                        <div class="text-[9px] uppercase tracking-widest text-rose-400 font-bold mb-2">Bottom 10 Performers</div>
                        <div id="bottomDriversList" class="space-y-1"></div>
                    </div>
                    <div id="tabContentAreas" class="absolute inset-0 p-3 hidden">
                        <canvas id="areaBreakdownChart"></canvas>
                    </div>
                </div>
              </div>
            </div>

            <div id="historyTableCard" class="card rounded-2xl p-0 overflow-hidden flex flex-col max-h-[500px]">
              <div class="p-3 border-b border-white/5 flex justify-between items-center bg-white/5">
                <div class="font-bold text-xs">History</div>
                <div class="text-[10px] text-white/40">Full Record</div>
              </div>
              <div class="thin-scroll overflow-x-auto overflow-y-auto flex-1">
                <table class="w-full text-left text-xs border-collapse min-w-[600px]">
                  <thead class="sticky top-0 bg-[#121212] text-white/40 uppercase tracking-wider z-10 shadow-lg font-semibold">
                    <tr><th class="py-3 px-4">Period</th><th class="py-3 px-4">% Margin</th><th class="py-3 px-4">Revenue</th><th class="py-3 px-4">TL Exp</th><th class="py-3 px-4">Margin</th><th class="py-3 px-4">Signal</th></tr>
                  </thead>
                  <tbody id="lossTableBody" class="divide-y divide-white/5 text-white/80 font-mono"></tbody>
                </table>
              </div>
            </div>
          </div> 

          <div id="view-drivers" class="view-hidden hiddenView pb-10 space-y-4">
            <div id="driverTopPerformer" class="mb-3"></div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 h-[300px]">
                <div class="card rounded-2xl p-4 flex flex-col">
                    <div class="text-xs font-bold text-white/50 uppercase mb-2">Performance Trend</div>
                    <div class="flex-1 relative"><canvas id="driverTrendChart"></canvas></div>
                </div>
                <div class="card rounded-2xl p-4 flex flex-col">
                    <div class="text-xs font-bold text-white/50 uppercase mb-2">Efficiency Analysis (Hours vs Margin)</div>
                    <div class="flex-1 relative"><canvas id="driverScatterChart"></canvas></div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-3 h-full">
              <div class="card rounded-2xl p-0 overflow-hidden flex flex-col max-h-[75vh]">
                <div class="p-3 border-b border-white/5 bg-white/5">
                  <div class="font-bold text-xs">Driver History</div>
                  <div class="text-[10px] text-white/40">Aggregated Performance</div>
                </div>
                <div class="thin-scroll overflow-x-auto overflow-y-auto flex-1">
                  <table class="w-full text-left text-xs min-w-[500px]">
                    <thead class="sticky top-0 bg-[#121212] text-white/40 uppercase tracking-wider z-10">
                      <tr><th class="py-2 px-4">Week</th><th class="py-2 px-4">% Margin</th><th class="py-2 px-4">Revenue</th><th class="py-2 px-4">Margin</th><th class="py-2 px-4">Hours</th></tr>
                    </thead>
                    <tbody id="driverWeeklyBody" class="divide-y divide-white/5 text-white/80 font-mono"></tbody>
                  </table>
                </div>
              </div>
              <div class="card rounded-2xl p-0 overflow-hidden flex flex-col h-auto">
                <div class="p-3 border-b border-white/5 bg-white/5">
                  <div class="font-bold text-xs">Region Breakdown</div>
                  <div class="text-[10px] text-white/40">Latest Active Week</div>
                </div>
                <div class="thin-scroll overflow-x-auto overflow-y-auto flex-1">
                  <table class="w-full text-left text-xs min-w-[400px]">
                    <thead class="sticky top-0 bg-[#121212] text-white/40 uppercase tracking-wider z-10">
                      <tr><th class="py-2 px-4">Region</th><th class="py-2 px-4">Revenue</th><th class="py-2 px-4">Margin</th><th class="py-2 px-4">Hours</th></tr>
                    </thead>
                    <tbody id="driverRegionBody" class="divide-y divide-white/5 text-white/80 font-mono"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </div> 
      </section>
    </div>
  </div>

<script>
  Chart.register(ChartDataLabels); 

  const WORKER_URL_DLX = "https://withered-king-c48e.haildir12121.workers.dev/";
  const WORKER_URL_DMT = "https://spring-grass-bbc2.haildir12121.workers.dev/";

  const DATA_SOURCES = {
    DLX: { key: "DLX", label: "DLX", workerUrl: WORKER_URL_DLX, primarySheet: "ConsolidatedWkly" },
    DMT: { key: "DMT", label: "DMT", workerUrl: WORKER_URL_DMT, primarySheet: "ConsolidatedWkly" }
  };

  const SCHEMAS = {
    DLX: {
      dataHeaderRowIndex0: 2, dateCol: "D",
      areas: [
        { id: "CST",   name: "Coast",    start: "E",  end: "O" },
        { id: "RBG",   name: "Roseburg", start: "P",  end: "Z" },
        { id: "EUG",   name: "Eugene",   start: "AA", end: "AK" },
        { id: "OKRDG", name: "Oakridge", start: "AL", end: "AV" },
        { id: "ALBNY", name: "Albany",   start: "AW", end: "BG" },
        { id: "DMT",   name: "DMT",      start: "BR", end: "CB" }
      ],
      offsets: { driver:0, hours:1, payroll:2, fuel:3, insurance:4, maintenance:5, totalExp:7, revenue:8, margin:9 }
    },
    DMT: {
      dataHeaderRowIndex0: 2, dateCol: "D",
      areas: [
        { id: "CST",   name: "Coast-DMT",  start: "E",  end: "N" },
        { id: "RBG",   name: "Roseburg-DMT", start: "P",  end: "Y" },
        { id: "EUG",   name: "Eugene DMT", start: "AA", end: "AJ" },
        { id: "NV",    name: "Nevada",     start: "AL", end: "AU" },
        { id: "ALBNY", name: "Albany/Salem", start: "AW", end: "BF" },
        { id: "PDX",   name: "Portland",   start: "BG", end: "BP" },
        { id: "STR",   name: "Stretcher",  start: "BR", end: "CA" }
      ],
      offsets: { driver:0, hours:1, payroll:2, fuel:3, insurance:4, maintenance:5, totalExp:7, revenue:8, margin:9 }
    }
  };

  const COLMAPS = {
    DLX: { weekStart: "P", weekEnd: "Q", revenue: "Z", totalExp: "Y", margin: "AA", pctMargin: "AB", driverCount: "R", hoursWorked: "S" },
    DMT: { weekStart: "P", weekEnd: "Q", revenue: "Z", totalExp: "Y", margin: "AA", pctMargin: "AB", driverCount: "R", hoursWorked: "S" }
  };

  // Define Explicit Sheet Lists for Region Mapping
  const REGION_SHEET_MAP = {
      DLX: {
          "CST.WKLY": "CST",
          "RBG.WKLY": "RBG",
          "EUG.WKLY": "EUG",
          "OKRDG.WKLY": "OKRDG",
          "ALBNY.WKLY": "ALBNY",
          "MDVCR.WKLY": "MDVCR",
          "DMT.WKLY": "DMT"
      },
      DMT: {
          "CST.WKLY": "CST",
          "RBG.WKLY": "RBG",
          "EUG.WKLY": "EUG",
          "NEVADA": "NV",
          "ALBANY/SALEM": "ALBNY",
          "E.OREGON": "EOREGON",
          "STRETCHER": "STR"
      }
  };

  // GLOBAL STATE
  let activeDataSourceKey = localStorage.getItem("dash_data_source") || "DLX";
  let activeRegionId = "ALL"; 
  let activeView = "overview";
  let activeDriver = "";
  
  let currentRunRateData = {}; 
  let currentStats = {}; 
  let prevStats = {}; 
  let lastFilteredStartTime = 0;
  let lastFilteredEndTime = 0;
  let lastPrevStartTime = 0;
  let lastPrevEndTime = 0;

  const dataStore = {
    DLX: { loaded: false, REGION_SHEETS: [], regionSeries: {}, driverIndex: {} },
    DMT: { loaded: false, REGION_SHEETS: [], regionSeries: {}, driverIndex: {} }
  };
  
  let regionSeries = {}; 
  let driverIndex = {}; 
  let weekly = []; 
  let driverWeekly = [];     
  let dailyHistory = []; 

  let trendChart = null; 
  let areaBreakdownChart = null;
  let driverTrendChart = null;
  let driverScatterChart = null;
  
  let trendMode = "pct"; 
  let kpiMode = "week"; 

  function fmtUSD(n){ return Number(n||0).toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}); }
  function safeNum(v){ if(typeof v === 'number') return isFinite(v)?v:0; const s = String(v).replace(/[^0-9.\-]/g,""); const n = parseFloat(s); return isFinite(n)?n:0; }
  function colToIndex(col){ let n=0; const s=String(col).toUpperCase().trim(); for(let i=0;i<s.length;i++) n=n*26+(s.charCodeAt(i)-64); return n-1; }
  
  function asDate(v) {
    if (v instanceof Date && !isNaN(v)) return v;
    if (typeof v === "number" && isFinite(v)) {
      const utcDays = Math.floor(v - 25569);
      return new Date(utcDays * 86400 * 1000);
    }
    if (typeof v === "string") {
        const d = new Date(v);
        if (isNaN(d.getTime())) return null;
        return new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    }
    return null;
  }

  function normalizeDate(d) { 
      if(!d) return null; 
      const date = new Date(d); 
      date.setHours(0,0,0,0); 
      const day = date.getDay(); 
      // Force align to Sunday (0)
      const diff = date.getDate() - day; 
      return new Date(date.setDate(diff)); 
  }
  
  function niceDate(v){ const d = asDate(v); return d ? `${d.getUTCMonth()+1}/${d.getUTCDate()}/${d.getUTCFullYear()}` : ""; } 
  function sortWeeksDesc(arr){ return (arr||[]).slice().sort((a,b)=> { const da = asDate(a.weekEnd); const db = asDate(b.weekEnd); return (db?db.getTime():0) - (da?da.getTime():0); }); }

  function parseRegionSheet(ws){ 
    const map = COLMAPS[activeDataSourceKey] || COLMAPS.DLX;
    const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" }); 
    const idx = {}; for (const [k, col] of Object.entries(map)) idx[k] = colToIndex(col); 
    
    let headerRow = 2; 
    for (let r=0; r<Math.min(100, aoa.length); r++){ const row = aoa[r]||[]; if(String(row[idx.pctMargin]||"").includes("%")) { headerRow=r; break; } } 
    
    const out = []; 
    for (let r = headerRow + 1; r < aoa.length; r++){ 
      const row = aoa[r] || []; 
      const wsVal = row[idx.weekStart]; 
      
      const dObj = normalizeDate(asDate(wsVal));
      if (!dObj) continue; 
      
      const dStart = dObj; 
      const dEnd = new Date(dStart);
      dEnd.setDate(dStart.getDate() + 6);

      const revenue = safeNum(row[idx.revenue]); 
      const totalExp = safeNum(row[idx.totalExp]); 
      if(Math.abs(revenue)<1 && Math.abs(totalExp)<1) continue; 
      let pm = safeNum(row[idx.pctMargin]);
      if(pm <= 1.5 && pm >= -1.5) pm = pm * 100;

      out.push({ 
          weekStart: dStart, 
          weekEnd: dEnd,
          revenue, totalExp, margin: safeNum(row[idx.margin]), pctMargin: pm 
      }); 
    } 
    return sortWeeksDesc(out); 
  }

  function parseRunningSheet(ws, sourceKey){ 
    const schema = SCHEMAS[sourceKey];
    const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" }); 
    const headerRow = schema.dataHeaderRowIndex0; 
    const dateColIdx = colToIndex(schema.dateCol); 
    const areas = schema.areas.map(a => ({...a, startIdx: colToIndex(a.start)})); 
    
    let lastValidDate = null;
    const checkIdx = areas[0].startIdx;

    for (const a of areas) { a.driverColIdx = a.startIdx; for (let c = a.startIdx; c <= colToIndex(a.end); c++) { if (String(aoa[headerRow]?.[c]||"").toLowerCase().trim() === "driver") { a.driverColIdx = c; break; } } } 
    const out = {}; 
    for (let r = headerRow + 1; r < aoa.length; r++){ 
      const row = aoa[r] || []; 
      let d = asDate(row[dateColIdx]);
      const hasData = row.slice(checkIdx).some(c => c !== undefined && c !== null && c !== "");
      if (d) { lastValidDate = d; } else if (lastValidDate && hasData) { d = lastValidDate; }
      if (!d) continue; 
      
      for (const a of areas){ 
        const base = a.driverColIdx; 
        const name = String(row[base + schema.offsets.driver] || "").trim(); 
        if (!name) continue; 
        
        const revenue = safeNum(row[base + schema.offsets.revenue]); 
        if (Math.abs(revenue)<0.1) continue; 
        if (!out[name]) out[name] = { rows: [] }; 
        out[name].rows.push({ date: d, region: a.name, regionId: a.id, revenue, margin: safeNum(row[base + schema.offsets.margin]), hours: safeNum(row[base + schema.offsets.hours]) }); 
      } 
    } 
    return out; 
  }

  function sumRegionsByWeek(seriesById){ const map = new Map(); for (const [id, series] of Object.entries(seriesById)){ if (id === "ALL") continue; for (const w of series){ const key = `${niceDate(w.weekStart)}|${niceDate(w.weekEnd)}`; const cur = map.get(key) || { weekStart: w.weekStart, weekEnd: w.weekEnd, revenue:0, totalExp:0, margin:0, driverCount:0, hoursWorked:0 }; cur.revenue += w.revenue; cur.totalExp += w.totalExp; cur.margin += w.margin; cur.driverCount += w.driverCount; cur.hoursWorked += w.hoursWorked; map.set(key, cur); } } const all = Array.from(map.values()); for(const w of all) w.pctMargin = w.revenue?((w.revenue-w.totalExp)/w.revenue)*100:0; return sortWeeksDesc(all); }
  function getDriverWeekly(driverName){ const rows = driverIndex[driverName]?.rows || []; const map = new Map(); for (const r of rows){ const dt = new Date(r.date.getFullYear(), r.date.getMonth(), r.date.getDate(), 12, 0, 0); const day = dt.getDay(); const diff = (day - 6 + 7) % 7; const start = new Date(dt); start.setDate(dt.getDate() - diff); const end = new Date(start); end.setDate(start.getDate() + 6); const key = `${niceDate(start)}|${niceDate(end)}`; const cur = map.get(key) || { weekStart: start, weekEnd: end, revenue:0, totalExp:0, margin:0, hoursWorked:0 }; cur.revenue += r.revenue; cur.totalExp += r.totalExp; cur.margin += r.margin; cur.hoursWorked += r.hours; map.set(key, cur); } const out = sortWeeksDesc(Array.from(map.values())); for(const w of out) w.pctMargin = w.revenue?((w.revenue-w.totalExp)/w.revenue)*100:0; return out; }

  // NEW: Aggregate Daily History from Running Sheet
  function aggregateDailyHistory(dIndex) {
      const map = new Map();
      Object.values(dIndex).forEach(driver => {
          driver.rows.forEach(r => {
              const key = r.date.getTime();
              const cur = map.get(key) || { date: r.date, revenue:0, margin:0, totalExp:0 };
              cur.revenue += r.revenue;
              cur.margin += r.margin;
              cur.totalExp += (r.revenue - r.margin);
              map.set(key, cur);
          });
      });
      const arr = Array.from(map.values()).sort((a,b) => b.date - a.date);
      arr.forEach(d => d.pctMargin = d.revenue ? (d.margin/d.revenue)*100 : 0);
      return arr;
  }

  function aggregateRunningSheetToRegionSeries(dIndex, sourceKey) {
      const rs = {};
      const schema = SCHEMAS[sourceKey];
      schema.areas.forEach(a => rs[a.id] = []);
      const regionMaps = {}; 
      Object.values(dIndex).forEach(driver => {
          driver.rows.forEach(row => {
              if(!regionMaps[row.regionId]) regionMaps[row.regionId] = new Map();
              const ws = normalizeDate(row.date);
              const key = ws.getTime();
              const cur = regionMaps[row.regionId].get(key) || { weekStart: ws, weekEnd: new Date(ws.getTime() + 6*86400000), revenue:0, margin:0, totalExp:0 };
              cur.revenue += row.revenue; cur.margin += row.margin; cur.totalExp += (row.revenue - row.margin); 
              regionMaps[row.regionId].set(key, cur);
          });
      });
      Object.keys(regionMaps).forEach(rid => {
          const arr = Array.from(regionMaps[rid].values());
          arr.forEach(w => w.pctMargin = w.revenue ? (w.margin/w.revenue)*100 : 0);
          rs[rid] = sortWeeksDesc(arr);
      });
      return rs;
  }

  async function forceSync() {
    document.getElementById("lastSyncLabel").textContent = "Syncing all sources...";
    await Promise.all([fetchDataForSource("DLX"), fetchDataForSource("DMT")]);
    document.getElementById("lastSyncLabel").textContent = "Synced: " + new Date().toLocaleTimeString();
    switchDataSourceDisplay(activeDataSourceKey);
  }
  
  async function fetchDataForSource(key) {
    try {
        const res = await fetch(DATA_SOURCES[key].workerUrl, {cache:"no-store"});
        const buf = await res.arrayBuffer();
        const wb = XLSX.read(buf, {type:"array"});
        const runWs = wb.Sheets["Running Sheet"];
        const dIndex = runWs ? parseRunningSheet(runWs, key) : {};

        let rs = {};
        let regionSheets = [];
        let usedPrimary = false;

        const primarySheetName = "ConsolidatedWkly"; 

        if (wb.Sheets[primarySheetName]) {
             rs["ALL"] = parseRegionSheet(wb.Sheets[primarySheetName]);
             usedPrimary = true;
             
             // Look for Region Sheets based on specific mapping
             const map = REGION_SHEET_MAP[key];
             regionSheets = [];
             regionSheets.push({id:"ALL", name:"All Regions", sheet:null});
             
             Object.entries(map).forEach(([sheetName, regionId]) => {
                 // Try strict case first, then loose
                 let actualSheet = wb.SheetNames.find(n => n.toUpperCase() === sheetName.toUpperCase());
                 if(actualSheet && wb.Sheets[actualSheet]) {
                     rs[regionId] = parseRegionSheet(wb.Sheets[actualSheet]);
                     regionSheets.push({ id: regionId, name: actualSheet, sheet: actualSheet });
                 }
             });
        } 
        
        if (!usedPrimary) {
            // Fallback (Legacy)
            rs = aggregateRunningSheetToRegionSeries(dIndex, key);
            rs["ALL"] = sumRegionsByWeek(rs);
            regionSheets = SCHEMAS[key].areas.map(a => ({ id: a.id, name: a.name, sheet: null }));
            regionSheets.unshift({id:"ALL", name:"All Regions", sheet:null});
        }
        
        dataStore[key].REGION_SHEETS = regionSheets;
        dataStore[key].regionSeries = rs;
        dataStore[key].driverIndex = dIndex;
        dataStore[key].dailyHistory = aggregateDailyHistory(dIndex);
        dataStore[key].loaded = true;
    } catch(e) { console.error(e); dataStore[key].loaded = false; }
  }

  function buildRegionSheetsFromWorkbook(wb, key){
      if(key === "DMT") return [];
      const wklySheets = (wb.SheetNames||[]).filter(n => /\.Wkly$/i.test(n));
      const preferred = ["CST","EUG","RBG","OKRDG","ALBNY","DMT","NV","PDX"];
      const out = [{id:"ALL", name:"All Regions", sheet:null}];
      preferred.forEach(p => { if(wklySheets.find(n=>n.toUpperCase().includes(p))) out.push({id:p, name:REGION_LABELS[p]||p, sheet:wklySheets.find(n=>n.toUpperCase().includes(p))}); });
      return out;
  }

  // --- UI INTERACTION ---
  function showMathModal() {
      const d = currentRunRateData;
      let html = `<div class="mb-4"><div class="text-xs uppercase text-white/40 font-bold mb-1">Formula</div><div class="font-mono bg-white/5 p-2 rounded text-indigo-300">(Actual Margin / Weeks Counted) × Total Weeks</div></div><div class="grid grid-cols-2 gap-4 mb-4"><div class="bg-white/5 p-3 rounded"><div class="text-xs text-white/50">Weeks Counted</div><div class="text-xl font-bold text-white">${d.count}</div></div><div class="bg-white/5 p-3 rounded"><div class="text-xs text-white/50">Total Period Weeks</div><div class="text-xl font-bold text-white">${d.totalWeeks}</div></div><div class="bg-white/5 p-3 rounded"><div class="text-xs text-white/50">Avg Weekly Margin</div><div class="text-xl font-bold text-emerald-400">${fmtUSD(d.avg)}</div></div><div class="bg-white/5 p-3 rounded"><div class="text-xs text-white/50">Projected Total</div><div class="text-xl font-bold text-indigo-400">${fmtUSD(d.projected)}</div></div></div>`;
      openModal("Projection Math", html);
  }

  function scrollToTable(type) {
      const el = document.getElementById("historyTableCard");
      el.scrollIntoView({ behavior: "smooth" });
      el.classList.add("ring-2", "ring-indigo-500");
      setTimeout(() => el.classList.remove("ring-2", "ring-indigo-500"), 1500);
      renderTable(true); 
  }

  function analyzeVariance() {
      const diffRev = currentStats.rev - prevStats.rev;
      const diffMarg = currentStats.marg - prevStats.marg;
      const driverDeltas = [];
      Object.entries(driverIndex).forEach(([name, data]) => {
          let currM = 0, prevM = 0;
          data.rows.forEach(r => {
              const t = r.date.getTime() + 518400000;
              if(t >= lastFilteredStartTime && t <= lastFilteredEndTime) currM += r.margin;
              if(t >= lastPrevStartTime && t <= lastPrevEndTime) prevM += r.margin;
          });
          if(currM !== 0 || prevM !== 0) { driverDeltas.push({ name, delta: currM - prevM, curr: currM, prev: prevM }); }
      });
      driverDeltas.sort((a,b) => b.delta - a.delta);
      const topPositive = driverDeltas.slice(0, 5); const topNegative = driverDeltas.slice(-5).reverse();
      const renderRows = (arr, isPos) => arr.map(d => `<div class="flex justify-between items-center text-[10px] py-1 border-b border-white/5"><span class="text-white/80 w-1/2 truncate">${d.name}</span><span class="font-mono ${isPos?'text-emerald-400':'text-rose-400'}">${isPos?'+':''}${fmtUSD(d.delta)}</span></div>`).join('');
      let html = `<div class="grid grid-cols-2 gap-4 mb-4"><div class="bg-white/5 p-3 rounded text-center"><div class="text-xs text-white/50 mb-1">Total Margin Change</div><div class="text-xl font-bold ${diffMarg>=0?'text-emerald-400':'text-rose-400'}">${diffMarg>=0?'+':''}${fmtUSD(diffMarg)}</div></div><div class="bg-white/5 p-3 rounded text-center"><div class="text-xs text-white/50 mb-1">Revenue Change</div><div class="text-lg font-bold ${diffRev>=0?'text-emerald-400':'text-rose-400'}">${diffRev>=0?'+':''}${fmtUSD(diffRev)}</div></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><h4 class="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-2">Top Growth Drivers</h4><div class="bg-white/5 rounded p-2">${renderRows(topPositive, true)}</div></div><div><h4 class="text-xs font-bold text-rose-400 uppercase tracking-wider mb-2">Top Decline Drivers</h4><div class="bg-white/5 rounded p-2">${renderRows(topNegative, false)}</div></div></div><div class="mt-4 text-[10px] text-white/30 text-center">Comparing ${niceDate(new Date(lastFilteredStartTime))} vs ${niceDate(new Date(lastPrevStartTime))} periods.</div>`;
      openModal("Variance Analysis", html);
  }

  function openModal(title, content) {
      document.getElementById("modalTitle").textContent = title;
      document.getElementById("modalBody").innerHTML = content;
      document.getElementById("appModal").classList.add("open");
  }
  window.closeModal = function() {
      document.getElementById("appModal").classList.remove("open");
  }

  window.toggleSidebar = function(forceState) {
      const sb = document.getElementById("sidebarPanel");
      const overlay = document.getElementById("mobileOverlay");
      if(!sb || !overlay) return;
      const isHidden = sb.classList.contains("-translate-x-full");
      const shouldOpen = forceState !== undefined ? forceState : isHidden;
      if(shouldOpen) { sb.classList.remove("-translate-x-full"); overlay.classList.remove("hidden"); } 
      else { sb.classList.add("-translate-x-full"); overlay.classList.add("hidden"); }
  };

  window.toggleDataSource = function() { switchDataSourceDisplay(activeDataSourceKey === "DLX" ? "DMT" : "DLX"); };
  
  function switchDataSourceDisplay(key) {
      activeDataSourceKey = key; localStorage.setItem("dash_data_source", key);
      document.getElementById("dataToggleLabel").textContent = key; document.getElementById("brandBadge").textContent = key; document.title = `NEMT Dashboard — ${key}`;
      activeRegionId = "ALL"; activeDriver = "";
      if (dataStore[key].loaded) { 
          regionSeries = dataStore[key].regionSeries; 
          driverIndex = dataStore[key].driverIndex; 
          dailyHistory = dataStore[key].dailyHistory || [];
          window.REGION_SHEETS = dataStore[key].REGION_SHEETS; 
          applyData(); 
      } 
      else { fetchDataForSource(key).then(() => switchDataSourceDisplay(key)); }
  }

  window.selectRegion = function(id){ activeRegionId=id; activeDriver=""; setView("overview"); applyData(); };
  window.selectDriver = function(rid, d){ activeRegionId=rid; activeDriver=d; setView("drivers"); applyData(); };

  function applyData() {
      let raw = [];
      if(activeDriver) {
         driverWeekly = getDriverWeekly(activeDriver);
         raw = driverWeekly;
      } else {
         raw = regionSeries[activeRegionId] || [];
      }
      weekly = sortWeeksDesc(raw).filter(w => {
          const d = asDate(w.weekEnd);
          return d && d.getUTCFullYear() !== 2020;
      });
      renderRegionList();
      if(activeView === "overview") renderOverview();
      if(activeView === "drivers") renderDriversView();
      updateContextLabel();
  }

  function renderRegionList(){
    const sheets = dataStore[activeDataSourceKey].REGION_SHEETS || [];
    const container = document.getElementById("regionListContainer"); container.innerHTML = ""; 
    document.getElementById("regionCountLabel").textContent = `${Math.max(0, sheets.length - 1)} Regions`;
    const isAll = (activeRegionId === "ALL");
    const allBtn = document.createElement("button"); allBtn.className = `region-btn ${isAll ? 'active' : ''}`; allBtn.onclick = () => { selectRegion("ALL"); toggleSidebar(false); }; allBtn.innerHTML = `<span>View All</span><span class="text-[10px] opacity-50">Global</span>`; container.appendChild(allBtn);
    sheets.forEach(r => { if(r.id === "ALL") return; const isActive = (activeRegionId === r.id); const btn = document.createElement("button"); btn.className = `region-btn ${isActive ? 'active' : ''}`; btn.onclick = () => { selectRegion(r.id); toggleSidebar(false); }; btn.innerHTML = `<span>${r.name}</span><svg class="w-3 h-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>`; container.appendChild(btn); });
  }

  // --- DRIVER VIEW CHARTS ---
  function renderDriversView() {
      if(!activeDriver) return;
      document.getElementById("driverTopPerformer").innerHTML = `<div class="text-lg font-bold text-white">${activeDriver} <span class="text-sm font-normal text-white/50">Performance Profile</span></div>`;
      
      const data = driverWeekly.slice(0, 20).reverse(); // Last 20 weeks
      const labels = data.map(w => niceDate(w.weekEnd));
      const margins = data.map(w => w.margin);
      const hours = data.map(w => w.hoursWorked || 0); 
      
      const ctx1 = document.getElementById("driverTrendChart").getContext("2d");
      if(driverTrendChart) driverTrendChart.destroy();
      driverTrendChart = new Chart(ctx1, {
          type: 'line',
          data: {
              labels: labels,
              datasets: [{
                  label: 'Net Margin',
                  data: margins,
                  borderColor: '#10b981',
                  backgroundColor: 'rgba(16, 185, 129, 0.1)',
                  fill: true,
                  tension: 0.3
              }]
          },
          options: {
              responsive: true, maintainAspectRatio: false,
              plugins: { legend: { display: false }, datalabels: { display: false } },
              scales: { x: { display:false }, y: { grid:{color:'rgba(255,255,255,0.05)'} } }
          }
      });

      const scatterData = data.map(w => ({ x: w.hoursWorked||0, y: w.margin }));
      const ctx2 = document.getElementById("driverScatterChart").getContext("2d");
      if(driverScatterChart) driverScatterChart.destroy();
      driverScatterChart = new Chart(ctx2, {
          type: 'scatter',
          data: {
              datasets: [{
                  label: 'Weekly Performance',
                  data: scatterData,
                  backgroundColor: scatterData.map(p => p.y > 500 ? '#818cf8' : '#f43f5e') 
              }]
          },
          options: {
              responsive: true, maintainAspectRatio: false,
              plugins: { legend: { display: false }, datalabels: { display: false } },
              scales: { 
                  x: { title: { display: true, text: 'Hours Worked', color: '#666' }, grid:{color:'rgba(255,255,255,0.05)'} }, 
                  y: { title: { display: true, text: 'Net Margin', color: '#666' }, grid:{color:'rgba(255,255,255,0.05)'} } 
              }
          }
      });

      const b = document.getElementById("driverWeeklyBody"); b.innerHTML = "";
      driverWeekly.slice(0,50).forEach(w => {
          b.innerHTML += `<tr class="hover:bg-white/5 border-b border-white/5"><td class="py-2 px-4 text-white/70">${niceDate(w.weekEnd)}</td><td class="py-2 px-4 font-bold ${w.pctMargin<0?'text-rose-400':'text-emerald-400'}">${w.pctMargin.toFixed(1)}%</td><td class="py-2 px-4 text-white/70">${fmtUSD(w.revenue)}</td><td class="py-2 px-4 font-medium text-white">${fmtUSD(w.margin)}</td><td class="py-2 px-4 text-white/50">${w.hoursWorked?.toFixed(1)||'-'}</td></tr>`;
      });
  }

  // --- SEARCH LOGIC ---
  function handleSearch(val) {
      const q = val.toLowerCase();
      const div = document.getElementById("searchResults");
      div.innerHTML = "";
      if(q.length < 2) { div.style.display = "none"; return; }
      
      const hits = [];
      const sheets = dataStore[activeDataSourceKey].REGION_SHEETS || [];
      sheets.forEach(r => {
          if(r.id !== "ALL" && r.name.toLowerCase().includes(q)) {
              hits.push({type:'region', name:r.name, id:r.id});
          }
      });
      Object.keys(driverIndex).forEach(d => {
          if(d.toLowerCase().includes(q)) hits.push({type:'driver', name:d});
      });
      
      if(!hits.length) { div.style.display = "none"; return; }
      
      div.style.display = "block";
      hits.slice(0,10).forEach(h => {
          const el = document.createElement("div");
          el.className = "search-item flex items-center justify-between";
          el.innerHTML = `<span>${h.name}</span><span class="text-[9px] uppercase opacity-50 bg-white/10 px-1 rounded">${h.type}</span>`;
          el.onclick = () => {
              if(h.type === 'region') { selectRegion(h.id); }
              else { selectDriver(activeRegionId, h.name); } 
              div.style.display = "none";
              document.getElementById("globalSearch").value = "";
              toggleSidebar(false);
          };
          div.appendChild(el);
      });
  }

  function renderOverview(){
    if(!weekly.length) return;
    const latestDate = asDate(weekly[0].weekEnd);
    const y = latestDate.getUTCFullYear(); const m = latestDate.getUTCMonth(); const q = Math.floor(m/3);
    let startTime, endTime, prevStartTime, prevEndTime, label;
    let isBarChart = false;
    let curr = {}, prev = {};
    let runRateMargin = 0, runRateRevenue = 0;
    let projTitle = "Projected Annual"; let projLabel = "Run Rate"; let totalWeeks = 52;

    if (kpiMode === 'week') {
        const w0 = weekly[0];
        const w1 = weekly[1] || { revenue:0, margin:0, pctMargin:0 };
        curr = { rev: w0.revenue, marg: w0.margin, pct: w0.pctMargin, count: 1 };
        prev = { rev: w1.revenue, marg: w1.margin, pct: w1.pctMargin };
        startTime = asDate(w0.weekStart).getTime(); endTime = asDate(w0.weekEnd).getTime();
        label = "Current Week";
        runRateMargin = curr.marg * 52;
        runRateRevenue = curr.rev * 52;
    } else {
        if (kpiMode.includes('q')) {
            isBarChart = true; 
            const targetQ = kpiMode === 'this_q' ? q : q-1;
            const targetY = kpiMode === 'last_q' && targetQ < 0 ? y-1 : y;
            const finalQ = targetQ < 0 ? 3 : targetQ;
            startTime = Date.UTC(targetY, finalQ * 3, 1); 
            endTime = Date.UTC(targetY, (finalQ * 3) + 3, 0, 23, 59, 59);
            prevStartTime = Date.UTC(targetY, (finalQ-1)*3, 1); 
            prevEndTime = Date.UTC(targetY, ((finalQ-1)*3)+3, 0, 23, 59, 59);
            if(finalQ-1 < 0) { prevStartTime = Date.UTC(targetY-1, 9, 1); prevEndTime = Date.UTC(targetY-1, 12, 0, 23, 59, 59); }
            label = kpiMode === 'this_q' ? "QTD" : "Last Qtr";
            projTitle = kpiMode === 'this_q' ? "Projected Quarter" : "Quarter Total";
            projLabel = kpiMode === 'this_q' ? "Est. Quarter Run Rate" : "Actual";
            totalWeeks = 13;
        } else { 
            isBarChart = true;
            const targetY = kpiMode === 'this_y' ? y : y-1;
            startTime = Date.UTC(targetY, 0, 1); endTime = Date.UTC(targetY, 11, 31, 23, 59, 59);
            prevStartTime = Date.UTC(targetY-1, 0, 1); prevEndTime = Date.UTC(targetY-1, 11, 31, 23, 59, 59);
            label = kpiMode === 'this_y' ? "YTD" : "Last Year";
            projTitle = kpiMode === 'this_y' ? "Projected Annual" : "Annual Total";
            projLabel = kpiMode === 'this_y' ? "Est. Annual Run Rate" : "Actual";
        }
        const getStats = (s, e) => {
            let rev=0, marg=0, count=0;
            weekly.forEach(w => {
                const t = asDate(w.weekEnd).getTime();
                if (t >= s && t <= e + 1000) { rev+=w.revenue; marg+=w.margin; count++; }
            });
            return { rev, marg, pct: rev? (marg/rev)*100 : 0, count };
        };
        curr = getStats(startTime, endTime);
        prev = getStats(prevStartTime, prevEndTime);
        if (kpiMode === 'this_y') { runRateMargin = curr.count > 0 ? (curr.marg / curr.count) * 52 : 0; runRateRevenue = curr.count > 0 ? (curr.rev / curr.count) * 52 : 0; } 
        else if (kpiMode === 'this_q') { runRateMargin = curr.count > 0 ? (curr.marg / curr.count) * 13 : 0; runRateRevenue = curr.count > 0 ? (curr.rev / curr.count) * 13 : 0; } 
        else { runRateMargin = curr.marg; runRateRevenue = curr.rev; }
    }

    currentStats = curr; prevStats = prev;
    lastFilteredStartTime = startTime; lastFilteredEndTime = endTime;
    lastPrevStartTime = prevStartTime; lastPrevEndTime = prevEndTime;
    currentRunRateData = { count: curr.count, totalWeeks, avg: curr.count > 0 ? curr.marg / curr.count : 0, projected: runRateMargin };
    
    // FORMAT DATES FOR UI LABEL
    const dateOpt = { month: 'short', day: 'numeric', year: 'numeric', timeZone: 'UTC' };
    const sStr = new Date(startTime).toLocaleDateString('en-US', dateOpt);
    const eStr = new Date(endTime).toLocaleDateString('en-US', dateOpt);
    document.getElementById("viewDateLabel").textContent = `${sStr} — ${eStr}`;

    document.getElementById("kpiRevenue").textContent = fmtUSD(curr.rev);
    document.getElementById("kpiRevenueLabel").textContent = label + " Revenue";
    document.getElementById("kpiMargin").textContent = fmtUSD(curr.marg);
    const margDiff = curr.marg - prev.marg;
    document.getElementById("kpiMarginLabel").innerHTML = `<span class="${margDiff>=0?'text-emerald-400':'text-rose-400'}">${margDiff>=0?'▲':'▼'} ${fmtUSD(Math.abs(margDiff))}</span> <span class="text-white/30">vs prior</span>`;
    document.getElementById("kpiPctMargin").textContent = curr.pct.toFixed(1) + "%";
    const pctDiff = curr.pct - prev.pct;
    document.getElementById("kpiPctMarginLabel").innerHTML = `<span class="${pctDiff>=0?'text-emerald-400':'text-rose-400'}">${pctDiff>=0?'▲':'▼'} ${Math.abs(pctDiff).toFixed(1)}%</span> <span class="text-white/30">pts vs prior</span>`;
    document.getElementById("kpiProjected").textContent = fmtUSD(runRateMargin);
    document.getElementById("kpiProjectedTitle").textContent = projTitle;
    document.getElementById("kpiProjectedLabel").textContent = projLabel;

    renderTrendChart(isBarChart, startTime, endTime, runRateMargin, runRateRevenue);
    renderAreaBreakdown(startTime, endTime); 
    renderPerformanceList(startTime, endTime + 86400000); 
    renderTable(true);
    updateContextLabel();
  }

  function getDiagonalPattern(color) {
      const canvas = document.createElement('canvas'); canvas.width = 10; canvas.height = 10;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = color; ctx.fillRect(0,0,10,10);
      ctx.strokeStyle = 'rgba(255,255,255,0.2)'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(0, 10); ctx.lineTo(10, 0); ctx.stroke();
      return ctx.createPattern(canvas, 'repeat');
  }

  function renderTrendChart(isBar, startDate, endDate, runRateMargin, runRateRevenue){
    const canvas = document.getElementById("trendChart"); 
    if(trendChart) trendChart.destroy();
    let labels=[], datasets=[];
    if(isBar) {
        const groups = {};
        weekly.forEach(w => {
            const d = asDate(w.weekEnd);
            let sortKey = "", displayLabel = "";
            if(kpiMode.includes('y')) { sortKey = d.getUTCFullYear().toString(); displayLabel = sortKey; } 
            else { const q = Math.floor(d.getUTCMonth()/3)+1; const yy = d.getUTCFullYear().toString().substr(2); sortKey = `${d.getUTCFullYear()}-Q${q}`; displayLabel = `Q${q} '${yy}`; }
            if(!groups[sortKey]) groups[sortKey] = { label: displayLabel, rev:0, marg:0 };
            groups[sortKey].rev += w.revenue; groups[sortKey].marg += w.margin;
        });
        let sortedKeys = Object.keys(groups).sort(); 
        if (kpiMode.includes('q') && sortedKeys.length > 8) sortedKeys = sortedKeys.slice(sortedKeys.length - 8);
        labels = sortedKeys.map(k => groups[k].label);
        const latestWeek = weekly[0]; const latestDate = asDate(latestWeek.weekEnd);
        let currentKey = "";
        if(kpiMode.includes('y')) currentKey = latestDate.getUTCFullYear().toString(); else currentKey = `${latestDate.getUTCFullYear()}-Q${Math.floor(latestDate.getUTCMonth()/3)+1}`;
        const baseData = sortedKeys.map(k => { const grp = groups[k]; return trendMode==='pct' ? (grp.marg/grp.rev)*100 : (trendMode==='rev'?grp.rev:grp.marg); });
        let activeRunRate = 0; if(trendMode === 'net') activeRunRate = runRateMargin; if(trendMode === 'rev') activeRunRate = runRateRevenue;
        const projectedData = sortedKeys.map((k, i) => (k === currentKey && (trendMode === 'net' || trendMode === 'rev')) ? activeRunRate : null);
        const colorActual = "#10b981"; const colorProjected = "#818cf8"; 
        datasets.push({ label: "Actual", data: baseData, backgroundColor: colorActual, borderColor: colorActual, borderWidth: 1 });
        if(trendMode !== 'pct') datasets.push({ label: "Projected Total", data: projectedData, backgroundColor: getDiagonalPattern(colorProjected), borderColor: colorProjected, borderWidth: 1 });
    } else {
        const subset = weekly.slice(0, 16).reverse(); 
        labels = subset.map(w => niceDate(w.weekEnd));
        const data = subset.map(w => trendMode==='pct' ? w.pctMargin : (trendMode==='rev'?w.revenue:w.margin));
        const color = trendMode==='pct'?'#818cf8':(trendMode==='net'?'#10b981':'#3b82f6');
        datasets.push({ label: trendMode, data: data, backgroundColor: 'rgba(129, 140, 248, 0.1)', borderColor: color, borderWidth: 2, tension: 0.3, fill: true });
    }
    const ctx = canvas.getContext("2d");
    trendChart = new Chart(ctx, {
        type: isBar ? 'bar' : 'line', data: { labels, datasets },
        options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { display: false }, datalabels: { color: '#fff', anchor: isBar ? 'end' : 'top', align: isBar ? 'top' : 'top', offset: 4, font: { size: 10, weight: 'bold' }, formatter: (v) => v===null?null:(trendMode==='pct' ? v.toFixed(1)+'%' : fmtUSD(v)) } },
            scales: { x: { grid: { display:false }, ticks: { color:'#64748b', font:{size:10} }, stacked: false }, y: { grid: { color:'rgba(255,255,255,0.05)' }, ticks: { color:'#64748b', font:{size:10} }, stacked: false } },
            layout: { padding: { top: 20 } }
        }
    });
    let latestVal = 0; if(datasets[0] && datasets[0].data.length > 0) latestVal = datasets[0].data[datasets[0].data.length-1];
    document.getElementById("trendBigNumber").textContent = trendMode==='pct' ? latestVal.toFixed(1)+'%' : fmtUSD(latestVal);
  }

  function renderAreaBreakdown(startDate, endDate) {
      const canvas = document.getElementById("areaBreakdownChart"); if(areaBreakdownChart) areaBreakdownChart.destroy();
      const areaMap = {}; Object.keys(driverIndex).forEach(dName => { driverIndex[dName].rows.forEach(r => { const t = r.date.getTime() + 518400000; if(t >= startDate && t <= endDate) { if(!areaMap[r.region]) areaMap[r.region] = 0; areaMap[r.region] += r.margin; } }); });
      const sorted = Object.entries(areaMap).sort((a,b) => b[1] - a[1]);
      areaBreakdownChart = new Chart(canvas, { type: 'bar', indexAxis: 'y', data: { labels: sorted.map(x=>x[0]), datasets: [{ data: sorted.map(x=>x[1]), backgroundColor: sorted.map(x=>x[1]>=0?'#10b981':'#f43f5e'), borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { color: '#fff', anchor: 'end', align: 'end', offset: 0, font: { size: 9 }, formatter: (v) => fmtUSD(v) } }, scales: { x: { display: false }, y: { ticks: { color: '#e2e8f0', font: { size: 10 } }, grid: { display: false } } }, layout: { padding: { right: 40 } } } });
  }

  function switchBreakdownTab(tab) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(tab==='drivers'?'tabDrivers':'tabAreas').classList.add('active');
      document.getElementById('tabContentDrivers').classList.toggle('hidden', tab!=='drivers'); document.getElementById('tabContentAreas').classList.toggle('hidden', tab!=='areas');
  }

  function renderPerformanceList(s, e){
      const topDiv = document.getElementById("topDriversList"); topDiv.innerHTML = ""; const botDiv = document.getElementById("bottomDriversList"); botDiv.innerHTML = "";
      const perf = {}; Object.keys(driverIndex).forEach(d => { driverIndex[d].rows.forEach(r => { const t = r.date.getTime() + 518400000; if(t >= s && t <= e && (activeRegionId==='ALL' || r.regionId===activeRegionId)) { if(!perf[d]) perf[d]=0; perf[d]+=r.margin; } }); });
      const sorted = Object.entries(perf).sort((a,b) => b[1] - a[1]);
      if(!sorted.length) { topDiv.innerHTML = "<div class='text-white/30 text-[10px]'>No data</div>"; return; }
      const row = (n,v,c) => `<div class="flex justify-between items-center text-[10px] bg-white/5 px-2 py-1 rounded border border-white/5"><span class="text-white/90 truncate w-24">${n}</span><span class="font-bold ${c}">${fmtUSD(v)}</span></div>`;
      sorted.slice(0,10).forEach(x => topDiv.innerHTML += row(x[0], x[1], 'text-emerald-400'));
      sorted.slice(-10).reverse().forEach(x => botDiv.innerHTML += row(x[0], x[1], 'text-rose-400'));
  }

  function renderTable(useFilter=false){ 
      const b = document.getElementById("lossTableBody"); b.innerHTML = "";
      let dataToRender = weekly;
      if (useFilter && lastFilteredStartTime > 0) { dataToRender = weekly.filter(w => { const t = asDate(w.weekEnd).getTime(); return t >= lastFilteredStartTime && t <= lastFilteredEndTime + 86400000; }); }
      
      // NEW: Show daily detail for Weekly View? User requested "each day" for weekly view.
      // But consolidated only has weekly. If we are in 'week' mode, we could swap to dailyHistory if we had it.
      // We do have `dailyHistory` in dataStore.
      if (kpiMode === 'week') {
         // Show daily breakdown from Running Sheet aggregation
         const dh = dataStore[activeDataSourceKey].dailyHistory || [];
         // Filter for current week range
         const start = lastFilteredStartTime; const end = lastFilteredEndTime + 86400000;
         const dailyRecs = dh.filter(d => { const t = d.date.getTime(); return t >= start && t < end; });
         
         if(dailyRecs.length > 0) {
             dailyRecs.forEach(d => {
                const c = d.pctMargin<0?'text-rose-400':d.pctMargin<5?'text-amber-400':'text-emerald-400';
                b.innerHTML += `<tr class="hover:bg-white/5 transition"><td class="py-2 px-4 text-white/90 text-[10px] font-bold">${niceDate(d.date)}</td><td class="py-2 px-4 font-bold ${c}">${d.pctMargin.toFixed(1)}%</td><td class="py-2 px-4 text-white/70">${fmtUSD(d.revenue)}</td><td class="py-2 px-4 text-white/70">${fmtUSD(d.totalExp)}</td><td class="py-2 px-4 text-white/70">${fmtUSD(d.margin)}</td><td class="py-2 px-4 text-[9px] ${c}">${d.pctMargin<0?'CRITICAL':'OK'}</td></tr>`;
             });
             return;
         }
      }

      dataToRender.slice(0,50).forEach(w => { const c = w.pctMargin<0?'text-rose-400':w.pctMargin<5?'text-amber-400':'text-emerald-400'; b.innerHTML += `<tr class="hover:bg-white/5 transition"><td class="py-2 px-4 text-white/90 text-[10px]">${niceDate(w.weekStart)} — ${niceDate(w.weekEnd)}</td><td class="py-2 px-4 font-bold ${c}">${w.pctMargin.toFixed(1)}%</td><td class="py-2 px-4 text-white/70">${fmtUSD(w.revenue)}</td><td class="py-2 px-4 text-white/70">${fmtUSD(w.totalExp)}</td><td class="py-2 px-4 text-white/70">${fmtUSD(w.margin)}</td><td class="py-2 px-4 text-[9px] ${c}">${w.pctMargin<0?'CRITICAL':'OK'}</td></tr>`; });
  }
  
  function updateContextLabel(){ 
      const el = document.getElementById("activeContextLabel"); const rName = (dataStore[activeDataSourceKey].REGION_SHEETS || []).find(r=>r.id===activeRegionId)?.name || "Global";
      el.innerHTML = `<span class="text-indigo-400 font-semibold">${rName}</span> <span class="text-white/30 mx-1">/</span> <span class="text-white">${activeView==='drivers'?'Drivers':'Overview'}</span>`; 
  }
  
  window.cycleKpiMode = function() {
      const modes = ['week', 'this_q', 'last_q', 'this_y', 'last_y']; const labels = {'week':'Weekly View', 'this_q':'This Quarter', 'last_q':'Last Quarter', 'this_y':'Year to Date', 'last_y':'Last Year'};
      let idx = modes.indexOf(kpiMode); kpiMode = modes[(idx+1)%modes.length];
      document.getElementById("kpiCycleLabel").textContent = labels[kpiMode]; renderOverview();
  };

  window.setTrendMode = function(m){ trendMode=m; ['pct','net','rev'].forEach(x=>document.getElementById('btnTrend'+x.charAt(0).toUpperCase()+x.slice(1)).classList.toggle('active', x===m)); renderOverview(); };
  window.selectRegion = function(id){ activeRegionId=id; activeDriver=""; applyData(); };
  window.setView = function(v){ activeView=v; document.getElementById("view-overview").classList.toggle("hiddenView", v!=="overview"); document.getElementById("view-drivers").classList.toggle("hiddenView", v!=="drivers"); updateContextLabel(); applyData(); };
  window.exportData = function() { XLSX.writeFile(XLSX.utils.json_to_sheet(weekly), "Dashboard_Export.xlsx"); };

  forceSync();
</script>
</body>
</html>

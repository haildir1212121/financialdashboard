<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NEMT Dashboard ‚Äî Dark UI</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    html, body { height:100%; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* Subtle ‚ÄúBehance-y‚Äù depth without blur/glass */
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 55px rgba(0,0,0,0.45);
    }
    .card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    .chip {
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .thin-scroll::-webkit-scrollbar{ width:10px; height:10px; }
    .thin-scroll::-webkit-scrollbar-track{ background: rgba(255,255,255,0.04); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-thumb{ background: rgba(255,255,255,0.14); border-radius: 999px; }
    .thin-scroll::-webkit-scrollbar-thumb:hover{ background: rgba(255,255,255,0.20); }

    .bggrid{
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(99,102,241,0.20), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(34,211,238,0.12), transparent 55%),
        radial-gradient(900px 550px at 50% 110%, rgba(236,72,153,0.10), transparent 60%),
        linear-gradient(180deg, #070812 0%, #05060d 60%, #04050a 100%);
    }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            ink: { 950:"#04050a", 900:"#070812", 850:"#0b0d16", 800:"#101426" },
            soft: { 100:"rgba(255,255,255,0.08)", 200:"rgba(255,255,255,0.12)" }
          }
        }
      }
    }
  </script>
</head>

<body class="bggrid text-white">
  <div class="mx-auto max-w-[1500px] px-4 py-6">
    <div class="panel rounded-3xl overflow-hidden">
      <div class="grid grid-cols-1 lg:grid-cols-12 min-h-[86vh]">
        <!-- Sidebar -->
        <aside class="lg:col-span-3 border-b lg:border-b-0 lg:border-r border-white/10 bg-black/20">
          <div class="p-5">
            <div class="flex items-center gap-3">
              <div class="h-11 w-11 rounded-2xl bg-white/10 border border-white/10 grid place-items-center">
                <span class="font-extrabold tracking-wide">DLX</span>
              </div>
              <div>
                <div class="text-base font-semibold tracking-tight">Dashboard</div>
                <div class="text-xs text-white/60">NEMT weekly performance</div>
              </div>
            </div>

            <div class="mt-5 space-y-2 text-sm">
              <button class="w-full text-left px-3 py-2 rounded-xl bg-white/8 border border-white/10">
                <div class="flex items-center justify-between">
                  <span class="font-semibold">Overview</span>
                  <span class="text-[11px] text-white/70">Live</span>
                </div>
              </button>

              <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 border border-transparent hover:border-white/10 transition">
                Analytics
              </button>
              <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 border border-transparent hover:border-white/10 transition">
                Regions
              </button>
              <button class="w-full text-left px-3 py-2 rounded-xl hover:bg-white/5 border border-transparent hover:border-white/10 transition">
                Loss Areas
              </button>
            </div>

            <div class="mt-6">
              <div class="text-xs text-white/60 mb-2">Regions</div>

              <div class="card rounded-2xl p-2">
                <input id="regionFilter" class="w-full bg-transparent outline-none px-2 py-2 text-sm placeholder:text-white/35"
                       placeholder="Filter regions‚Ä¶" />
              </div>

              <div id="regionList" class="mt-3 grid grid-cols-1 gap-2"></div>
            </div>

            <div class="mt-6 card rounded-2xl p-4">
              <div class="text-xs text-white/60">Status</div>
              <div id="statusLabel" class="text-xs text-white/80 mt-2">Status: ‚Äî</div>
              <div id="lastSyncLabel" class="text-xs text-white/55 mt-1">Last sync: ‚Äî</div>
              <div id="weekLabel" class="text-xs text-white/55 mt-1">Week: ‚Äî</div>

              <div class="mt-3 flex gap-2">
                <button id="refreshBtn" class="flex-1 rounded-xl px-3 py-2 text-sm bg-white/8 border border-white/10 hover:bg-white/12 transition">
                  Refresh
                </button>
                <button id="exportBtn" class="flex-1 rounded-xl px-3 py-2 text-sm bg-white/8 border border-white/10 hover:bg-white/12 transition">
                  Export
                </button>
              </div>
            </div>
          </div>
        </aside>

        <!-- Main -->
        <section class="lg:col-span-9">
          <!-- Header row -->
          <div class="p-5 border-b border-white/10">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
              <div>
                <div id="dashTitle" class="text-xl font-semibold tracking-tight">DLX/DMT Weekly Dashboard</div>
                <div id="dashSubtitle" class="text-sm text-white/55 mt-1">Overhead ‚Ä¢ Revenue ‚Ä¢ Margin ‚Ä¢ Regional breakdown</div>
              </div>

              <div class="flex items-center gap-2">
                <div class="card rounded-2xl px-3 py-2 flex items-center gap-2 w-[320px] max-w-full">
                  <span class="text-white/50 text-sm">üîé</span>
                  <input id="searchInput" class="bg-transparent outline-none w-full text-sm placeholder:text-white/35"
                         placeholder="Search (week like 11/16/2025)" />
                </div>
                <div id="activeRegionPill" class="chip rounded-2xl px-3 py-2 text-sm font-semibold">ALL</div>
              </div>
            </div>
          </div>

          <!-- Content -->
          <div class="p-5 space-y-4">
            <!-- KPI row -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-white/60">Revenue</div>
                  <div class="chip rounded-xl px-2 py-1 text-[11px]">Week</div>
                </div>
                <div id="kpiRevenue" class="mt-2 text-3xl font-extrabold tracking-tight">‚Äî</div>
                <div class="mt-1 text-xs text-white/55">Gross</div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-white/60">Total Expense</div>
                  <div class="chip rounded-xl px-2 py-1 text-[11px]">TL Exp</div>
                </div>
                <div id="kpiExpense" class="mt-2 text-3xl font-extrabold tracking-tight">‚Äî</div>
                <div id="kpiExpenseSub" class="mt-1 text-xs text-white/55">‚Äî</div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-white/60">Margin</div>
                  <div class="chip rounded-xl px-2 py-1 text-[11px]">Net</div>
                </div>
                <div id="kpiMargin" class="mt-2 text-3xl font-extrabold tracking-tight">‚Äî</div>
                <div id="kpiMarginSub" class="mt-1 text-xs text-white/55">‚Äî</div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-white/60">Drivers</div>
                  <div class="chip rounded-xl px-2 py-1 text-[11px]">Count</div>
                </div>
                <div id="kpiDrivers" class="mt-2 text-3xl font-extrabold tracking-tight">‚Äî</div>
                <div id="kpiDriversSub" class="mt-1 text-xs text-white/55">‚Äî</div>
              </div>
            </div>

            <!-- Charts row -->
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-4">
              <div class="card rounded-3xl p-4 xl:col-span-2">
                <div class="flex items-center justify-between">
                  <div>
                    <div class="text-sm font-semibold">Margin Trend</div>
                    <div class="text-xs text-white/55 mt-1">Most recent weeks (chart shows oldest ‚Üí newest)</div>
                  </div>
                  <button id="toggleBaseline" class="chip rounded-2xl px-3 py-2 text-sm hover:bg-white/10 transition">
                    Toggle baseline
                  </button>
                </div>
                <div class="mt-3 bg-black/25 border border-white/10 rounded-2xl p-3">
                  <canvas id="trendChart" height="110"></canvas>
                </div>
              </div>

              <div class="card rounded-3xl p-4">
                <div class="text-sm font-semibold">Expense Mix</div>
                <div class="text-xs text-white/55 mt-1">Latest week categories</div>
                <div class="mt-3 bg-black/25 border border-white/10 rounded-2xl p-3">
                  <canvas id="mixChart" height="220"></canvas>
                </div>
                <div id="mixLegend" class="mt-3 grid grid-cols-2 gap-2 text-xs text-white/70"></div>
              </div>
            </div>

            <!-- Table row -->
            <div class="card rounded-3xl p-4">
              <div class="flex items-center justify-between">
                <div>
                  <div class="text-sm font-semibold">Loss Radar</div>
                  <div class="text-xs text-white/55 mt-1">Worst weeks first (valid weekly rows only)</div>
                </div>
                <button id="resetBtn" class="chip rounded-2xl px-3 py-2 text-sm hover:bg-white/10 transition">
                  Reset
                </button>
              </div>

              <div class="mt-3 overflow-auto thin-scroll">
                <table class="min-w-full text-sm">
                  <thead class="text-white/60">
                    <tr class="border-b border-white/10">
                      <th class="py-2 text-left font-medium">Week</th>
                      <th class="py-2 text-left font-medium">% Margin</th>
                      <th class="py-2 text-left font-medium">Revenue</th>
                      <th class="py-2 text-left font-medium">TL Exp</th>
                      <th class="py-2 text-left font-medium">Margin</th>
                      <th class="py-2 text-left font-medium">Signal</th>
                    </tr>
                  </thead>
                  <tbody id="lossTableBody" class="divide-y divide-white/10"></tbody>
                </table>
              </div>
            </div>

          </div>
        </section>
      </div>
    </div>
  </div>

  <script>
    // ============================
    // CONFIG
    // ============================
    const WORKER_URL = "https://withered-king-c48e.haildir12121.workers.dev/";
    const POLL_MS = 120000;

    const REGION_SHEETS = [
      { id: "ALL", name: "All Areas (Sum)", sheet: null }, // computed
      { id: "CST", name: "Coast", sheet: "CST.Wkly" },
      { id: "EUG", name: "Eugene", sheet: "EUG.Wkly" },
      { id: "RBG", name: "Roseburg", sheet: "RBG.Wkly" },
      { id: "OKRDG", name: "Oakridge", sheet: "OKRDG.Wkly" },
      { id: "MDVCR", name: "Mid-Valley/Corvallis", sheet: "MDVCR.Wkly" },
      { id: "ALBNY", name: "Albany", sheet: "ALBNY.Wkly" },
      { id: "DMT", name: "DMT", sheet: "DMT.Wkly" }
    ];

    // Weekly summary table columns (P..AB)
    const COLMAP = {
      weekStart: "P",
      weekEnd: "Q",
      driverCount: "R",
      hoursWorked: "S",
      payroll: "T",
      fuel: "U",
      insurance: "V",
      maintenance: "W",
      billbacks: "X",
      totalExp: "Y",
      revenue: "Z",
      margin: "AA",
      pctMargin: "AB",
    };

    const CONSOLIDATED_SHEET = "ConsolidatedWkly";
    const TITLE_CELL = "P1";
    const SUBTITLE_CELL = "P2";

    // ============================
    // STATE
    // ============================
    let regionSeries = {};
    let activeRegionId = "ALL";
    let weekly = [];
    let latestWeek = null;

    let trendChart = null;
    let mixChart = null;
    let showBaseline = true;
    let _timer = null;

    // ============================
    // HELPERS
    // ============================
    function fmtUSD(n){ return Number(n||0).toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}); }
    function safeNum(v){
      if (typeof v === "number") return isFinite(v) ? v : 0;
      if (v == null) return 0;
      const s = String(v).replace(/[^0-9.\-]/g,"");
      const n = parseFloat(s);
      return isFinite(n) ? n : 0;
    }
    function asDate(v){
      if (v instanceof Date && !isNaN(v)) return v;
      if (typeof v === "number" && isFinite(v)) {
        // Excel serial -> Date
        const utcDays = Math.floor(v - 25569);
        return new Date(utcDays * 86400 * 1000);
      }
      const d = new Date(v);
      return isNaN(d) ? null : d;
    }
    function niceDate(v){
      const d = asDate(v);
      if (!d) return String(v||"");
      return `${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;
    }
    function colToIndex(col){
      let n = 0;
      const s = String(col).toUpperCase().trim();
      for (let i=0;i<s.length;i++) n = n * 26 + (s.charCodeAt(i) - 64);
      return n - 1;
    }
    function weekTimestamp(w){
      const d = asDate(w.weekEnd) || asDate(w.weekStart);
      return d ? d.getTime() : -Infinity;
    }
    function sortWeeksDesc(arr){
      return arr.slice().sort((a,b)=> weekTimestamp(b) - weekTimestamp(a));
    }
    function weekKey(weekStart, weekEnd){
      return `${niceDate(weekStart)}|${niceDate(weekEnd)}`;
    }
    function setStatus(text){
      document.getElementById("statusLabel").textContent = `Status: ${text}`;
    }

    // ============================
    // FETCH + XLSX
    // ============================
    function base64ToUint8Array(b64){
      const bin = atob(b64);
      const len = bin.length;
      const bytes = new Uint8Array(len);
      for (let i=0;i<len;i++) bytes[i] = bin.charCodeAt(i);
      return bytes;
    }

    async function fetchWorkbook(){
      const res = await fetch(WORKER_URL, { cache: "no-store" });
      const data = await res.json();
      if (!res.ok || data?.error) throw new Error(data?.detail || data?.error || `Fetch failed (${res.status})`);
      if (data.kind !== "binary" || data.encoding !== "base64" || !data.base64) {
        throw new Error("Worker response isn't XLSX base64 (expected {kind:'binary',encoding:'base64',base64:'...'}).");
      }
      const bytes = base64ToUint8Array(data.base64);
      const wb = XLSX.read(bytes, { type: "array" });
      return { wb, meta: data };
    }

    function readCell(ws, addr){
      return ws?.[addr]?.v ?? "";
    }

    // ============================
    // PARSE REGION WEEKLY TABLE (P..AB)
    // ============================
    function parseRegionSheet(ws){
      const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, defval: "" });

      const idx = {};
      for (const [k, col] of Object.entries(COLMAP)) idx[k] = colToIndex(col);

      const P = idx.weekStart;
      const Q = idx.weekEnd;

      const hasWord = (v, word) => String(v||"").toLowerCase().includes(word);

      // Find header row
      let headerRow = -1;
      for (let r=0; r<Math.min(140, aoa.length); r++){
        const row = aoa[r] || [];
        const z = row[idx.revenue];
        const aa = row[idx.margin];
        const ab = row[idx.pctMargin];
        const p = row[P];
        const q = row[Q];

        const looksLikeHeader =
          (hasWord(p,"week") && hasWord(q,"week")) ||
          (hasWord(z,"revenue") && hasWord(aa,"margin")) ||
          (hasWord(ab,"margin") && (String(ab).includes("%") || hasWord(ab,"%")));

        if (looksLikeHeader) { headerRow = r; break; }
      }
      if (headerRow === -1) headerRow = 2;

      const dataStart = headerRow + 1;

      const out = [];
      for (let r = dataStart; r < aoa.length; r++){
        const row = aoa[r] || [];
        const wsVal = row[P];
        const weVal = row[Q];

        if (String(wsVal).trim()==="" && String(weVal).trim()==="") break;

        const revenue = safeNum(row[idx.revenue]);
        const totalExp = safeNum(row[idx.totalExp]);
        const margin = safeNum(row[idx.margin]);

        const hasMoney = Math.abs(revenue) > 0.0001 || Math.abs(totalExp) > 0.0001 || Math.abs(margin) > 0.0001;
        if (!hasMoney) continue;

        let pmRaw = row[idx.pctMargin];
        let pm = 0;
        if (typeof pmRaw === "number") pm = pmRaw <= 1.5 ? pmRaw * 100 : pmRaw;
        else {
          const n = safeNum(pmRaw);
          pm = n <= 1.5 ? n * 100 : n;
        }
        if (!isFinite(pm)) pm = 0;

        out.push({
          weekStart: wsVal,
          weekEnd: weVal,
          revenue,
          totalExp,
          margin,
          pctMargin: pm,
          driverCount: Math.round(safeNum(row[idx.driverCount])),
          hoursWorked: safeNum(row[idx.hoursWorked]),
          payroll: safeNum(row[idx.payroll]),
          fuel: safeNum(row[idx.fuel]),
          insurance: safeNum(row[idx.insurance]),
          maintenance: safeNum(row[idx.maintenance]),
          billbacks: safeNum(row[idx.billbacks]),
        });
      }
      return sortWeeksDesc(out);
    }

    function sumRegionsByWeek(seriesById){
      const map = new Map();
      for (const [id, series] of Object.entries(seriesById)){
        if (id === "ALL") continue;
        for (const w of series){
          const key = weekKey(w.weekStart, w.weekEnd);
          const cur = map.get(key) || {
            weekStart: w.weekStart,
            weekEnd: w.weekEnd,
            revenue: 0, totalExp: 0, margin: 0, pctMargin: 0,
            payroll:0, fuel:0, insurance:0, maintenance:0, billbacks:0,
            driverCount:0, hoursWorked:0
          };
          cur.revenue += w.revenue || 0;
          cur.totalExp += w.totalExp || 0;
          cur.margin += w.margin || 0;

          cur.payroll += w.payroll || 0;
          cur.fuel += w.fuel || 0;
          cur.insurance += w.insurance || 0;
          cur.maintenance += w.maintenance || 0;
          cur.billbacks += w.billbacks || 0;

          cur.driverCount += w.driverCount || 0;
          cur.hoursWorked += w.hoursWorked || 0;

          map.set(key, cur);
        }
      }
      const all = Array.from(map.values());
      for (const w of all){
        w.pctMargin = ((w.revenue - w.totalExp) / Math.max(1, w.revenue)) * 100;
        if (!isFinite(w.pctMargin)) w.pctMargin = 0;
      }
      return sortWeeksDesc(all);
    }

    // ============================
    // UI RENDER
    // ============================
    function pmBadge(pm){
      if (!isFinite(pm)) return { label:"‚Äî", cls:"text-white/70" };
      if (pm < 0) return { label:"LOSS", cls:"text-rose-200" };
      if (pm < 5) return { label:"RISK", cls:"text-amber-100" };
      return { label:"OK", cls:"text-emerald-200" };
    }

    function renderRegionSidebar(){
      const list = document.getElementById("regionList");
      const filter = String(document.getElementById("regionFilter").value || "").trim().toLowerCase();
      list.innerHTML = "";

      REGION_SHEETS
        .filter(r => !filter || r.name.toLowerCase().includes(filter) || r.id.toLowerCase().includes(filter))
        .forEach(r=>{
          const series = regionSeries[r.id] || [];
          const w = series[0];
          const pm = w ? w.pctMargin : NaN;
          const b = pmBadge(pm);

          const btn = document.createElement("button");
          btn.className =
            "card rounded-2xl px-3 py-3 text-left hover:bg-white/7 transition " +
            (r.id === activeRegionId ? "ring-1 ring-white/25" : "");

          btn.innerHTML = `
            <div class="flex items-center justify-between gap-3">
              <div class="min-w-0">
                <div class="text-sm font-semibold truncate">${r.name}</div>
                <div class="text-xs text-white/55 truncate">${r.sheet ? r.sheet : "computed sum"}</div>
              </div>
              <div class="text-right shrink-0">
                <div class="text-sm font-bold">${w ? w.pctMargin.toFixed(2)+"%" : "‚Äî"}</div>
                <div class="text-[11px] ${b.cls}">${b.label}</div>
              </div>
            </div>
          `;

          btn.addEventListener("click", ()=>{
            activeRegionId = r.id;
            document.getElementById("activeRegionPill").textContent = r.id;

            weekly = sortWeeksDesc(regionSeries[activeRegionId] || []);
            latestWeek = weekly[0] || null;

            renderRegionSidebar();
            renderAll();
          });

          list.appendChild(btn);
        });
    }

    function renderKpis(){
      const w = latestWeek;
      const rev = w.revenue || 0;
      const exp = w.totalExp || 0;
      const pm = isFinite(w.pctMargin) ? w.pctMargin : ((rev-exp)/Math.max(1,rev))*100;

      document.getElementById("kpiRevenue").textContent = fmtUSD(rev);
      document.getElementById("kpiExpense").textContent = fmtUSD(exp);
      document.getElementById("kpiExpenseSub").textContent = `TL Exp ‚Ä¢ ${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}`;
      document.getElementById("kpiMargin").textContent = `${pm.toFixed(2)}%`;
      document.getElementById("kpiMarginSub").textContent = `${fmtUSD(w.margin || 0)} margin`;

      document.getElementById("kpiDrivers").textContent = `${w.driverCount || 0}`;
      document.getElementById("kpiDriversSub").textContent = `Hours: ${Math.round(w.hoursWorked || 0)} ‚Ä¢ Cost/Driver: ${fmtUSD((exp/Math.max(1,w.driverCount||0))||0)}`;

      document.getElementById("weekLabel").textContent = `Week: ${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}`;
    }

    function renderTrendChart(){
      const seriesDesc = weekly.filter(w => isFinite(w.pctMargin) && Math.abs(w.revenue) > 0.0001);
      const take = seriesDesc.slice(0, 16).reverse(); // oldest->newest for chart
      const labels = take.map(w => niceDate(w.weekEnd));
      const data = take.map(w => w.pctMargin);
      const baseline = data.length ? data.reduce((a,b)=>a+b,0)/data.length : 0;

      const ctx = document.getElementById("trendChart").getContext("2d");
      if (trendChart) trendChart.destroy();

      const datasets = [{
        label: "% Margin",
        data,
        borderColor: "rgba(255,255,255,0.85)",
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.35,
        fill: true,
        backgroundColor: "rgba(99,102,241,0.12)"
      }];

      if (showBaseline){
        datasets.push({
          label: "Baseline",
          data: Array(data.length).fill(baseline),
          borderColor: "rgba(255,255,255,0.25)",
          borderWidth: 1,
          pointRadius: 0,
          tension: 0.2
        });
      }

      trendChart = new Chart(ctx, {
        type: "line",
        data: { labels, datasets },
        options: {
          plugins: { legend: { display:false } },
          scales: {
            x: { grid:{ display:false }, ticks:{ color:"rgba(255,255,255,0.55)" } },
            y: { grid:{ color:"rgba(255,255,255,0.06)" }, ticks:{ color:"rgba(255,255,255,0.55)", callback:(v)=>`${v}%` } }
          }
        }
      });
    }

    function renderMixChart(){
      const w = latestWeek;
      const labels = ["Payroll","Fuel","Insurance","Maintenance","Billbacks","Other"];
      const vals = [
        w.payroll||0,
        w.fuel||0,
        w.insurance||0,
        w.maintenance||0,
        w.billbacks||0
      ];
      const known = vals.reduce((a,b)=>a+b,0);
      const other = Math.max(0, (w.totalExp||0) - known);
      vals.push(other);

      const ctx = document.getElementById("mixChart").getContext("2d");
      if (mixChart) mixChart.destroy();

      mixChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels,
          datasets: [{
            data: vals,
            backgroundColor: [
              "rgba(99,102,241,0.75)",
              "rgba(34,211,238,0.70)",
              "rgba(245,158,11,0.70)",
              "rgba(236,72,153,0.65)",
              "rgba(16,185,129,0.65)",
              "rgba(255,255,255,0.18)"
            ],
            borderColor: "rgba(255,255,255,0.10)",
            borderWidth: 1
          }]
        },
        options: {
          plugins: { legend: { display:false } },
          cutout: "62%"
        }
      });

      const legend = document.getElementById("mixLegend");
      legend.innerHTML = "";
      const total = Math.max(1, (w.totalExp||0));
      labels.forEach((lab, i)=>{
        const pct = (vals[i]/total)*100;
        const div = document.createElement("div");
        div.className = "chip rounded-xl px-2 py-2";
        div.innerHTML = `
          <div class="text-[11px] text-white/60">${lab}</div>
          <div class="text-sm font-semibold">${pct.toFixed(1)}%</div>
        `;
        legend.appendChild(div);
      });
    }

    function buildSignal(w){
      const pm = w.pctMargin || 0;
      if (pm < 0) return "Loss week. Check payroll, maintenance, and fuel burdens.";
      if (pm < 5) return "Low margin. Investigate expense spikes and underpriced weeks.";
      return "Healthy week.";
    }

    function renderLossTable(){
      const tbody = document.getElementById("lossTableBody");
      tbody.innerHTML = "";

      const series = weekly.filter(w => isFinite(w.pctMargin) && Math.abs(w.revenue) > 0.0001);
      const rows = series.slice().sort((a,b)=> a.pctMargin - b.pctMargin).slice(0, 20);

      rows.forEach(w=>{
        const b = pmBadge(w.pctMargin);
        const tr = document.createElement("tr");
        tr.className = "hover:bg-white/5 transition";
        tr.innerHTML = `
          <td class="py-3 pr-3">
            <div class="font-semibold">${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}</div>
            <div class="text-xs text-white/55">Drivers: ${w.driverCount || 0}</div>
          </td>
          <td class="py-3 pr-3 font-semibold ${b.cls}">${(w.pctMargin||0).toFixed(2)}%</td>
          <td class="py-3 pr-3 text-white/85">${fmtUSD(w.revenue)}</td>
          <td class="py-3 pr-3 text-white/85">${fmtUSD(w.totalExp)}</td>
          <td class="py-3 pr-3 text-white/85">${fmtUSD(w.margin)}</td>
          <td class="py-3 pr-3 text-white/70"><div class="max-w-[520px] truncate">${buildSignal(w)}</div></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderAll(){
      if (!latestWeek){
        setStatus("No data");
        return;
      }
      renderKpis();
      renderTrendChart();
      renderMixChart();
      renderLossTable();
      setStatus(`OK (${activeRegionId})`);
    }

    // ============================
    // EVENTS
    // ============================
    document.getElementById("toggleBaseline").addEventListener("click", ()=>{
      showBaseline = !showBaseline;
      renderTrendChart();
    });

    document.getElementById("exportBtn").addEventListener("click", ()=>{
      const payload = { generatedAt: new Date().toISOString(), activeRegionId, latestWeek, weekly };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `weekly_snapshot_${activeRegionId}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      document.getElementById("searchInput").value = "";
      renderLossTable();
    });

    document.getElementById("searchInput").addEventListener("input", (e)=>{
      const q = String(e.target.value||"").trim();
      if (!q) return renderLossTable();

      const tbody = document.getElementById("lossTableBody");
      tbody.innerHTML = "";

      const filtered = weekly
        .filter(w => `${niceDate(w.weekStart)}‚Üí${niceDate(w.weekEnd)}`.includes(q))
        .sort((a,b)=> (a.pctMargin||0) - (b.pctMargin||0))
        .slice(0, 50);

      filtered.forEach(w=>{
        const tr = document.createElement("tr");
        tr.className = "hover:bg-white/5 transition";
        tr.innerHTML = `
          <td class="py-3 pr-3"><div class="font-semibold">${niceDate(w.weekStart)} ‚Üí ${niceDate(w.weekEnd)}</div></td>
          <td class="py-3 pr-3 font-semibold">${(w.pctMargin||0).toFixed(2)}%</td>
          <td class="py-3 pr-3">${fmtUSD(w.revenue)}</td>
          <td class="py-3 pr-3">${fmtUSD(w.totalExp)}</td>
          <td class="py-3 pr-3">${fmtUSD(w.margin)}</td>
          <td class="py-3 pr-3 text-white/70"><div class="max-w-[520px] truncate">${buildSignal(w)}</div></td>
        `;
        tbody.appendChild(tr);
      });
    });

    document.getElementById("regionFilter").addEventListener("input", ()=>{
      renderRegionSidebar();
    });

    document.getElementById("refreshBtn").addEventListener("click", ()=>{
      refresh();
    });

    // ============================
    // LIVE LOOP
    // ============================
    async function refresh(){
      try {
        setStatus("Syncing‚Ä¶");
        const { wb, meta } = await fetchWorkbook();

        // optional title/subtitle
        const cws = wb.Sheets[CONSOLIDATED_SHEET];
        if (cws){
          const title = readCell(cws, TITLE_CELL);
          const subtitle = readCell(cws, SUBTITLE_CELL);
          if (title) document.getElementById("dashTitle").textContent = String(title);
          if (subtitle) document.getElementById("dashSubtitle").textContent = String(subtitle);
        }

        // parse region sheets
        regionSeries = {};
        for (const r of REGION_SHEETS){
          if (r.id === "ALL") continue;
          const ws = wb.Sheets[r.sheet];
          regionSeries[r.id] = ws ? parseRegionSheet(ws) : [];
        }

        // compute ALL
        regionSeries["ALL"] = sumRegionsByWeek(regionSeries);

        // keep selection
        weekly = sortWeeksDesc(regionSeries[activeRegionId] || regionSeries["ALL"] || []);
        latestWeek = weekly[0] || null;

        if (!latestWeek) throw new Error("No valid weekly rows found across region sheets.");

        const fetchedAt = meta?.fetchedAt ? new Date(meta.fetchedAt) : new Date();
        document.getElementById("lastSyncLabel").textContent = `Last sync: ${fetchedAt.toLocaleString()} ‚Ä¢ ${meta.fileName || ""}`;

        document.getElementById("activeRegionPill").textContent = activeRegionId;

        renderRegionSidebar();
        renderAll();
      } catch (err) {
        console.error(err);
        setStatus(`Sync failed: ${String(err?.message || err)}`);
      }
    }

    function start(){
      refresh();
      if (_timer) clearInterval(_timer);
      _timer = setInterval(refresh, POLL_MS);
    }

    start();
  </script>
</body>
</html>
